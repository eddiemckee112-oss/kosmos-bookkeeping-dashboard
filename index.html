<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kosmos Bookkeeping</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
      :root { --bg:#fafafa; --card:#fff; --border:#e5e7eb; --muted:#6b7280; --ok:#0a7a33; --err:#b00020; }
      * { box-sizing: border-box; }
      body { font-family: system-ui, Arial, sans-serif; margin: 2rem; background: var(--bg); color:#111; }
      h1 { font-size: 1.6rem; margin: 0 0 .75rem 0; }
      h3 { margin: 0 0 .25rem 0; }
      .wrap { display: grid; grid-template-columns: 520px 1fr; gap: 24px; align-items: start; }
      .card { background: var(--card); border:1px solid var(--border); border-radius: 12px; padding: 16px; }
      label { display:block; margin-top:.65rem; font-weight:600; }
      input { width:100%; padding:.6rem .7rem; border:1px solid #cfcfcf; border-radius:8px; margin-top:.35rem; }
      input[readonly] { background:#f6f6f6; }
      button { margin-top:.6rem; padding:.6rem 1rem; border-radius:8px; border:1px solid #bbb; background:#111; color:#fff; cursor:pointer; }
      button:hover { background:#333; }
      small.muted { color:var(--muted); display:block; margin-top:.25rem; }
      .ok { color:var(--ok); }
      .err { color:var(--err); }
      .row { margin-top:.35rem; }
      table { width:100%; border-collapse: collapse; }
      th, td { padding: 8px 10px; border-bottom:1px solid var(--border); text-align: left; font-size: 14px; }
      th { background:#f6f7f8; position: sticky; top:0; z-index:1; }
      .chip { font-size:12px; background:#eef2ff; border:1px solid #c7d2fe; padding:2px 6px; border-radius:999px; }
      .right { text-align:right; }
      .rowbtns { display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
      .secondary { background:#f7f7f7; color:#111; border-color:#ccc; }
      @media (max-width:1100px){ .wrap{ grid-template-columns:1fr; } }
    </style>
  </head>
  <body>
    <h1>Kosmos Bookkeeping</h1>

    <div class="wrap">
      <!-- LEFT: status + uploader + automation -->
      <div>
        <div class="card">
          <p id="status">Connecting…</p>
          <p><strong>Receipts in database:</strong> <span id="receiptCount">—</span></p>
        </div>

        <div class="card" style="margin-top:16px;">
          <h3>Upload a receipt (manual-only)</h3>
          <small class="muted">Uploads image → saves to <code>receipts-warm</code> → inserts row in <code>public.receipts</code>.</small>

          <div class="row">
            <input type="file" id="fileInput" accept="image/*,.pdf" />
          </div>

          <label>Vendor
            <input id="vendor" list="vendorList" placeholder="Start typing… e.g., No Frills, Sysco, Costco" />
            <datalist id="vendorList"></datalist>
            <small class="muted">Suggestions come from your existing receipts.</small>
          </label>

          <label>Date
            <input id="rdate" type="date" />
          </label>

          <label>Total
            <input id="total" type="number" step="0.01" />
          </label>

          <label>Tax
            <input id="tax" type="number" step="0.01" />
          </label>

          <label>Subtotal (auto)
            <input id="subtotal" type="number" step="0.01" readonly />
          </label>

          <label>Category
            <input id="category" list="categoryList" placeholder="Pick or type a category…" />
            <datalist id="categoryList"></datalist>
            <small class="muted">Master list; you can still type a new one.</small>
          </label>

          <label>Source
            <input id="source" list="sourceList" placeholder="e.g., CIBC Chequing, TD Visa, Cash…" />
            <datalist id="sourceList"></datalist>
            <small class="muted">Suggestions come from your existing receipts.</small>
          </label>

          <label>Notes
            <input id="notes" placeholder="optional" />
          </label>

          <button id="uploadBtn">Upload & Save</button>
          <p id="msg" class="muted"></p>
        </div>

        <!-- NEW: Automation controls -->
        <div class="card" style="margin-top:16px;">
          <h3>Automation</h3>
          <small class="muted">Run your Supabase tasks from here.</small>
          <div class="rowbtns">
            <button id="btnApply" class="secondary" title="Auto-categorize receipts">Apply Rules</button>
            <button id="btnMatch" class="secondary" title="Match receipts ↔ bank txns">Match Now</button>
            <button id="btnExport" title="Download accountant CSV">Export Accountant CSV</button>
          </div>
          <p id="autoMsg" class="muted"></p>
        </div>
      </div>

      <!-- RIGHT: Unmatched viewer -->
      <div class="card">
        <h3>Unmatched receipts</h3>
        <small class="muted">Newest first • From view <code>v_unmatched_receipts</code> • Last 25</small>
        <div style="max-height: 540px; overflow:auto; margin-top:8px;">
          <table id="unmatchedTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Vendor</th>
                <th class="right">Total</th>
                <th class="right">Tax</th>
                <th>Category</th>
                <th>Source</th>
                <th>Image</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div style="margin-top:8px;">
          <button id="refreshBtn" class="secondary" title="Reload list">Refresh</button>
        </div>
      </div>
    </div>

    <script>
      // ---- Supabase setup
      const SUPABASE_URL = "https://advihqhjjlxumgdlbwui.supabase.co";
      const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkdmlocWhqamx4dW1nZGxid3VpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMTg0MzIsImV4cCI6MjA3NjU5NDQzMn0.kVlaPQg2_o9DGJYv22Dgca7veok4drF6kgLPy2wPBeY";
      const BUCKET = "receipts-warm";
      const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      // ---- Category master list (edit any time)
      const PRESET_CATEGORIES = [
        "Food","Alcohol","Restaurant Supplies","Building Supplies","Tools & Equipment",
        "Cleaning Supplies","General Supplies","Gas","Delivery Fees","Utilities",
        "Repairs & Maintenance","Income","Office Supplies","Software","Bank Fees"
      ];

      // ---- Helpers
      const qs = (id) => document.getElementById(id);
      const statusEl = qs("status");
      const msgEl = qs("msg");
      const autoMsg = qs("autoMsg");
      const countEl = qs("receiptCount");

      function uniqueCaseInsensitive(values) {
        const seen = new Map();
        for (const v of values) {
          if (!v) continue;
          const k = String(v).trim(); if (!k) continue;
          const lk = k.toLowerCase();
          if (!seen.has(lk)) seen.set(lk, k);
        }
        return Array.from(seen.values()).sort((a,b)=>a.localeCompare(b));
      }
      function fillDatalist(id, arr) {
        const el = qs(id);
        el.innerHTML = arr.map(v => `<option value="${String(v).replaceAll('"','&quot;')}"></option>`).join("");
      }
      async function refreshCount() {
        const { count, error } = await sb.from("receipts").select("*", { count: "exact", head: true });
        if (!error) countEl.textContent = count ?? 0;
      }
      function updateSubtotalPreview() {
        const t = parseFloat(qs("total").value) || 0;
        const x = parseFloat(qs("tax").value) || 0;
        qs("subtotal").value = (t - x).toFixed(2);
      }
      qs("total").addEventListener("input", updateSubtotalPreview);
      qs("tax").addEventListener("input", updateSubtotalPreview);

      // ---- Lists (vendors/sources from DB; categories preset + DB)
      async function loadDynamicLists() {
        const { data: vs, error: vsErr } = await sb.from("receipts")
          .select("vendor, source, category")
          .limit(5000);
        let vendors = [], sources = [], dbCats = [];
        if (!vsErr && Array.isArray(vs)) {
          vendors = uniqueCaseInsensitive(vs.map(r => r.vendor));
          sources = uniqueCaseInsensitive(vs.map(r => r.source));
          dbCats  = uniqueCaseInsensitive(vs.map(r => r.category));
        }
        fillDatalist("vendorList", vendors);
        fillDatalist("sourceList", sources);
        fillDatalist("categoryList", uniqueCaseInsensitive([...PRESET_CATEGORIES, ...dbCats]));
      }

      // ---- Unmatched viewer
      async function loadUnmatched() {
        const tbody = qs("unmatchedTable").querySelector("tbody");
        tbody.innerHTML = `<tr><td colspan="7">Loading…</td></tr>`;
        const { data, error } = await sb
          .from("v_unmatched_receipts")
          .select("id, receipt_date, vendor, total, tax, category, source, image_url, created_at")
          .order("created_at", { ascending: false })
          .limit(25);

        if (error) {
          tbody.innerHTML = `<tr><td colspan="7" class="err">Error loading unmatched: ${error.message}</td></tr>`;
          return;
        }
        if (!data || data.length === 0) {
          tbody.innerHTML = `<tr><td colspan="7" class="muted">All caught up—no unmatched receipts.</td></tr>`;
          return;
        }
        const rows = data.map(r => {
          const total = (typeof r.total === "number") ? r.total.toFixed(2) : (r.total ?? "");
          const tax   = (typeof r.tax   === "number") ? r.tax.toFixed(2)   : (r.tax ?? "");
          const img = r.image_url ? `<a href="${r.image_url}" target="_blank" class="chip">open</a>` : "";
          return `
            <tr>
              <td>${r.receipt_date ?? ""}</td>
              <td>${r.vendor ?? ""}</td>
              <td class="right">$${total}</td>
              <td class="right">$${tax}</td>
              <td>${r.category ?? ""}</td>
              <td>${r.source ?? ""}</td>
              <td>${img}</td>
            </tr>`;
        }).join("");
        tbody.innerHTML = rows;
      }

      // ---- Init
      async function init() {
        await refreshCount();
        await loadDynamicLists();
        await loadUnmatched();
        statusEl.textContent = "Connected.";
      }

      // ---- Upload handler
      qs("uploadBtn").addEventListener("click", async () => {
        msgEl.className = "muted";
        msgEl.textContent = "Uploading…";

        const file = qs("fileInput").files?.[0];
        if (!file) { msgEl.className = "err"; msgEl.textContent = "Pick a file first."; return; }

        // 1) Upload file
        const objectPath = `${Date.now()}-${file.name}`;
        const { error: upErr } = await sb.storage.from(BUCKET).upload(objectPath, file, {
          contentType: file.type || "application/octet-stream",
          upsert: false
        });
        if (upErr) { msgEl.className = "err"; msgEl.textContent = "Storage error: " + upErr.message; return; }
        const { data: pub } = sb.storage.from(BUCKET).getPublicUrl(objectPath);
        const publicUrl = pub?.publicUrl;

        // 2) Collect fields
        const vendor = qs("vendor").value || null;
        const rdate = qs("rdate").value || null;
        const total = qs("total").value ? Number(qs("total").value) : null;
        const tax   = qs("tax").value   ? Number(qs("tax").value)   : 0.00;
        const category = qs("category").value || null;
        const source   = qs("source").value || null;
        const notes    = qs("notes").value || null;

        // 3) Insert (DB computes subtotal)
        const { error: insErr } = await sb.from("receipts").insert([{
          image_url: publicUrl, vendor, receipt_date: rdate, total, tax,
          category, source, notes, entered_by: null
        }]);
        if (insErr) { msgEl.className = "err"; msgEl.textContent = "DB error: " + insErr.message; return; }

        msgEl.className = "ok";
        msgEl.textContent = "Uploaded & saved successfully.";
        qs("fileInput").value = "";
        await refreshCount();
        await loadDynamicLists();
        await loadUnmatched();
      });

      // ---- NEW: Automation buttons
      qs("btnApply").addEventListener("click", async () => {
        autoMsg.className = "muted"; autoMsg.textContent = "Applying rules…";
        const { error } = await sb.rpc("apply_rules");   // your existing function
        if (error) { autoMsg.className = "err"; autoMsg.textContent = "Error: " + error.message; return; }
        autoMsg.className = "ok"; autoMsg.textContent = "Rules applied.";
        await loadUnmatched();
      });

      qs("btnMatch").addEventListener("click", async () => {
        autoMsg.className = "muted"; autoMsg.textContent = "Matching now…";
        const { error } = await sb.rpc("match_now");     // your existing function
        if (error) { autoMsg.className = "err"; autoMsg.textContent = "Error: " + error.message; return; }
        autoMsg.className = "ok"; autoMsg.textContent = "Matching complete.";
        await loadUnmatched();
      });

      // CSV export from view v_accountant_export_receipts
      async function exportCSV() {
        autoMsg.className = "muted"; autoMsg.textContent = "Building CSV…";
        const { data, error } = await sb
          .from("v_accountant_export_receipts")
          .select("*")
          .order("receipt_date", { ascending: true });

        if (error) { autoMsg.className = "err"; autoMsg.textContent = "Error: " + error.message; return; }
        if (!data || !data.length) { autoMsg.className = "muted"; autoMsg.textContent = "No rows to export."; return; }

        const cols = Object.keys(data[0]);
        const escape = (v) => {
          if (v === null || v === undefined) return "";
          const s = String(v);
          return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
        };
        const csv = [cols.join(",")]
          .concat(data.map(row => cols.map(c => escape(row[c])).join(",")))
          .join("\n");

        const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        const today = new Date().toISOString().slice(0,10);
        a.href = url; a.download = `accountant_export_${today}.csv`;
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
        autoMsg.className = "ok"; autoMsg.textContent = "CSV downloaded.";
      }
      qs("btnExport").addEventListener("click", exportCSV);

      qs("refreshBtn").addEventListener("click", loadUnmatched);

      init();
    </script>
  </body>
</html>
