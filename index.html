<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Kosmos Bookkeeping</title>
    <style>
      body { font-family: system-ui, Arial, sans-serif; margin: 32px; }
      .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; max-width: 560px; }
      .muted { color: #555; }
      .row { margin-top: 12px; }
      button { padding: 8px 14px; border-radius: 8px; border: 1px solid #ccc; cursor: pointer; }
      input[type="file"] { display:block; margin-top: 8px; }
      label { display:block; font-size: 13px; color:#333; margin-top:8px }
      input[type="text"], input[type="number"], input[type="date"] {
        width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 8px; margin-top: 4px;
      }
    </style>
  </head>
  <body>
    <h1>Kosmos Bookkeeping</h1>

    <div class="card">
      <p id="status" class="muted">Connected.</p>
      <p><strong>Receipts in database:</strong> <span id="count">0</span></p>
    </div>

    <div class="card" style="margin-top:16px;">
      <h3>Upload a receipt (manual-only)</h3>
      <p class="muted">Uploads image → saves to <code>receipts-warm</code> → inserts row in <code>public.receipts</code>.</p>

      <div class="row">
        <input id="file" type="file" accept="image/*,.pdf" />
      </div>

      <!-- minimal manual fields (all optional) -->
      <div class="row">
        <label>Vendor
          <input id="vendor" type="text" placeholder="e.g., Wholesale Club" />
        </label>
      </div>
      <div class="row">
        <label>Date
          <input id="rdate" type="date" />
        </label>
      </div>
      <div class="row">
        <label>Total
          <input id="total" type="number" step="0.01" placeholder="0.00" />
        </label>
      </div>
      <div class="row">
        <label>Category
          <input id="category" type="text" placeholder="Restaurant Supplies, Building Supplies, etc." />
        </label>
      </div>
      <div class="row">
        <label>Source
          <input id="source" type="text" placeholder="CIBC Chequing, TD Visa, Cash…" />
        </label>
      </div>
      <div class="row">
        <label>Notes
          <input id="notes" type="text" placeholder="optional" />
        </label>
      </div>

      <div class="row">
        <button id="uploadBtn">Upload & Save</button>
        <span id="uploadStatus" class="muted" style="margin-left:10px;"></span>
      </div>
    </div>

    <!-- Supabase JS (UMD) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <script>
      const SUPABASE_URL = "https://advihqhjjlxumgdlbwui.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkdmlocWhqamx4dW1nZGxid3VpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMTg0MzIsImV4cCI6MjA3NjU5NDQzMn0.kVlaPQg2_o9DGJYv22Dgca7veok4drF6kgLPy2wPBeY";
      const BUCKET = "receipts-warm";

      const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const statusEl = document.getElementById("status");
      const countEl  = document.getElementById("count");
      const uploadBtn = document.getElementById("uploadBtn");
      const uploadStatus = document.getElementById("uploadStatus");

      async function refreshCount() {
        const { count, error } = await sb.from("receipts").select("*", { count:"exact", head:true });
        if (!error) countEl.textContent = (count ?? 0).toString();
      }

      // initial count
      refreshCount().then(() => statusEl.textContent = "Connected.");

      async function handleUpload() {
        uploadStatus.textContent = "Uploading…";
        const fileInput = document.getElementById("file");
        const file = fileInput.files?.[0];
        if (!file) { uploadStatus.textContent = "Pick a file first."; return; }

        // 1) Upload file to Storage
        const objectPath = `${Date.now()}-${file.name}`;
        const { error: upErr } = await sb.storage.from(BUCKET).upload(objectPath, file, {
          contentType: file.type || "application/octet-stream",
          upsert: false
        });
        if (upErr) { uploadStatus.textContent = "Storage error: " + upErr.message; return; }

        const publicUrl = `${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${encodeURIComponent(objectPath)}`;

        // 2) Collect manual fields
        const vendor = document.getElementById("vendor").value || null;
        const rdate  = document.getElementById("rdate").value || null;
        const total  = document.getElementById("total").value;
        const category = document.getElementById("category").value || null;
        const source = document.getElementById("source").value || null;
        const notes  = document.getElementById("notes").value || null;

        // Convert total to number or null
        const totalNum = total === "" ? null : Number(total);

        // 3) Insert DB row (manual-only, no OCR)
        const { error: insErr } = await sb.from("receipts").insert([{
          image_url: publicUrl,
          vendor: vendor,
          receipt_date: rdate,   // expects YYYY-MM-DD or null
          total: totalNum,       // REQUIRED by your schema; leave null if you want to fill later
          tax: 0.00,
          subtotal: null,
          category: category,
          source: source,
          notes: notes,
          entered_by: null
        }]);

        if (insErr) { uploadStatus.textContent = "DB error: " + insErr.message; return; }

        uploadStatus.textContent = "Saved ✔";
        fileInput.value = "";
        await refreshCount();
      }

      uploadBtn.addEventListener("click", handleUpload);
    </script>
  </body>
</html>
