<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kosmos Bookkeeping</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
      body { font-family: sans-serif; margin: 2rem; }
      h1 { font-size: 1.6rem; }
      .card { border: 1px solid #ccc; padding: 1rem; border-radius: 8px; margin-top: 1rem; width: 450px; }
      label { display: block; margin-top: 0.5rem; font-weight: bold; }
      input, select { width: 100%; padding: 6px; margin-top: 4px; border: 1px solid #aaa; border-radius: 4px; }
      button { margin-top: 1rem; padding: 8px 14px; border-radius: 6px; border: none; background: #222; color: white; cursor: pointer; }
      button:hover { background: #444; }
      .readonly { background: #f4f4f4; }
    </style>
  </head>
  <body>
    <h1>Kosmos Bookkeeping</h1>

    <div class="card" id="statusCard">
      <p id="status">Connecting...</p>
      <p><strong>Receipts in database:</strong> <span id="receiptCount">—</span></p>
    </div>

    <div class="card">
      <h3>Upload a receipt (manual-only)</h3>
      <p><small>Uploads image ➜ saves to <code>receipts-warm</code> ➜ inserts row in <code>public.receipts</code>.</small></p>
      <input type="file" id="fileInput" accept="image/*" />

      <label>Vendor
        <input id="vendor" list="vendorList" placeholder="e.g. Sysco, Costco..." />
        <datalist id="vendorList"></datalist>
      </label>

      <label>Date
        <input id="rdate" type="date" />
      </label>

      <label>Total
        <input id="total" type="number" step="0.01" />
      </label>

      <label>Tax
        <input id="tax" type="number" step="0.01" />
      </label>

      <label>Subtotal (auto)
        <input id="subtotal" type="number" step="0.01" class="readonly" readonly />
      </label>

      <label>Category
        <input id="category" list="categoryList" placeholder="e.g. Restaurant Supplies..." />
        <datalist id="categoryList"></datalist>
      </label>

      <label>Source
        <input id="source" list="sourceList" placeholder="e.g. TD Visa, CIBC..." />
        <datalist id="sourceList"></datalist>
      </label>

      <label>Notes
        <input id="notes" placeholder="optional" />
      </label>

      <button id="uploadBtn">Upload & Save</button>
      <p id="msg"></p>
    </div>

    <script>
      const SUPABASE_URL = "https://advihqhjjlxumgdlbwui.supabase.co";
      const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkdmlocWhqamx4dW1nZGxid3VpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMTg0MzIsImV4cCI6MjA3NjU5NDQzMn0.kVlaPQg2_o9DGJYv22Dgca7veok4drF6kgLPy2wPBeY";
      const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      const fileInput = document.getElementById("fileInput");
      const msg = document.getElementById("msg");

      async function init() {
        const { data, error } = await sb.from("receipts").select("*");
        if (error) {
          document.getElementById("status").innerText = "Connection failed.";
          console.error(error);
        } else {
          document.getElementById("status").innerText = "Connected.";
          document.getElementById("receiptCount").innerText = data.length;

          // fill dropdowns
          const vendors = [...new Set(data.map(r => r.vendor).filter(Boolean))];
          const cats = [...new Set(data.map(r => r.category).filter(Boolean))];
          const sources = [...new Set(data.map(r => r.source).filter(Boolean))];
          fillList("vendorList", vendors);
          fillList("categoryList", cats);
          fillList("sourceList", sources);
        }
      }

      function fillList(id, arr) {
        const el = document.getElementById(id);
        el.innerHTML = arr.map(v => `<option value="${v}">`).join("");
      }

      function updateSubtotalPreview() {
        const total = parseFloat(document.getElementById("total").value) || 0;
        const tax = parseFloat(document.getElementById("tax").value) || 0;
        document.getElementById("subtotal").value = (total - tax).toFixed(2);
      }
      document.getElementById("total").addEventListener("input", updateSubtotalPreview);
      document.getElementById("tax").addEventListener("input", updateSubtotalPreview);

      document.getElementById("uploadBtn").addEventListener("click", async () => {
        msg.textContent = "Uploading...";
        const file = fileInput.files[0];
        if (!file) return alert("Please select a file first.");

        // upload image to Supabase bucket
        const fileName = `${Date.now()}-${file.name}`;
        const { error: upErr } = await sb.storage.from("receipts-warm").upload(fileName, file);
        if (upErr) {
          msg.textContent = "Upload error: " + upErr.message;
          return;
        }

        const { data: { publicUrl } } = sb.storage.from("receipts-warm").getPublicUrl(fileName);

        const vendor = document.getElementById("vendor").value;
        const rdate = document.getElementById("rdate").value;
        const total = parseFloat(document.getElementById("total").value) || 0;
        const tax = parseFloat(document.getElementById("tax").value) || 0;
        const category = document.getElementById("category").value;
        const source = document.getElementById("source").value;
        const notes = document.getElementById("notes").value;

        const { error: insErr } = await sb.from("receipts").insert([{
          image_url: publicUrl,
          vendor,
          receipt_date: rdate,
          total,
          tax,
          category,
          source,
          notes,
          entered_by: null
        }]);

        if (insErr) {
          msg.textContent = "DB error: " + insErr.message;
          console.error(insErr);
        } else {
          msg.textContent = "✅ Uploaded & saved successfully.";
          init();
        }
      });

      init();
    </script>
  </body>
</html>
