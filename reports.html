<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kosmos ‚Äî Reports</title>

  <!-- Shared theme -->
  <link rel="stylesheet" href="style.css" />

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <h1>Kosmos Bookkeeping</h1>
    <nav>
      <a href="index.html">Dashboard</a>
      <a href="receipts.html">Receipts</a>
      <a href="transactions.html">Transactions</a>
      <a href="reports.html" class="active">Reports</a>
    </nav>
  </header>

  <main class="container">
    <h2>üìÅ Accountant Export</h2>
    <p class="muted">Download an accountant-ready CSV for any period. Includes date, vendor, category, source, subtotal, tax, total, notes, and image URL.</p>

    <div class="card">
      <div class="row" style="margin-bottom:8px;">
        <label>From</label>
        <input type="date" id="fromDate" />
        <label>To</label>
        <input type="date" id="toDate" />
        <button id="exportBtn">Export Accountant CSV</button>
      </div>
      <p id="msg" class="muted"></p>
    </div>
  </main>

  <script>
    const SUPABASE_URL="https://advihqhjjlxumgdlbwui.supabase.co";
    const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkdmlocWhqamx4dW1nZGxid3VpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMTg0MzIsImV4cCI6MjA3NjU5NDQzMn0.kVlaPQg2_o9DGJYv22Dgca7veok4drF6kgLPy2wPBeY";
    const sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

    const qs=id=>document.getElementById(id);
    const msg=qs("msg");

    function escCSV(v){ if(v==null)return""; const s=String(v); return /[",\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s; }
    function to2(n){ const v=Number(n); return Number.isNaN(v)?"":v.toFixed(2); }

    async function exportCSV(){
      msg.className="muted"; msg.textContent="Building export‚Ä¶";
      const from=qs("fromDate").value||"1900-01-01";
      const to=qs("toDate").value||"2100-12-31";
      const {data,error}=await sb.from("v_accountant_export_receipts")
        .select("*").gte("receipt_date",from).lte("receipt_date",to)
        .order("receipt_date",{ascending:true});
      if(error){ msg.className="err"; msg.textContent=error.message; return; }
      if(!data.length){ msg.textContent="No receipts found for that range."; return; }

      const cols=[
        ["Date","receipt_date"],["Vendor","vendor"],["Category","category"],
        ["Source","source"],["Subtotal","subtotal"],["Tax","tax"],
        ["Total","total"],["Notes","notes"],["Image URL","image_url"]
      ];
      const header=cols.map(c=>c[0]).join(",");
      const rows=data.map(r=>cols.map(c=>{
        const key=c[1];
        if(["subtotal","tax","total"].includes(key))return escCSV(to2(r[key]));
        if(key==="receipt_date")return escCSV(String(r[key]).slice(0,10));
        return escCSV(r[key]);
      }).join(","));
      const csv=[header,...rows].join("\n");

      const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a");
      const today=new Date().toISOString().slice(0,10);
      a.href=url; a.download=`kosmos_accountant_export_${today}.csv`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
      msg.className="ok"; msg.textContent=`Exported ${data.length} receipts to CSV.`;
    }

    qs("exportBtn").addEventListener("click",exportCSV);
  </script>
<script src="roles.js"></script>
</body>
</html>
