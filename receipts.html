<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kosmos ‚Äî Receipts</title>

  <link rel="stylesheet" href="style.css" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    .uploader{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:860px){.uploader{grid-template-columns:1fr}}
    .imgbox{border:1px dashed var(--border);border-radius:14px;background:#fff;padding:14px;text-align:center}
    .imgbox input{width:100%}
    .imgbox img{max-width:100%;height:auto;border-radius:10px;margin-top:10px}
    .mutetip{font-size:.85rem;color:var(--muted)}
    .grid-rec{display:grid;gap:12px}
    @media (min-width:900px){.grid-rec{display:block}}

    .r-cards{display:grid;gap:12px;grid-template-columns:repeat(1,minmax(0,1fr))}
    @media (min-width:520px){.r-cards{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (min-width:900px){.r-cards{display:none}}

    .card-receipt{display:flex;gap:12px;align-items:flex-start}
    .card-receipt img{width:66px;height:66px;object-fit:cover;border-radius:10px;border:1px solid var(--border)}
    .card-receipt .meta{flex:1}
    .card-receipt .meta b{display:block}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--border);font-weight:600;font-size:.82rem}
    .badge.ok{background:#eef9f1;color:var(--ok);border-color:#cfe7d6}
    .badge.muted{background:#f6f7f8;color:var(--muted)}

    td.editable{cursor:text} td.editing{background:#fffbe6}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .spacer{flex:1 1 auto}
    .hl{outline:3px solid var(--brand);box-shadow:0 0 0 4px color-mix(in oklab, var(--brand) 18%, transparent)}
  </style>
</head>
<body>
<header>
  <h1>Kosmos Bookkeeping</h1>
  <nav>
    <a href="index.html">Dashboard</a>
    <a href="receipts.html" class="active">Receipts</a>
    <a href="transactions.html">Transactions</a>
    <a href="reports.html">Reports</a>
  </nav>
</header>

<main class="container">
  <h2>üßæ Receipts</h2>
  <p class="muted">Manual upload (scanner off). Fill all required fields and upload an image. Role rules: staff upload only, managers edit, admins delete.</p>

  <!-- Match Now toolbar -->
  <div class="card" style="margin-bottom:12px;">
    <div class="toolbar">
      <button id="matchNowBtn">üîÑ Match Now</button>
      <span id="matchNowMsg" class="muted"></span>
      <span class="spacer"></span>
    </div>
  </div>

  <!-- Upload Box -->
  <div class="card">
    <div class="uploader">
      <div class="imgbox">
        <input id="file" type="file" accept="image/*,.pdf" capture="environment" />
        <div class="mutetip" style="margin-top:6px">Tip: On mobile this opens your camera. PDFs are allowed too.</div>
        <img id="preview" alt="" />
      </div>

      <div>
        <div class="grid grid-2">
          <div><label>Vendor</label><input id="vendor" placeholder="e.g., NO FRILLS" required /></div>
          <div><label>Date</label><input id="rdate" type="date" required /></div>
          <div><label>Total</label><input id="total" type="number" step="0.01" placeholder="0.00" required /></div>
          <div><label>Tax</label><input id="tax" type="number" step="0.01" value="0.00" required /></div>
          <div><label>Category</label><input id="category" placeholder="e.g., Restaurant Supplies" required /></div>
          <div><label>Source</label><input id="source" placeholder="e.g., CIBC Chequing" required /></div>
        </div>
        <div style="margin-top:8px">
          <label>Notes <span class="muted">(optional)</span></label>
          <input id="notes" placeholder="Any notes‚Ä¶" />
        </div>

        <p id="upMsg" class="muted" style="margin-top:8px"></p>
        <div class="row" style="justify-content:flex-end;margin-top:8px">
          <button id="clearBtn" class="ghost" type="button">Clear</button>
          <button id="uploadBtn" type="button">Upload Receipt</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters/Actions -->
  <div class="card">
    <div class="toolbar">
      <select id="filterMode">
        <option value="all">All</option>
        <option value="unmatched">Unmatched</option>
        <option value="matched">Matched</option>
        <option value="recent">Recently added</option>
      </select>

      <input id="search" placeholder="Search vendor/notes/source‚Ä¶" style="padding:.5rem .7rem;border:1px solid #cfcfcf;border-radius:10px;min-width:220px" />
      <button id="applyFilter">Apply</button>

      <span class="spacer"></span>
      <button id="deleteSelected" class="ghost admin-only">üóëÔ∏è Delete Selected</button>
    </div>
    <div class="chips" style="margin-top:8px">
      <span class="chip">Total: <b id="countAll">0</b></span>
      <span class="chip">Matched: <b id="countMatched">0</b></span>
      <span class="chip">Unmatched: <b id="countUnmatched">0</b></span>
    </div>
    <p id="status" class="muted" style="margin-top:6px"></p>
  </div>

  <!-- Card list on mobile -->
  <div class="grid-rec">
    <div class="r-cards" id="cards"></div>

    <!-- Table on desktop -->
    <div class="card" style="overflow:auto">
      <table id="recTable">
        <thead>
          <tr>
            <th style="width:40px"><input type="checkbox" id="selectAll" /></th>
            <th style="min-width:110px;">Date</th>
            <th style="min-width:180px;">Vendor</th>
            <th class="right" style="min-width:110px;">Total</th>
            <th class="right" style="min-width:90px;">Tax</th>
            <th style="min-width:140px;">Category</th>
            <th style="min-width:140px;">Source</th>
            <th style="min-width:120px;">Status</th>
            <th style="min-width:220px;">Notes</th>
            <th style="min-width:200px;">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr><td colspan="10">
            <div class="sticky-footer">
              <span class="kpill">Rows: <b id="ftRows">0</b></span>
              <span class="kpill">Subtotal: <b id="ftSubtotal">$0.00</b></span>
              <span class="kpill">Tax: <b id="ftTax">$0.00</b></span>
              <span class="kpill">Total: <b id="ftTotal">$0.00</b></span>
            </div>
          </td></tr>
        </tfoot>
      </table>
    </div>
  </div>
</main>

<script>
const SUPABASE_URL = "https://advihqhjjlxumgdlbwui.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkdmlocWhqamx4dW1nZGxid3VpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMTg0MzIsImV4cCI6MjA3NjU5NDQzMn0.kVlaPQg2_o9DGJYv22Dgca7veok4drF6kgLPy2wPBeY";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const $ = id => document.getElementById(id);
const tbody = document.querySelector("#recTable tbody");
const cards = $("cards");
let all = [];
let matches = new Map();
const selected = new Set();

function money(n){ const v=Number(n)||0; return `$${v.toFixed(2)}`; }
function esc(s){ return String(s??"").replace(/[&<>]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m])); }

/* Match Now RPC */
async function matchNow(days=5, tol=0.005){
  const { data, error } = await sb.rpc('match_now', { p_days: days, p_tol: tol });
  if (error) { console.error('match_now error:', error); throw error; }
  return data ?? 0;
}

/* Upload form */
$("file").addEventListener("change", e=>{
  const f=e.target.files?.[0];
  $("preview").src = f ? URL.createObjectURL(f) : "";
  $("upMsg").textContent = f ? `Selected: ${f.name}` : "";
});
$("clearBtn").onclick = ()=>{
  $("file").value=""; $("preview").src="";
  ["vendor","rdate","total","tax","category","source","notes"].forEach(id=>$(id).value="");
  $("tax").value="0.00"; $("upMsg").textContent="";
};

$("uploadBtn").onclick = async ()=>{
  const f=$("file").files?.[0];
  if(!f) { $("upMsg").textContent="Choose a file first."; return; }

  const data = {
    vendor:$("vendor").value.trim(),
    receipt_date:$("rdate").value,
    total:Number($("total").value||0),
    tax:Number($("tax").value||0),
    category:$("category").value.trim(),
    source:$("source").value.trim(),
    notes:$("notes").value.trim()||null
  };
  if(!data.vendor||!data.receipt_date||!data.total||!data.category||!data.source){
    $("upMsg").textContent="All fields required."; return;
  }

  try {
    $("upMsg").textContent="Uploading‚Ä¶";
    const fname=`r_${Date.now()}_${(f.name||'img').replace(/[^\w.\-]+/g,'_')}`;
    const { data:upRes, error:upErr }=await sb.storage.from("receipts-warm").upload(fname,f,{contentType:f.type||"image/jpeg"});
    if(upErr) throw upErr;

    const { data:pub }=sb.storage.from("receipts-warm").getPublicUrl(upRes.path);
    data.image_url=pub?.publicUrl||null; data.size_bytes=f.size||0;

    const { error:insErr }=await sb.from("receipts").insert(data);
    if(insErr) throw insErr;

    // Auto-match after a successful insert
    $("upMsg").textContent="Matching‚Ä¶";
    try {
      const matched = await matchNow(5, 0.005);
      $("upMsg").textContent = `Saved ‚úî ‚Äî matched ${matched} receipt(s)`;
    } catch (e) {
      $("upMsg").textContent = "Saved ‚úî ‚Äî (match skipped)";
    }

    $("clearBtn").click();
    await loadReceipts();
  } catch (err) {
    console.error(err);
    $("upMsg").textContent = err?.message || String(err);
  }
};

/* Match Now button */
const matchBtn = $("matchNowBtn");
const matchMsg = $("matchNowMsg");
matchBtn?.addEventListener("click", async ()=>{
  try {
    matchBtn.disabled = true;
    matchMsg.textContent = "Matching‚Ä¶";
    const n = await matchNow(5, 0.005);
    matchMsg.textContent = `Matched ${n} receipt(s).`;
    await loadReceipts();
  } catch (e) {
    console.error(e);
    matchMsg.textContent = "Match error ‚Äî see console";
  } finally {
    matchBtn.disabled = false;
  }
});

/* Load receipts */
async function loadReceipts(){
  const { data: recs, error: rErr } = await sb.from("receipts").select("*").order("created_at",{ascending:false});
  if(rErr){ tbody.innerHTML=`<tr><td colspan="10">${rErr.message}</td></tr>`; return; }
  all = recs||[];

  const { data: mx } = await sb.from("matches").select("receipt_id, transaction_id");
  matches.clear();
  (mx||[]).forEach(m=>{
    const arr=matches.get(m.receipt_id)||[];
    arr.push(m.transaction_id);
    matches.set(m.receipt_id,arr);
  });
  applyFilters();
}

/* Filters */
$("applyFilter").onclick = applyFilters;
$("search").oninput = ()=>{ clearTimeout(window.__t); window.__t=setTimeout(applyFilters,200); };

function applyFilters(){
  const mode=$("filterMode").value;
  const q=($("search").value||"").toLowerCase().trim();
  let rows=all.slice();
  rows=rows.filter(r=>{
    const hasMatch=matches.has(r.id);
    if(mode==="matched") return hasMatch;
    if(mode==="unmatched") return !hasMatch;
    return true;
  });
  if(q) rows=rows.filter(r=>(r.vendor||"").toLowerCase().includes(q)||(r.notes||"").toLowerCase().includes(q)||(r.source||"").toLowerCase().includes(q));
  render(rows);
}

function render(rows){
  $("countAll").textContent=all.length;
  let m=0; all.forEach(r=>{if(matches.has(r.id))m++;});
  $("countMatched").textContent=m; $("countUnmatched").textContent=all.length-m;

  if(!rows.length){tbody.innerHTML=`<tr><td colspan="10">No receipts.</td></tr>`;return;}
  let subtotal=0,taxSum=0,totalSum=0;
  tbody.innerHTML=rows.map(r=>{
    subtotal+=Number(r.total||0)-Number(r.tax||0);
    taxSum+=Number(r.tax||0);
    totalSum+=Number(r.total||0);
    const status=matches.has(r.id)?`<span class="badge ok">Matched</span>`:`<span class="badge muted">Unmatched</span>`;
    const img=r.image_url?`<img src="${esc(r.image_url)}" width="44" height="44" style="object-fit:cover;border-radius:8px;border:1px solid var(--border)" />`:"";
    const delBtn = `<button class="ghost btnDel admin-only" data-id="${r.id}">Delete</button>`;
    return `<tr data-id="${r.id}">
      <td><input type="checkbox" class="sel" data-id="${r.id}" ${selected.has(r.id)?"checked":""}></td>
      <td>${esc((r.receipt_date||"").slice(0,10))}</td>
      <td>${esc(r.vendor||"")}</td>
      <td class="right">${money(r.total||0)}</td>
      <td class="right">${money(r.tax||0)}</td>
      <td>${esc(r.category||"")}</td>
      <td>${esc(r.source||"")}</td>
      <td>${status}</td>
      <td>${esc(r.notes||"")}</td>
      <td>${img}<a class="badge" href="${esc(r.image_url||'#')}" target="_blank" rel="noopener">Open</a> ${delBtn}</td>
    </tr>`;
  }).join("");
  $("ftRows").textContent=rows.length; $("ftSubtotal").textContent=money(subtotal); $("ftTax").textContent=money(taxSum); $("ftTotal").textContent=money(totalSum);

  document.querySelectorAll(".btnDel").forEach(btn=>{
    btn.onclick=async()=>{
      const id=btn.dataset.id;
      if(!window.can||!window.can("delete:any")) return alert("Only admins can delete receipts.");
      if(!confirm("Delete this receipt?"))return;
      await sb.from("receipts").delete().eq("id",id);
      loadReceipts();
    };
  });
}

/* Bulk delete */
$("deleteSelected").onclick = async()=>{
  if(!window.can||!window.can("delete:any")) return alert("Admins only.");
  if(!selected.size) return;
  if(!confirm(`Delete ${selected.size} receipts?`)) return;
  await sb.from("receipts").delete().in("id",[...selected]);
  selected.clear(); loadReceipts();
};
$("selectAll").onchange = e=>{
  if(e.target.checked) all.forEach(r=>selected.add(r.id)); else selected.clear();
  applyFilters();
};

loadReceipts();
</script>

<!-- Role/Session Guard -->
<script src="roles.js"></script>
</body>
</html>
