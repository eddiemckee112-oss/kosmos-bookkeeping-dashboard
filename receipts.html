<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kosmos ‚Äî Receipts</title>

  <link rel="stylesheet" href="style.css" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    .uploader{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:860px){.uploader{grid-template-columns:1fr}}
    .imgbox{border:1px dashed var(--border);border-radius:14px;background:#fff;padding:14px;text-align:center}
    .imgbox input{width:100%}
    .imgbox img{max-width:100%;height:auto;border-radius:10px;margin-top:10px}
    .mutetip{font-size:.85rem;color:var(--muted)}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .right{text-align:right}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--border);font-weight:600;font-size:.82rem}
    .badge.ok{background:#eef9f1;color:var(--ok);border-color:#cfe7d6}
    .badge.muted{background:#f6f7f8;color:var(--muted)}
    .kpill{padding:4px 10px;border:1px solid var(--border);border-radius:999px;background:#fff}
    .sticky-footer{display:flex;gap:10px;flex-wrap:wrap}
    .editgrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
    .editgrid .full{grid-column:1/-1}
    .danger{color:#b91c1c}
    .linkbtn{padding:4px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;cursor:pointer}
    .dim{opacity:.65}
  </style>
</head>
<body>
<header>
  <h1>Kosmos Bookkeeping</h1>
  <nav>
    <a href="index.html">Dashboard</a>
    <a href="receipts.html" class="active">Receipts</a>
    <a href="transactions.html">Transactions</a>
    <a href="reports.html">Reports</a>
  </nav>
</header>

<main class="container">
  <h2>üßæ Receipts</h2>
  <p class="muted">Upload, edit, delete, and link receipts. Category/Source are fixed dropdowns. ‚ÄúMatch Now‚Äù opens Transactions in linking mode.</p>

  <!-- Upload -->
  <div class="card">
    <div class="uploader">
      <div class="imgbox">
        <input id="file" type="file" accept="image/*,.pdf" capture="environment" />
        <div class="mutetip" style="margin-top:6px">On mobile this opens your camera. PDFs allowed.</div>
        <img id="preview" alt="" />
      </div>

      <div>
        <div class="editgrid">
          <div><label>Vendor</label><input id="vendor" placeholder="e.g., NO FRILLS" required /></div>
          <div><label>Date</label><input id="rdate" type="date" required /></div>
          <div><label>Total</label><input id="total" type="number" step="0.01" placeholder="0.00" required /></div>
          <div><label>Tax</label><input id="tax" type="number" step="0.01" value="0.00" required /></div>
          <div>
            <label>Category</label>
            <select id="category" required></select>
          </div>
          <div>
            <label>Source</label>
            <select id="source" required></select>
          </div>
          <div class="full">
            <label>Notes <span class="muted">(optional)</span></label>
            <input id="notes" placeholder="Any notes‚Ä¶"/>
          </div>
        </div>

        <p id="upMsg" class="muted" style="margin-top:8px"></p>
        <div class="row" style="justify-content:flex-end;margin-top:8px;gap:8px">
          <button id="clearBtn" class="ghost" type="button">Clear</button>
          <button id="uploadBtn" type="button">Upload Receipt</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="card">
    <div class="toolbar">
      <select id="filterMode">
        <option value="all">All</option>
        <option value="unmatched">Unmatched</option>
        <option value="matched">Matched</option>
        <option value="recent">Recently added</option>
      </select>

      <input id="search" placeholder="Search vendor/notes/source‚Ä¶" style="padding:.5rem .7rem;border:1px solid #cfcfcf;border-radius:10px;min-width:220px" />
      <button id="applyFilter">Apply</button>

      <span class="spacer"></span>
      <span class="kpill">Total: <b id="countAll">0</b></span>
      <span class="kpill">Matched: <b id="countMatched">0</b></span>
      <span class="kpill">Unmatched: <b id="countUnmatched">0</b></span>

      <span class="spacer"></span>
      <button id="exportBtn" class="ghost">‚¨áÔ∏è Export CSV</button>
    </div>
    <p id="status" class="muted" style="margin-top:6px"></p>
  </div>

  <!-- Table -->
  <div class="card" style="overflow:auto">
    <table id="recTable" style="min-width:1100px">
      <thead>
        <tr>
          <th style="min-width:110px;">Date</th>
          <th style="min-width:180px;">Vendor</th>
          <th class="right" style="min-width:110px;">Total</th>
          <th class="right" style="min-width:90px;">Tax</th>
          <th style="min-width:180px;">Category</th>
          <th style="min-width:160px;">Source</th>
          <th style="min-width:120px;">Status</th>
          <th style="min-width:220px;">Notes</th>
          <th style="min-width:280px;">Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr><td colspan="9">
          <div class="sticky-footer">
            <span class="kpill">Rows: <b id="ftRows">0</b></span>
            <span class="kpill">Subtotal: <b id="ftSubtotal">$0.00</b></span>
            <span class="kpill">Tax: <b id="ftTax">$0.00</b></span>
            <span class="kpill">Total: <b id="ftTotal">$0.00</b></span>
          </div>
        </td></tr>
      </tfoot>
    </table>
  </div>
</main>

<script>
/* ---------- Supabase ---------- */
const sb = supabase.createClient(
  "https://advihqhjjlxumgdlbwui.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkdmlocWhqamx4dW1nZGxid3VpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMTg0MzIsImV4cCI6MjA3NjU5NDQzMn0.kVlaPQg2_o9DGJYv22Dgca7veok4drF6kgLPy2wPBeY"
);

/* ---------- Fixed options ---------- */
const CATEGORIES = [
  "Uncategorized","Income","Bank Fees","Fuel","Utilities","Phone/Internet","Insurance",
  "Professional Fees","Software","Subscriptions","Repairs & Maintenance","Office",
  "Meals & Entertainment","Travel","Lodging","Building Maintenance","Building Miscellaneous",
  "Restaurant (Food & Supplies)","Taxes","Other"
];
const SOURCES = ["CIBC Bank Account","Rogers MasterCard","PC MasterCard","Cash"];

/* ---------- Helpers ---------- */
const $ = id => document.getElementById(id);
const tbody = document.querySelector("#recTable tbody");
let ALL = [];
let MATCHES = new Map();

const money = n => (Number(n)||0).toLocaleString(undefined,{style:'currency',currency:'CAD'});
function esc(s){ return String(s??"").replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }

/* ---------- Populate dropdowns & defaults ---------- */
function initUploadForm(){
  $("category").innerHTML = CATEGORIES.map(c=>`<option value="${esc(c)}">${esc(c)}</option>`).join("");
  $("source").innerHTML   = SOURCES.map(s=>`<option value="${esc(s)}">${esc(s)}</option>`).join("");

  $("category").value = "Uncategorized";
  $("source").value   = SOURCES[0];
  $("rdate").value    = new Date().toISOString().slice(0,10);
}
initUploadForm();

/* ---------- Upload ---------- */
$("file").addEventListener("change", e=>{
  const f=e.target.files?.[0];
  $("preview").src = f ? URL.createObjectURL(f) : "";
  $("upMsg").textContent = f ? `Selected: ${f.name}` : "";
});
$("clearBtn").onclick = ()=>{
  $("file").value=""; $("preview").src="";
  ["vendor","total","tax","notes"].forEach(id=>$(id).value="");
  $("tax").value="0.00"; $("upMsg").textContent="";
  initUploadForm();
};
$("uploadBtn").onclick = async ()=>{
  const f=$("file").files?.[0];
  if(!f) return $("upMsg").textContent="Choose a file first.";

  const payload = {
    vendor:$("vendor").value.trim(),
    receipt_date:$("rdate").value,
    total:Number($("total").value||0),
    tax:Number($("tax").value||0),
    category:$("category").value,
    source:$("source").value,
    notes:($("notes").value||"").trim()||null
  };
  if(!payload.vendor || !payload.receipt_date || !payload.total || !payload.category || !payload.source){
    $("upMsg").textContent="All fields required."; return;
  }

  $("upMsg").textContent="Uploading image‚Ä¶";
  const fname=`r_${Date.now()}_${(f.name||'img').replace(/[^\w.\-]+/g,'_')}`;
  const { data:upRes, error:upErr }=await sb.storage.from("receipts-warm").upload(fname,f,{contentType:f.type||"image/jpeg"});
  if(upErr) return $("upMsg").textContent=upErr.message;
  const imageUrl=`https://advihqhjjlxumgdlbwui.supabase.co/storage/v1/object/public/receipts-warm/${fname}`;

  const { error:insErr }=await sb.from("receipts").insert({
    image_url:imageUrl, size_bytes:f.size||0,
    receipt_date:payload.receipt_date, total:payload.total, tax:payload.tax,
    category:payload.category, vendor:payload.vendor, source:payload.source,
    notes:payload.notes, entered_by:"You"
  });
  if(insErr) return $("upMsg").textContent=insErr.message;

  $("upMsg").textContent="Uploaded.";
  $("clearBtn").click();
  await loadReceipts();
};

/* ---------- Row actions ---------- */
function badge(rec){ return MATCHES.has(rec.id) ? `<span class="badge ok">Matched</span>` : `<span class="badge muted">Unmatched</span>`; }
function actions(rec){
  const open = rec.image_url ? `<a class="linkbtn" href="${esc(rec.image_url)}" target="_blank" rel="noopener">Open</a>` : "";
  const matchBtn = `<button class="linkbtn" data-act="match" data-id="${rec.id}">Match Now</button>`;
  const editBtn  = `<button class="linkbtn" data-act="edit" data-id="${rec.id}">Edit</button>`;
  const delBtn   = `<button class="linkbtn danger" data-act="del" data-id="${rec.id}">Delete</button>`;
  return `${open} ${matchBtn} ${editBtn} ${delBtn}`;
}

function render(rows){
  $("countAll").textContent=ALL.length;
  let m=0; ALL.forEach(r=>{ if(MATCHES.has(r.id)) m++;});
  $("countMatched").textContent=m; $("countUnmatched").textContent=ALL.length-m;

  if(!rows.length){ tbody.innerHTML=`<tr><td colspan="9">No receipts.</td></tr>`; return; }

  let subtotal=0,taxSum=0,totalSum=0;
  tbody.innerHTML = rows.map(r=>{
    subtotal += (+r.total||0) - (+r.tax||0);
    taxSum   += (+r.tax||0);
    totalSum += (+r.total||0);
    return `<tr data-id="${r.id}">
      <td>${esc((r.receipt_date||"").slice(0,10))}</td>
      <td>${esc(r.vendor||"")}</td>
      <td class="right">${money(r.total||0)}</td>
      <td class="right">${money(r.tax||0)}</td>
      <td>${esc(r.category||"")}</td>
      <td>${esc(r.source||"")}</td>
      <td>${badge(r)}</td>
      <td>${esc(r.notes||"")}</td>
      <td>${actions(r)}</td>
    </tr>`;
  }).join("");

  $("ftRows").textContent=rows.length;
  $("ftSubtotal").textContent=money(subtotal);
  $("ftTax").textContent=money(taxSum);
  $("ftTotal").textContent=money(totalSum);

  tbody.querySelectorAll("button[data-act]").forEach(btn=>{
    const id=btn.getAttribute("data-id");
    const act=btn.getAttribute("data-act");

    if(act==="del"){
      btn.onclick = async ()=>{
        if(!confirm("Delete this receipt?")) return;
        await sb.from("matches").delete().eq("receipt_id", id);
        await sb.from("receipts").delete().eq("id", id);
        loadReceipts();
      };
    } else if(act==="edit"){
      btn.onclick = ()=> openEdit(id);
    } else if(act==="match"){
      btn.onclick = ()=>{
        sessionStorage.setItem('linkReceipt', id);
        location.href = 'transactions.html?linkReceipt=' + encodeURIComponent(id);
      };
    }
  });
}

/* ---------- Filters ---------- */
$("applyFilter").onclick = applyFilters;
$("search").oninput = ()=>{ clearTimeout(window.__t); window.__t=setTimeout(applyFilters,200); };
function applyFilters(){
  const mode=$("filterMode").value;
  const q = ($("search").value||"").toLowerCase().trim();
  let rows = ALL.slice();
  rows = rows.filter(r=>{
    const hasMatch = MATCHES.has(r.id);
    if(mode==="matched") return hasMatch;
    if(mode==="unmatched") return !hasMatch;
    return true;
  });
  if(q){
    rows = rows.filter(r =>
      (r.vendor||"").toLowerCase().includes(q) ||
      (r.notes||"").toLowerCase().includes(q) ||
      (r.source||"").toLowerCase().includes(q)
    );
  }
  render(rows);
}

/* ---------- Edit ---------- */
async function openEdit(id){
  const rec = ALL.find(r=>r.id===id); if(!rec) return;

  const vendor = prompt("Vendor", rec.vendor||""); if(vendor===null) return;
  const date   = prompt("Date (YYYY-MM-DD)", (rec.receipt_date||"").slice(0,10)); if(date===null) return;

  const totalStr  = prompt("Total", String(rec.total||0)); if(totalStr===null) return;
  const taxStr    = prompt("Tax", String(rec.tax||0)); if(taxStr===null) return;

  const cat = prompt(`Category (choose one exactly):\n${CATEGORIES.join(", ")}`, rec.category||"");
  if(cat===null) return;
  if(!CATEGORIES.includes(cat)) return alert("Category must be one of the fixed options.");

  const src = prompt(`Source (choose one exactly):\n${SOURCES.join(", ")}`, rec.source||"");
  if(src===null) return;
  if(!SOURCES.includes(src)) return alert("Source must be one of the fixed options.");

  const notes  = prompt("Notes", rec.notes||""); if(notes===null) return;

  const upd = {
    vendor: vendor.trim(),
    receipt_date: date,
    total: Number(totalStr)||0,
    tax: Number(taxStr)||0,
    category: cat,
    source: src,
    notes: notes.trim()
  };
  const { error } = await sb.from("receipts").update(upd).eq("id", id);
  if(error){ alert(error.message); return; }
  await loadReceipts();
}

/* ---------- Data load ---------- */
async function loadReceipts(){
  const { data: recs, error: rErr } = await sb.from("receipts")
    .select("id, receipt_date, total, tax, category, vendor, source, notes, image_url, created_at")
    .order("created_at",{ascending:false});
  if(rErr){ tbody.innerHTML=`<tr><td colspan="9">${rErr.message}</td></tr>`; return; }
  ALL = recs||[];

  const { data: mx } = await sb.from("matches").select("receipt_id, transaction_id");
  MATCHES.clear(); (mx||[]).forEach(m=>{
    const arr = MATCHES.get(m.receipt_id)||[];
    arr.push(m.transaction_id);
    MATCHES.set(m.receipt_id, arr);
  });

  applyFilters();
}

loadReceipts();

/* ---------- Export CSV (uses v_receipts_for_export so Vendor = bank name when linked) ---------- */
$("exportBtn").onclick = async ()=>{
  try {
    const { data, error } = await sb
      .from("v_receipts_for_export")
      .select("receipt_date, export_vendor, total, tax, category, source, notes")
      .order("receipt_date",{ascending:false});

    if(error){
      alert("Export failed: " + error.message);
      return;
    }

    const rows = [
      ["Date","Vendor","Total","Tax","Category","Source","Notes"],
      ...data.map(r=>[
        (r.receipt_date||"").slice(0,10),
        r.export_vendor||"",
        r.total??0,
        r.tax??0,
        r.category||"",
        r.source||"",
        (r.notes||"").replace(/[\r\n]+/g," "),
      ])
    ];

    const csv = rows.map(r =>
      r.map(cell=>{
        const s = String(cell??"");
        return /[",\n;]/.test(s)?`"${s.replace(/"/g,'""')}"`:s;
      }).join(",")
    ).join("\n");

    const blob = new Blob([csv],{type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "receipts_export.csv";
    a.click();
    URL.revokeObjectURL(a.href);
  } catch(e) {
    alert("Export error: " + (e.message||e));
  }
};
</script>
</body>
</html>
