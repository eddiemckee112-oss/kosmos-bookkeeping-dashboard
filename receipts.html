<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kosmos â€” Receipts</title>

  <link rel="stylesheet" href="style.css" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    .uploader{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:860px){.uploader{grid-template-columns:1fr}}
    .imgbox{border:1px dashed var(--border);border-radius:14px;background:#fff;padding:14px;text-align:center}
    .imgbox input{width:100%}
    .imgbox img{max-width:100%;height:auto;border-radius:10px;margin-top:10px}
    .mutetip{font-size:.85rem;color:var(--muted)}
    .right{text-align:right}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--border);font-weight:600;font-size:.82rem}
    .badge.ok{background:#eef9f1;color:var(--ok);border-color:#cfe7d6}
    .badge.muted{background:#f6f7f8;color:var(--muted)}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .kpill{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:4px 10px;background:#fff}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.18);display:none;align-items:flex-start;justify-content:center;padding:40px 12px;z-index:50}
    .modal{background:#fff;width:min(900px,100%);max-height:85vh;overflow:auto;border:1px solid var(--border);border-radius:16px;padding:16px}
    .field{display:flex;flex-direction:column;gap:6px}
    .grid-2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .grid-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    .row-actions{display:flex;gap:8px;flex-wrap:wrap}
  </style>
</head>
<body>
<header>
  <h1>Kosmos Bookkeeping</h1>
  <nav>
    <a href="index.html">Dashboard</a>
    <a href="receipts.html" class="active">Receipts</a>
    <a href="transactions.html">Transactions</a>
    <a href="reports.html">Reports</a>
  </nav>
</header>

<main class="container">
  <h2>ðŸ§¾ Receipts</h2>
  <p class="muted">Manual upload (scanner off). Staff upload; managers/admins edit; admins delete.</p>

  <!-- Upload -->
  <div class="card">
    <div class="uploader">
      <div class="imgbox">
        <input id="file" type="file" accept="image/*,.pdf" capture="environment" />
        <div class="mutetip" style="margin-top:6px">Tip: On mobile this opens your camera. PDFs OK.</div>
        <img id="preview" alt="" />
      </div>

      <div>
        <div class="grid-2">
          <div class="field"><label>Vendor *</label><input id="vendor" placeholder="e.g., NO FRILLS"/></div>
          <div class="field"><label>Date *</label><input id="rdate" type="date"/></div>
          <div class="field"><label>Total *</label><input id="total" type="number" step="0.01" min="0" placeholder="0.00"/></div>
          <div class="field"><label>Tax *</label><input id="tax" type="number" step="0.01" min="0" value="0.00"/></div>
          <div class="field">
            <label>Category *</label>
            <select id="category"></select>
          </div>
          <div class="field">
            <label>Source *</label>
            <select id="source"></select>
          </div>
        </div>
        <div class="field" style="margin-top:8px"><label>Notes <span class="muted">(optional)</span></label><input id="notes" placeholder="Any notesâ€¦"/></div>

        <p id="upMsg" class="muted" style="margin-top:8px"></p>
        <div class="row" style="justify-content:flex-end;margin-top:8px">
          <button id="clearBtn" class="ghost" type="button">Clear</button>
          <button id="uploadBtn" type="button">Upload Receipt</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="card">
    <div class="toolbar">
      <select id="filterMode">
        <option value="all">All</option>
        <option value="unmatched">Unmatched</option>
        <option value="matched">Matched</option>
        <option value="recent">Recently added</option>
      </select>
      <input id="search" placeholder="Search vendor/notes/sourceâ€¦" style="padding:.5rem .7rem;border:1px solid #cfcfcf;border-radius:10px;min-width:220px" />
      <button id="applyFilter">Apply</button>
      <span class="kpill">Total: <b id="countAll">0</b></span>
      <span class="kpill">Matched: <b id="countMatched">0</b></span>
      <span class="kpill">Unmatched: <b id="countUnmatched">0</b></span>
      <span class="spacer" style="flex:1 1 auto"></span>
      <button id="matchNowBtn" class="ghost">ðŸ”Ž Match Now (preview)</button>
    </div>
  </div>

  <!-- Table -->
  <div class="card" style="overflow:auto">
    <table id="recTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Vendor</th>
          <th class="right">Total</th>
          <th class="right">Tax</th>
          <th>Category</th>
          <th>Source</th>
          <th>Status</th>
          <th>Notes</th>
          <th>Image</th>
          <th style="min-width:180px">Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr><td colspan="10">
          <div class="row" style="gap:12px;justify-content:flex-end">
            <span class="kpill">Rows: <b id="ftRows">0</b></span>
            <span class="kpill">Subtotal: <b id="ftSubtotal">$0.00</b></span>
            <span class="kpill">Tax: <b id="ftTax">$0.00</b></span>
            <span class="kpill">Total: <b id="ftTotal">$0.00</b></span>
          </div>
        </td></tr>
      </tfoot>
    </table>
  </div>
</main>

<!-- Edit Modal -->
<div id="editBackdrop" class="modal-backdrop">
  <div class="modal">
    <h3>Edit Receipt</h3>
    <p id="editStatus" class="small muted" style="margin-top:-6px"></p>

    <div class="grid-2" style="margin-top:10px">
      <div class="field"><label>Vendor *</label><input id="edVendor"/></div>
      <div class="field"><label>Date *</label><input id="edDate" type="date"/></div>
    </div>
    <div class="grid-3" style="margin-top:10px">
      <div class="field"><label>Total *</label><input id="edTotal" type="number" step="0.01" min="0"/></div>
      <div class="field"><label>Tax *</label><input id="edTax" type="number" step="0.01" min="0"/></div>
      <div class="field"><label>Category *</label><select id="edCategory"></select></div>
    </div>
    <div class="grid-2" style="margin-top:10px">
      <div class="field"><label>Source *</label><select id="edSource"></select></div>
      <div class="field"><label>Replace Image (optional)</label><input id="edFile" type="file" accept="image/*,.pdf"/></div>
    </div>
    <div class="field" style="margin-top:10px"><label>Notes</label><input id="edNotes"/></div>

    <div class="row" style="justify-content:flex-end;margin-top:14px;gap:8px">
      <button id="edCancel" class="ghost">Cancel</button>
      <button id="edSave">Save changes</button>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL = "https://advihqhjjlxumgdlbwui.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkdmlocWhqamx4dW1nZGxid3VpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMTg0MzIsImV4cCI6MjA3NjU5NDQzMn0.kVlaPQg2_o9DGJYv22Dgca7veok4drF6kgLPy2wPBeY";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const $ = id => document.getElementById(id);
const tbody = document.querySelector("#recTable tbody");
let all = [];
let matches = new Map();
let currentEdit = null;

// Locked lists
const CATEGORY_LIST = [
  "Uncategorized","Income","Sales","Refunds",
  "Restaurant (Food & Supplies)","Alcohol","Software","Subscriptions",
  "Travel","Lodging","Fuel","Utilities","Phone/Internet","Office",
  "Professional Fees","Bank Fees","Taxes","Insurance",
  "Repairs & Maintenance","Building Maintenance","Miscellaneous","Other"
];
const SOURCE_LIST = ["CIBC Bank Account","PC MasterCard","Rogers MasterCard","Cash"];

function fillSelect(el, arr, val){
  el.innerHTML = arr.map(c=>`<option value="${c}">${c}</option>`).join("");
  if(val && arr.includes(val)) el.value = val;
}
function money(n){ const v=Number(n)||0; return `$${v.toFixed(2)}`; }
function esc(s){ return String(s??"").replace(/[&<>"]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m])); }

function todayISO(){ const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10); }

// Upload form
$("file").addEventListener("change", e=>{
  const f=e.target.files?.[0];
  $("preview").src = f ? URL.createObjectURL(f) : "";
  $("upMsg").textContent = f ? `Selected: ${f.name}` : "";
});
$("clearBtn").onclick = ()=>{
  $("file").value=""; $("preview").src="";
  ["vendor","total","tax","notes"].forEach(id=>$(id).value="");
  $("rdate").value=todayISO();
  $("tax").value="0.00";
  $("upMsg").textContent="";
  fillSelect($("category"), CATEGORY_LIST);
  fillSelect($("source"), SOURCE_LIST);
};
$("rdate").value = todayISO();
fillSelect($("category"), CATEGORY_LIST);
fillSelect($("source"), SOURCE_LIST);

$("uploadBtn").onclick = async ()=>{
  const f=$("file").files?.[0];
  if(!f){ $("upMsg").textContent="Choose a file first."; return; }

  const data = {
    vendor:$("vendor").value.trim(),
    receipt_date:$("rdate").value,
    total:Number($("total").value||0),
    tax:Number($("tax").value||0),
    category:$("category").value,
    source:$("source").value,
    notes:($("notes").value||"").trim()||null
  };
  if(!data.vendor||!data.receipt_date||!data.category||!data.source || !(data.total>=0) || !(data.tax>=0)){
    $("upMsg").textContent="Please complete all required fields.";
    return;
  }
  if(data.tax>data.total){ $("upMsg").textContent="Tax cannot exceed Total."; return; }

  $("upMsg").textContent="Uploadingâ€¦";
  const fname=`r_${Date.now()}_${(f.name||'img').replace(/[^\w.\-]+/g,'_')}`;
  const { data:upRes, error:upErr }=await sb.storage.from("receipts-warm").upload(fname,f,{contentType:f.type||"image/jpeg"});
  if(upErr){ $("upMsg").textContent=upErr.message; return; }
  const { data:pub }=sb.storage.from("receipts-warm").getPublicUrl(upRes.path);
  data.image_url=pub?.publicUrl||null; data.size_bytes=f.size||0;

  const { error:insErr }=await sb.from("receipts").insert(data);
  if(insErr){ $("upMsg").textContent=insErr.message; return; }
  $("upMsg").textContent="Uploaded.";
  $("clearBtn").click();
  loadReceipts();
};

// Load + render
$("applyFilter").onclick = applyFilters;
$("search").oninput = ()=>{ clearTimeout(window.__t); window.__t=setTimeout(applyFilters,200); };

async function loadReceipts(){
  const { data: recs, error: rErr } = await sb.from("receipts").select("*").order("created_at",{ascending:false});
  if(rErr){ tbody.innerHTML=`<tr><td colspan="10">${esc(rErr.message)}</td></tr>`; return; }
  all = recs||[];

  const { data: mx } = await sb.from("matches").select("receipt_id, transaction_id");
  matches.clear();
  (mx||[]).forEach(m=>{
    const arr=matches.get(m.receipt_id)||[];
    arr.push(m.transaction_id);
    matches.set(m.receipt_id,arr);
  });

  applyFilters();
}

function applyFilters(){
  const mode=$("filterMode").value;
  const q=($("search").value||"").toLowerCase().trim();
  let rows=all.slice();
  rows=rows.filter(r=>{
    const hasMatch=matches.has(r.id);
    if(mode==="matched") return hasMatch;
    if(mode==="unmatched") return !hasMatch;
    return true;
  });
  if(q) rows=rows.filter(r=>(r.vendor||"").toLowerCase().includes(q)||(r.notes||"").toLowerCase().includes(q)||(r.source||"").toLowerCase().includes(q));
  render(rows);
}

function render(rows){
  $("countAll").textContent=all.length;
  let m=0; all.forEach(r=>{if(matches.has(r.id))m++;});
  $("countMatched").textContent=m; $("countUnmatched").textContent=all.length-m;

  if(!rows.length){tbody.innerHTML=`<tr><td colspan="10">No receipts.</td></tr>`; $("ftRows").textContent=0; $("ftSubtotal").textContent="$0.00"; $("ftTax").textContent="$0.00"; $("ftTotal").textContent="$0.00"; return;}

  let subtotal=0,taxSum=0,totalSum=0;
  tbody.innerHTML=rows.map(r=>{
    subtotal+=Number(r.total||0)-Number(r.tax||0);
    taxSum+=Number(r.tax||0);
    totalSum+=Number(r.total||0);
    const status=matches.has(r.id)?`<span class="badge ok">Matched</span>`:`<span class="badge muted">Unmatched</span>`;
    const img=r.image_url?`<a class="badge" href="${esc(r.image_url)}" target="_blank" rel="noopener">Open</a>`:"â€”";
    const editBtn = `<button class="ghost" onclick="openEdit('${r.id}')">Edit</button>`;
    const delBtn  = `<button class="ghost admin-only" onclick="deleteReceipt('${r.id}')">Delete</button>`;
    return `<tr data-id="${r.id}">
      <td>${esc((r.receipt_date||"").slice(0,10))}</td>
      <td>${esc(r.vendor||"")}</td>
      <td class="right">${money(r.total||0)}</td>
      <td class="right">${money(r.tax||0)}</td>
      <td>${esc(r.category||"")}</td>
      <td>${esc(r.source||"")}</td>
      <td>${status}</td>
      <td>${esc(r.notes||"")}</td>
      <td>${img}</td>
      <td><div class="row-actions">${editBtn}${delBtn}</div></td>
    </tr>`;
  }).join("");

  $("ftRows").textContent=rows.length; $("ftSubtotal").textContent=money(subtotal); $("ftTax").textContent=money(taxSum); $("ftTotal").textContent=money(totalSum);
}

// Edit / Delete
async function openEdit(id){
  const { data: r, error } = await sb.from("receipts").select("*").eq("id", id).single();
  if(error||!r){ alert(error?.message||"Receipt not found"); return; }
  currentEdit = r;
  $("editStatus").textContent = r.image_url ? "Current image attached." : "No image attached.";
  $("edVendor").value = r.vendor||"";
  $("edDate").value = (r.receipt_date||"").slice(0,10) || todayISO();
  $("edTotal").value = Number(r.total||0).toFixed(2);
  $("edTax").value   = Number(r.tax||0).toFixed(2);
  $("edNotes").value = r.notes||"";
  fillSelect($("edCategory"), CATEGORY_LIST, r.category||"Uncategorized");
  fillSelect($("edSource"), SOURCE_LIST, r.source||SOURCE_LIST[0]);
  $("edFile").value = "";
  $("editBackdrop").style.display="flex";
}
$("edCancel").onclick = ()=>{ $("editBackdrop").style.display="none"; currentEdit=null; };

$("edSave").onclick = async ()=>{
  if(!currentEdit) return;
  const patch = {
    vendor: $("edVendor").value.trim(),
    receipt_date: $("edDate").value,
    total: Number($("edTotal").value||0),
    tax: Number($("edTax").value||0),
    category: $("edCategory").value,
    source: $("edSource").value,
    notes: ($("edNotes").value||"").trim() || null
  };
  if(!patch.vendor || !patch.receipt_date || !(patch.total>=0) || !(patch.tax>=0) || !patch.category || !patch.source){
    alert("Please complete all required fields."); return;
  }
  if(patch.tax>patch.total){ alert("Tax cannot exceed Total."); return; }

  const f = $("edFile").files?.[0];
  if(f){
    $("editStatus").textContent="Uploading new imageâ€¦";
    const fname=`r_${Date.now()}_${(f.name||'img').replace(/[^\w.\-]+/g,'_')}`;
    const { data:upRes, error:upErr }=await sb.storage.from("receipts-warm").upload(fname,f,{contentType:f.type||"image/jpeg"});
    if(upErr){ alert(upErr.message); return; }
    const { data:pub }=sb.storage.from("receipts-warm").getPublicUrl(upRes.path);
    patch.image_url = pub?.publicUrl || null;
    patch.size_bytes = f.size || 0;
  }

  $("editStatus").textContent="Savingâ€¦";
  const { error } = await sb.from("receipts").update(patch).eq("id", currentEdit.id);
  if(error){ $("editStatus").textContent=""; alert(error.message); return; }

  $("editStatus").textContent="Saved.";
  setTimeout(()=>{ $("editBackdrop").style.display="none"; currentEdit=null; }, 300);
  loadReceipts();
};

async function deleteReceipt(id){
  if(!confirm("Delete this receipt?")) return;
  const { error } = await sb.from("receipts").delete().eq("id", id);
  if(error){ alert(error.message); return; }
  loadReceipts();
}

// â€œMatch nowâ€ shortcut: just navigates to the saved SQL in Studio (preview)
// (Keep using your saved â€œMatch Now (1-tap)â€ in Studio for bulk auto-match.)
$("matchNowBtn").onclick = ()=>{ alert("Use the saved SQL 'Match Now (1-tap)' in Supabase Studio for bulk matching. This page focuses on upload/edit/delete."); };

// Init
loadReceipts();
</script>

<!-- Role/Session Guard (hides admin-only buttons if not admin) -->
<script src="roles.js"></script>
</body>
</html>
