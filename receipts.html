<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Kosmos Bookkeeping â€” Receipts</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root{--bg:#fafafa;--card:#fff;--border:#e5e7eb;--muted:#6b7280;--ok:#0a7a33;--err:#b00020;--ink:#111;--btn:#111;--btnH:#333;}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:var(--ink);}
    header{background:#fff;border-bottom:1px solid var(--border);padding:14px 24px;display:flex;justify-content:space-between;align-items:center;}
    header h1{font-size:1.2rem;margin:0;}
    nav a{margin-left:16px;color:var(--ink);text-decoration:none;font-weight:500;padding:6px 10px;border-radius:8px;}
    nav a:hover,nav a.active{background:#111;color:#fff;}
    main{padding:32px;max-width:1100px;margin:auto;}
    h2{margin-top:0}
    .grid{display:grid;grid-template-columns:520px 1fr;gap:24px;align-items:start;}
    @media (max-width:1100px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;margin-top:20px;}
    label{display:block;margin-top:.7rem;font-weight:600;}
    input{width:100%;padding:.6rem .7rem;border:1px solid #cfcfcf;border-radius:10px;margin-top:.35rem;background:#fff;}
    input[readonly]{background:#f7f7f7;}
    button{padding:.6rem 1rem;border-radius:10px;border:1px solid #bbb;background:var(--btn);color:#fff;cursor:pointer;}
    button:hover{background:var(--btnH);}
    .secondary{background:#f7f7f7;color:#111;border-color:#d0d0d0;}
    .secondary:hover{background:#eee;}
    .rowbtns{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;align-items:center;}
    table{width:100%;border-collapse:collapse;font-size:14px;}
    th,td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:left;}
    th{background:#f6f7f8;position:sticky;top:0;z-index:1;}
    .right{text-align:right;}
    .muted{color:var(--muted)} .ok{color:var(--ok)} .err{color:var(--err)}
    .chip{font-size:12px;background:#eef2ff;border:1px solid #c7d2fe;padding:2px 6px;border-radius:999px;}
    small.muted{color:var(--muted);display:block;margin-top:.25rem;}
  </style>
</head>
<body>
<header>
  <h1>ðŸ“¸ Kosmos Bookkeeping</h1>
  <nav>
    <a href="index.html">Dashboard</a>
    <a href="receipts.html" class="active">Receipts</a>
    <a href="transactions.html">Transactions</a>
    <a href="reports.html">Reports</a>
  </nav>
</header>

<main>
  <h2>Receipt Upload & Scanner</h2>
  <p class="muted">Upload â†’ Scan with AI â†’ review â†’ save to <code>public.receipts</code>.</p>

  <div class="grid">
    <div>
      <!-- Upload + Scan -->
      <div class="card">
        <h3>Upload & Scan</h3>
        <small class="muted">Weâ€™ll upload the file to <code>receipts-warm</code> to get a URL, then call your Edge Function for OCR.</small>
        <div class="rowbtns">
          <input type="file" id="fileInput" accept="image/*,.pdf"/>
          <button id="scanBtn" class="secondary" title="OCR with Mindee via Edge Function">Scan with AI</button>
        </div>

        <label>Vendor<input id="vendor" placeholder="e.g., Sysco, Costco"/></label>
        <label>Date<input id="rdate" type="date"/></label>
        <label>Total<input id="total" type="number" step="0.01"/></label>
        <label>Tax<input id="tax" type="number" step="0.01"/></label>
        <label>Subtotal (auto)<input id="subtotal" type="number" step="0.01" readonly/></label>
        <label>Category<input id="category" placeholder="Category"/></label>
        <label>Source<input id="source" placeholder="Bank/Card"/></label>
        <label>Notes<input id="notes" placeholder="optional"/></label>

        <div class="rowbtns">
          <button id="uploadBtn">Upload & Save</button>
        </div>
        <p id="msg" class="muted"></p>
      </div>

      <!-- Automation -->
      <div class="card">
        <h3>Automation</h3>
        <div class="rowbtns">
          <button id="btnApply" class="secondary">Apply Rules</button>
          <select id="matchMode">
            <option value="strict" selected>Strict</option>
            <option value="fuzzy">Fuzzy</option>
          </select>
          <button id="btnMatch" class="secondary">Match</button>
          <button id="exportBtn">Export Accountant CSV</button>
        </div>
        <p id="autoMsg" class="muted"></p>
      </div>
    </div>

    <!-- Unmatched -->
    <div class="card">
      <h3>Unmatched Receipts</h3>
      <div style="max-height:540px;overflow:auto;margin-top:8px;">
        <table id="unmatchedTable">
          <thead>
            <tr>
              <th>Date</th><th>Vendor</th><th class="right">Total</th><th class="right">Tax</th><th>Category</th><th>Source</th><th>Image</th>
            </tr>
          </thead>
          <tbody><tr><td colspan="7" class="muted">Loadingâ€¦</td></tr></tbody>
        </table>
      </div>
      <button id="refreshBtn" class="secondary" style="margin-top:8px;">Refresh</button>
    </div>
  </div>
</main>

<script>
  // --- Supabase client ---
  const SUPABASE_URL="https://advihqhjjlxumgdlbwui.supabase.co";
  const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkdmlocWhqamx4dW1nZGxid3VpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMTg0MzIsImV4cCI6MjA3NjU5NDQzMn0.kVlaPQg2_o9DGJYv22Dgca7veok4drF6kgLPy2wPBeY";
  const sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
  const BUCKET="receipts-warm";

  const qs=id=>document.getElementById(id);
  const msgEl=qs("msg"), autoMsg=qs("autoMsg");

  function to2(n){ if(n===null||n===undefined||n==="") return ""; const v=Number(n); return Number.isNaN(v)?"":v.toFixed(2); }
  function updateSubtotalPreview(){ const t=parseFloat(qs("total").value)||0; const x=parseFloat(qs("tax").value)||0; qs("subtotal").value=(t-x).toFixed(2); }
  qs("total").addEventListener("input",updateSubtotalPreview);
  qs("tax").addEventListener("input",updateSubtotalPreview);

  // --- Unmatched table loader ---
  async function loadUnmatched(){
    const tbody=qs("unmatchedTable").querySelector("tbody");
    tbody.innerHTML=`<tr><td colspan="7">Loadingâ€¦</td></tr>`;
    const {data,error}=await sb.from("v_unmatched_receipts")
      .select("receipt_date,vendor,total,tax,category,source,image_url,created_at")
      .order("created_at",{ascending:false}).limit(25);
    if(error){ tbody.innerHTML = `<tr><td colspan="7" class="err">${error.message}</td></tr>`; return; }
    if(!data?.length){ tbody.innerHTML = `<tr><td colspan="7" class="muted">All caught upâ€”no unmatched receipts.</td></tr>`; return; }
    tbody.innerHTML = data.map(r=>{
      const tot = typeof r.total==="number" ? r.total.toFixed(2) : (r.total ?? "");
      const tax = typeof r.tax==="number" ? r.tax.toFixed(2)   : (r.tax ?? "");
      const img = r.image_url ? `<a href="${r.image_url}" target="_blank" class="chip">open</a>` : "";
      return `<tr><td>${r.receipt_date??""}</td><td>${r.vendor??""}</td><td class="right">$${tot}</td><td class="right">$${tax}</td><td>${r.category??""}</td><td>${r.source??""}</td><td>${img}</td></tr>`
    }).join("");
  }
  qs("refreshBtn").addEventListener("click",loadUnmatched);

  // --- Scan: upload to storage, then call /scan with { url } ---
  async function scanReceipt(){
    msgEl.className="muted"; msgEl.textContent="Uploading & scanningâ€¦";
    const file=qs("fileInput").files?.[0];
    if(!file){ msgEl.className="err"; msgEl.textContent="Pick a file first."; return; }
    try{
      // 1) upload to Storage (public bucket)
      const path=`scan-${Date.now()}-${file.name}`;
      const { error: upErr } = await sb.storage.from(BUCKET).upload(path, file, { contentType:file.type||"application/octet-stream", upsert:false });
      if(upErr) throw new Error("Upload failed: "+upErr.message);

      // 2) get public URL
      const { data: pub } = sb.storage.from(BUCKET).getPublicUrl(path);
      const publicUrl = pub?.publicUrl;
      if(!publicUrl) throw new Error("Missing public URL from storage.");

      // 3) call Edge Function (works whether Verify JWT is off or on)
      const res = await fetch(`${SUPABASE_URL}/functions/v1/smart-handler?route=scan`, {
        method: "POST",
        headers: {
          "content-type":"application/json",
          "authorization": `Bearer ${SUPABASE_KEY}`  // safe: anon key is public
        },
        body: JSON.stringify({ url: publicUrl })
      });
      if(!res.ok){ throw new Error(await res.text()); }
      const out = await res.json();

      if(out?.ok){
        // Pre-fill fields (no auto-save)
        if(out.vendor) qs("vendor").value = out.vendor;
        if(out.date) qs("rdate").value = out.date;
        if(typeof out.total === "number") qs("total").value = to2(out.total);
        if(typeof out.tax === "number") qs("tax").value = to2(out.tax);
        updateSubtotalPreview();
        msgEl.className="ok";
        msgEl.textContent=`Scanned successfully â€” confidence ${(out.confidence*100||0).toFixed(0)}%. Review & save.`;
      } else {
        msgEl.className="err";
        msgEl.textContent = out?.error || "Scan returned no fields.";
      }
    }catch(e){
      msgEl.className="err"; msgEl.textContent = "Scan failed: " + (e?.message || e);
    }
  }
  qs("scanBtn").addEventListener("click", scanReceipt);

  // --- Upload & Save (manual confirm) ---
  qs("uploadBtn").addEventListener("click", async ()=>{
    msgEl.className="muted"; msgEl.textContent="Uploadingâ€¦";
    const file=qs("fileInput").files?.[0];
    if(!file){ msgEl.className="err"; msgEl.textContent="Pick a file first."; return; }

    // Upload the original file to keep a permanent copy
    const path=`${Date.now()}-${file.name}`;
    const { error: upErr } = await sb.storage.from(BUCKET).upload(path, file, { contentType:file.type||"application/octet-stream", upsert:false });
    if(upErr){ msgEl.className="err"; msgEl.textContent="Storage error: "+upErr.message; return; }
    const { data: pub } = sb.storage.from(BUCKET).getPublicUrl(path);
    const publicUrl = pub?.publicUrl;

    const payload = {
      image_url: publicUrl,
      vendor: qs("vendor").value || null,
      receipt_date: qs("rdate").value || null,
      total: qs("total").value ? Number(qs("total").value) : null,
      tax: qs("tax").value ? Number(qs("tax").value) : 0,
      category: qs("category").value || null,
      source: qs("source").value || null,
      notes: qs("notes").value || null
    };

    const { error } = await sb.from("receipts").insert([payload]);
    if(error){ msgEl.className="err"; msgEl.textContent="DB error: " + error.message; return; }

    msgEl.className="ok"; msgEl.textContent="Uploaded & saved.";
    qs("fileInput").value="";
    // Clear fields after save (optional)
    // ["vendor","rdate","total","tax","subtotal","category","source","notes"].forEach(id=>qs(id).value="");
    await loadUnmatched();
  });

  // --- Automation buttons ---
  qs("btnApply").addEventListener("click", async ()=>{
    autoMsg.className="muted"; autoMsg.textContent="Applying rulesâ€¦";
    const { error } = await sb.rpc("apply_rules");
    if(error){ autoMsg.className="err"; autoMsg.textContent=error.message; return; }
    autoMsg.className="ok"; autoMsg.textContent="Rules applied.";
    loadUnmatched();
  });

  qs("btnMatch").addEventListener("click", async ()=>{
    autoMsg.className="muted"; autoMsg.textContent="Matchingâ€¦";
    const fn = qs("matchMode").value === "fuzzy" ? "match_now_fuzzy" : "match_now";
    const { error } = await sb.rpc(fn);
    if(error){ autoMsg.className="err"; autoMsg.textContent=error.message; return; }
    autoMsg.className="ok"; autoMsg.textContent="Matching complete.";
    loadUnmatched();
  });

  // --- Export accountant CSV (receipts view) ---
  qs("exportBtn").addEventListener("click", async ()=>{
    autoMsg.className="muted"; autoMsg.textContent="Building CSVâ€¦";
    const { data, error } = await sb.from("v_accountant_export_receipts").select("*").order("receipt_date",{ascending:true});
    if(error){ autoMsg.className="err"; autoMsg.textContent = error.message; return; }
    if(!data?.length){ autoMsg.textContent="No data."; return; }

    const cols = ["receipt_date","vendor","category","source","subtotal","tax","total","notes","image_url"];
    const header = cols.join(",");
    const rows = data.map(r => cols.map(k => {
      const v = r[k] ?? "";
      const s = String(v);
      return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    }).join(","));
    const csv = [header, ...rows].join("\n");

    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `accountant_export_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a);
    a.click(); a.remove(); URL.revokeObjectURL(url);

    autoMsg.className="ok"; autoMsg.textContent="CSV downloaded.";
  });

  // init
  loadUnmatched();
</script>
</body>
</html>
