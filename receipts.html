<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kosmos — Receipts Workbench</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js"></script>
  <style>
    :root{--bg:#fafafa;--card:#fff;--ink:#111;--muted:#6b7280;--border:#e5e7eb;--btn:#111;--btnH:#333}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink);margin:24px}
    h1{margin:0 0 10px;font-size:1.6rem}
    .wrap{display:grid;grid-template-columns:520px 1fr;gap:24px;align-items:start}
    @media(max-width:1100px){.wrap{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px}
    label{display:block;margin-top:.7rem;font-weight:600}
    input,select{width:100%;padding:.6rem .7rem;border:1px solid #cfcfcf;border-radius:10px;margin-top:.35rem;background:#fff}
    input[readonly]{background:#f7f7f7}
    button{padding:.6rem 1rem;border-radius:10px;border:1px solid #bbb;background:var(--btn);color:#fff;cursor:pointer}
    button:hover{background:var(--btnH)}
    .secondary{background:#f7f7f7;color:#111;border-color:#d0d0d0}
    .rowbtns{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;align-items:center}
    .muted{color:var(--muted)} .ok{color:#0a7a33} .err{color:#b00020}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:left}
    th{background:#f6f7f8;position:sticky;top:0;z-index:1}
    .right{text-align:right}
    .chip{font-size:12px;background:#eef2ff;border:1px solid #c7d2fe;padding:2px 6px;border-radius:999px}
  </style>
</head>
<body>
  <h1>Receipts Workbench</h1>
  <p><a class="secondary" href="index.html" style="padding:.4rem .7rem;border:1px solid #d0d0d0;border-radius:8px;text-decoration:none;color:#111;background:#f7f7f7">← Back to Home</a></p>

  <div class="wrap">
    <!-- Left column: who + upload + automations -->
    <div>
      <div class="card">
        <h3>Who are you?</h3>
        <small class="muted">Stored on this device; used to set <code>receipts.entered_by</code>.</small>
        <label>Name<input id="who" placeholder="e.g., Eddie / Tairra / Renee"/></label>
        <div class="rowbtns"><button id="saveWho" class="secondary">Save</button><span id="whoMsg" class="muted"></span></div>
      </div>

      <div class="card" style="margin-top:16px;">
        <h3>Upload a receipt</h3>
        <small class="muted">Uploads to <code>receipts-warm</code> then inserts a row in <code>public.receipts</code>.</small>
        <input type="file" id="fileInput" accept="image/*,.pdf" />
        <label>Vendor<input id="vendor" list="vendorList" placeholder="e.g., No Frills, Sysco, Costco"/><datalist id="vendorList"></datalist></label>
        <label>Date<input id="rdate" type="date"/></label>
        <label>Total<input id="total" type="number" step="0.01"/></label>
        <label>Tax<input id="tax" type="number" step="0.01"/></label>
        <label>Subtotal (auto)<input id="subtotal" type="number" step="0.01" readonly/></label>
        <label>Category<input id="category" list="categoryList" placeholder="Pick or type a category…"/><datalist id="categoryList"></datalist></label>
        <label>Source<input id="source" list="sourceList" placeholder="e.g., CIBC Chequing, TD Visa, Cash…"/><datalist id="sourceList"></datalist></label>
        <label>Notes<input id="notes" placeholder="optional"/></label>
        <div class="rowbtns"><button id="uploadBtn">Upload & Save</button><span id="msg" class="muted"></span></div>
      </div>

      <div class="card" style="margin-top:16px;">
        <h3>Automation</h3>
        <small class="muted">Run bookkeeping functions.</small>
        <div class="rowbtns">
          <button id="btnApply" class="secondary">Apply Rules</button>
          <select id="matchMode" aria-label="Match mode" style="width:auto">
            <option value="strict" selected>Strict</option>
            <option value="fuzzy">Fuzzy</option>
          </select>
          <button id="btnMatch" class="secondary">Match</button>
        </div>
        <p id="autoMsg" class="muted"></p>
      </div>
    </div>

    <!-- Right column: unmatched receipts table -->
    <div class="card">
      <h3>Unmatched receipts</h3>
      <small class="muted">From <code>v_unmatched_receipts</code> • newest first</small>
      <div style="max-height:560px;overflow:auto;margin-top:8px;">
        <table id="table">
          <thead><tr>
            <th>Date</th><th>Vendor</th><th class="right">Total</th><th class="right">Tax</th><th>Category</th><th>Source</th><th>Image</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="rowbtns" style="margin-top:8px;"><button id="refresh" class="secondary">Refresh</button><span id="status" class="muted"></span></div>
    </div>
  </div>

  <script>
    // --- Supabase
    const SUPABASE_URL="https://advihqhjjlxumgdlbwui.supabase.co";
    const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkdmlocWhqamx4dW1nZGxid3VpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMTg0MzIsImV4cCI6MjA3NjU5NDQzMn0.kVlaPQg2_o9DGJYv22Dgca7veok4drF6kgLPy2wPBeY";
    const BUCKET="receipts-warm";
    const sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
    const qs=id=>document.getElementById(id);

    // --- Who
    const getWho=()=> (localStorage.getItem("kb_user")||"").trim();
    const setWho=v=> localStorage.setItem("kb_user",(v||"").trim());
    qs("saveWho").onclick=()=>{ const w=qs("who").value.trim(); setWho(w); qs("whoMsg").className=w?"ok":"muted"; qs("whoMsg").textContent=w?`Saved as: ${w}`:"Not set"; };

    // --- Lists
    const PRESET_CATEGORIES=["Food","Alcohol","Restaurant Supplies","Building Supplies","Tools & Equipment","Cleaning Supplies","General Supplies","Gas","Delivery Fees","Utilities","Repairs & Maintenance","Income","Office Supplies","Software","Bank Fees"];
    function uniqueCI(arr){const m=new Map();for(const v of arr){if(!v)continue;const s=String(v).trim();if(!s)continue;const k=s.toLowerCase();if(!m.has(k))m.set(k,s);}return [...m.values()].sort((a,b)=>a.localeCompare(b));}
    function fill(id,vals){ qs(id).innerHTML = vals.map(v=>`<option value="${String(v).replaceAll('"','&quot;')}"></option>`).join(""); }

    async function loadLists(){
      const {data,error}=await sb.from("receipts").select("vendor,source,category").limit(5000);
      let vendors=[],sources=[],cats=[];
      if(!error&&Array.isArray(data)){vendors=uniqueCI(data.map(r=>r.vendor));sources=uniqueCI(data.map(r=>r.source));cats=uniqueCI(data.map(r=>r.category));}
      fill("vendorList",vendors); fill("sourceList",sources); fill("categoryList",uniqueCI([...PRESET_CATEGORIES,...cats]));
    }

    // --- Unmatched table
    async function loadUnmatched(){
      qs("status").textContent="Loading…";
      const tb=qs("table").querySelector("tbody");
      tb.innerHTML=`<tr><td colspan="7">Loading…</td></tr>`;
      const {data,error}=await sb.from("v_unmatched_receipts").select("id,receipt_date,vendor,total,tax,category,source,image_url,created_at").order("created_at",{ascending:false}).limit(100);
      if(error){ tb.innerHTML=`<tr><td colspan="7" class="err">Error: ${error.message}</td></tr>`; qs("status").textContent=""; return; }
      if(!data?.length){ tb.innerHTML=`<tr><td colspan="7" class="muted">All caught up — no unmatched receipts.</td></tr>`; qs("status").textContent=""; return; }
      const rows=data.map(r=>{
        const total=typeof r.total==="number"?r.total.toFixed(2):(r.total??"");
        const tax  =typeof r.tax==="number"?r.tax.toFixed(2):(r.tax??"");
        const img=r.image_url?`<a href="${r.image_url}" target="_blank" class="chip">open</a>`:"";
        return `<tr><td>${r.receipt_date??""}</td><td>${r.vendor??""}</td><td class="right">$${total}</td><td class="right">$${tax}</td><td>${r.category??""}</td><td>${r.source??""}</td><td>${img}</td></tr>`;
      }).join("");
      tb.innerHTML=rows; qs("status").textContent=`Loaded ${data.length} rows.`;
    }

    // --- Subtotal preview
    function updateSubtotal(){ const t=parseFloat(qs("total").value)||0; const x=parseFloat(qs("tax").value)||0; qs("subtotal").value=(t-x).toFixed(2); }
    qs("total").addEventListener("input",updateSubtotal);
    qs("tax").addEventListener("input",updateSubtotal);

    // --- Upload
    qs("uploadBtn").onclick = async ()=>{
      const msg=qs("msg"); msg.className="muted"; msg.textContent="Uploading…";
      const file=qs("fileInput").files?.[0]; if(!file){ msg.className="err"; msg.textContent="Pick a file."; return; }
      const objectPath=`${Date.now()}-${file.name}`;
      const {error:upErr}=await sb.storage.from(BUCKET).upload(objectPath,file,{contentType:file.type||"application/octet-stream",upsert:false});
      if(upErr){ msg.className="err"; msg.textContent="Storage error: "+upErr.message; return; }
      const {data:pub}=sb.storage.from(BUCKET).getPublicUrl(objectPath);
      const publicUrl=pub?.publicUrl;

      const payload={
        image_url: publicUrl,
        vendor: qs("vendor").value || null,
        receipt_date: qs("rdate").value || null,
        total: qs("total").value?Number(qs("total").value):null,
        tax: qs("tax").value?Number(qs("tax").value):0,
        category: qs("category").value || null,
        source: qs("source").value || null,
        notes: qs("notes").value || null,
        entered_by: getWho() || "Unknown"
      };

      const {error:insErr}=await sb.from("receipts").insert([payload]);
      if(insErr){ msg.className="err"; msg.textContent="DB error: "+insErr.message; return; }
      msg.className="ok"; msg.textContent=`Saved (by ${payload.entered_by}).`;
      qs("fileInput").value=""; await loadLists(); await loadUnmatched();
    };

    // --- Automation
    qs("btnApply").onclick = async ()=>{
      const el=qs("autoMsg"); el.className="muted"; el.textContent="Applying rules…";
      const {data,error}=await sb.rpc("apply_rules");
      if(error){ el.className="err"; el.textContent="Error: "+error.message; return; }
      el.className="ok"; el.textContent=`Rules applied. Updated ${typeof data==="number"?data:0} row(s).`;
      await loadUnmatched();
    };

    qs("btnMatch").onclick = async ()=>{
      const el=qs("autoMsg"); el.className="muted"; el.textContent="Matching…";
      const mode=qs("matchMode").value; const fn=mode==="fuzzy"?"match_now_fuzzy":"match_now";
      const {data,error}=await sb.rpc(fn);
      if(error){ el.className="err"; el.textContent=`Error (${mode}): ${error.message}`; return; }
      el.className="ok"; el.textContent=`Matching complete (${mode}). Inserted ${typeof data==="number"?data:0} match(es).`;
      await loadUnmatched();
    };

    // --- Init
    (async function init(){
      qs("who").value=getWho(); qs("whoMsg").textContent=getWho()?`Saved as: ${getWho()}`:"Not set";
      await loadLists(); await loadUnmatched();
    })();

    qs("refresh").onclick=loadUnmatched;
  </script>
</body>
</html>
