<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kosmos ‚Äî Receipts</title>

  <link rel="stylesheet" href="style.css" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    .uploader{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:860px){.uploader{grid-template-columns:1fr}}
    .imgbox{border:1px dashed var(--border);border-radius:14px;background:#fff;padding:14px;text-align:center}
    .imgbox input{width:100%}
    .imgbox img{max-width:100%;height:auto;border-radius:10px;margin-top:10px}
    .mutetip{font-size:.85rem;color:var(--muted)}
    .grid-rec{display:grid;gap:12px}
    @media (min-width:900px){.grid-rec{display:block}}

    .r-cards{display:grid;gap:12px;grid-template-columns:repeat(1,minmax(0,1fr))}
    @media (min-width:520px){.r-cards{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (min-width:900px){.r-cards{display:none}}

    .card-receipt{display:flex;gap:12px;align-items:flex-start}
    .card-receipt img{width:66px;height:66px;object-fit:cover;border-radius:10px;border:1px solid var(--border)}
    .card-receipt .meta{flex:1}
    .card-receipt .meta b{display:block}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--border);font-weight:600;font-size:.82rem}
    .badge.ok{background:#eef9f1;color:var(--ok);border-color:#cfe7d6}
    .badge.muted{background:#f6f7f8;color:var(--muted)}

    td.editable{cursor:text} td.editing{background:#fffbe6}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .spacer{flex:1 1 auto}
    .hl{outline:3px solid var(--brand);box-shadow:0 0 0 4px color-mix(in oklab, var(--brand) 18%, transparent)}
  </style>
</head>
<body>
<header>
  <h1>Kosmos Bookkeeping</h1>
  <nav>
    <a href="index.html">Dashboard</a>
    <a href="receipts.html" class="active">Receipts</a>
    <a href="transactions.html">Transactions</a>
    <a href="reports.html">Reports</a>
  </nav>
</header>

<main class="container">

  <h2>üßæ Receipts</h2>
  <p class="muted">Mobile-friendly upload (tap <b>Choose File</b> to open your camera), reliable manual fields, and match status.</p>

  <!-- Upload Box -->
  <div class="card">
    <div class="uploader">
      <div class="imgbox">
        <input id="file" type="file" accept="image/*,.pdf" capture="environment" />
        <div class="mutetip" style="margin-top:6px">Tip: On mobile this opens your camera. PDFs are allowed too.</div>
        <img id="preview" alt="" />
      </div>

      <div>
        <div class="grid grid-2">
          <div>
            <label>Vendor</label>
            <input id="vendor" placeholder="e.g., NO FRILLS" required />
          </div>
          <div>
            <label>Date</label>
            <input id="rdate" type="date" required />
          </div>
          <div>
            <label>Total</label>
            <input id="total" type="number" step="0.01" placeholder="0.00" required />
          </div>
          <div>
            <label>Tax</label>
            <input id="tax" type="number" step="0.01" value="0.00" required />
          </div>
          <div>
            <label>Category</label>
            <input id="category" placeholder="e.g., Restaurant Supplies" required />
          </div>
          <div>
            <label>Source</label>
            <input id="source" placeholder="e.g., CIBC Chequing" required />
          </div>
        </div>
        <div style="margin-top:8px">
          <label>Notes <span class="muted">(optional)</span></label>
          <input id="notes" placeholder="Any notes‚Ä¶" />
        </div>

        <p id="upMsg" class="muted" style="margin-top:8px"></p>
        <div class="row" style="justify-content:flex-end;margin-top:8px">
          <button id="clearBtn" class="ghost" type="button">Clear</button>
          <button id="uploadBtn" type="button">Upload Receipt</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters/Actions -->
  <div class="card">
    <div class="toolbar">
      <select id="filterMode">
        <option value="all">All</option>
        <option value="unmatched">Unmatched</option>
        <option value="matched">Matched</option>
        <option value="recent">Recently added</option>
      </select>

      <input id="search" placeholder="Search vendor/notes/source‚Ä¶" style="padding:.5rem .7rem;border:1px solid #cfcfcf;border-radius:10px;min-width:220px" />
      <button id="applyFilter" type="button">Apply</button>

      <span class="spacer"></span>
      <button id="deleteSelected" class="ghost" type="button">üóëÔ∏è Delete Selected</button>
    </div>
    <div class="chips" style="margin-top:8px">
      <span class="chip">Total: <b id="countAll">0</b></span>
      <span class="chip">Matched: <b id="countMatched">0</b></span>
      <span class="chip">Unmatched: <b id="countUnmatched">0</b></span>
    </div>
    <p id="status" class="muted" style="margin-top:6px"></p>
  </div>

  <!-- Card list on mobile -->
  <div class="grid-rec">
    <div class="r-cards" id="cards"></div>

    <!-- Table on desktop -->
    <div class="card" style="overflow:auto">
      <table id="recTable">
        <thead>
          <tr>
            <th style="width:40px"><input type="checkbox" id="selectAll" /></th>
            <th style="min-width:110px;">Date</th>
            <th style="min-width:180px;">Vendor</th>
            <th class="right" style="min-width:110px;">Total</th>
            <th class="right" style="min-width:90px;">Tax</th>
            <th style="min-width:140px;">Category</th>
            <th style="min-width:140px;">Source</th>
            <th style="min-width:120px;">Status</th>
            <th style="min-width:220px;">Notes</th>
            <th style="min-width:200px;">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr><td colspan="10">
            <div class="sticky-footer">
              <span class="kpill">Rows: <b id="ftRows">0</b></span>
              <span class="kpill">Subtotal: <b id="ftSubtotal">$0.00</b></span>
              <span class="kpill">Tax: <b id="ftTax">$0.00</b></span>
              <span class="kpill">Total: <b id="ftTotal">$0.00</b></span>
            </div>
          </td></tr>
        </tfoot>
      </table>
    </div>
  </div>
</main>

<script>
/* ===== Supabase setup ===== */
/* Keep your actual URL/anon key here (anon is safe client-side with proper RLS). */
const SUPABASE_URL = "https://advihqhjjlxumgdlbwui.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkdmlocWhqamx4dW1nZGxid3VpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMTg0MzIsImV4cCI6MjA3NjU5NDQzMn0.kVlaPQg2_o9DGJYv22Dgca7veok4drF6kgLPy2wPBeY";
const sb = (window.sb && typeof window.sb.from === "function")
  ? window.sb
  : supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const $ = id => document.getElementById(id);
const tbody = document.querySelector("#recTable tbody");
const cards = $("cards");

let all = [];
let matches = new Map(); // receipt_id -> [transaction_id]
const selected = new Set();

function money(n){ const v=Number(n)||0; return `$${v.toFixed(2)}`; }
function esc(s){ return String(s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
function storagePathFromPublicUrl(url){
  // expects .../object/public/receipts-warm/<path>
  const m = url?.match(/\/object\/public\/receipts-warm\/(.+)$/);
  return m ? m[1] : null;
}

/* ===== Auth / RLS gate ===== */
async function ensureUser(){
  const { data:{ user } } = await sb.auth.getUser();
  if(!user){
    $("status").textContent = "Please sign in first (RLS enabled).";
    throw new Error("not signed in");
  }
  return user;
}

/* ===== Upload form ===== */
$("file").addEventListener("change", e=>{
  const f=e.target.files?.[0];
  $("preview").src = f ? URL.createObjectURL(f) : "";
  $("upMsg").textContent = f ? `Selected: ${f.name}` : "";
});
$("clearBtn").addEventListener("click", ()=>{
  $("file").value=""; $("preview").src="";
  $("vendor").value=""; $("rdate").value=""; $("total").value="";
  $("tax").value="0.00"; $("category").value=""; $("source").value="";
  $("notes").value=""; $("upMsg").textContent="";
});

/* No auto-scanner for now ‚Äî manual & explicit */
$("uploadBtn").addEventListener("click", async ()=>{
  try{ await ensureUser(); }catch{ return; }

  const f=$("file").files?.[0];
  if(!f){ $("upMsg").className="err"; $("upMsg").textContent="Choose a file (camera, photo, or PDF)."; return; }

  const vendor = $("vendor").value.trim() || null;
  const receipt_date = $("rdate").value || null;
  const total = $("total").value ? Number($("total").value) : null;
  const tax = $("tax").value ? Number($("tax").value) : 0;
  const category = $("category").value.trim() || null;
  const source = $("source").value.trim() || null;
  const notes = $("notes").value.trim() || null;

  if(!receipt_date || total===null || !category || !source){
    $("upMsg").className="err";
    $("upMsg").textContent="Date, Total, Category, and Source are required.";
    return;
  }

  $("upMsg").className="muted"; $("upMsg").textContent="Uploading‚Ä¶";
  const fname = `r_${Date.now()}_${(f.name||"file").replace(/[^\w.\-]+/g,"_")}`;
  const { data:upRes, error:upErr } = await sb.storage.from("receipts-warm").upload(
    fname, f, { contentType: f.type || "application/octet-stream" }
  );
  if(upErr){ $("upMsg").className="err"; $("upMsg").textContent=upErr.message; return; }
  const { data:pub } = sb.storage.from("receipts-warm").getPublicUrl(upRes.path);
  const image_url = pub?.publicUrl || null;

  const ins = {
    receipt_date, total, tax, category, vendor, source, notes,
    image_url, size_bytes: f.size||0
  };
  const { data:row, error:insErr } = await sb.from("receipts").insert(ins).select().single();
  if(insErr){ $("upMsg").className="err"; $("upMsg").textContent=insErr.message; return; }

  $("upMsg").className="ok"; $("upMsg").textContent="Uploaded.";
  $("clearBtn").click();
  // Prepend for snappy UX & highlight
  all.unshift(row);
  applyFilters(true);
  const newEl = document.querySelector(`[data-id="${CSS.escape(row.id)}"]`);
  if(newEl){ newEl.classList.add("hl"); newEl.scrollIntoView({behavior:"smooth",block:"center"});
    setTimeout(()=>newEl.classList.remove("hl"),2500);
  }
});

/* ===== Load & render ===== */
async function loadReceipts(){
  const { data: recs, error: rErr } = await sb.from("receipts")
    .select("*")
    .order("receipt_date",{ascending:false})
    .order("created_at",{ascending:false});
  if(rErr){
    tbody.innerHTML = `<tr><td colspan="10" class="err">${esc(rErr.message)}</td></tr>`;
    return;
  }
  all = recs || [];

  const { data: mx } = await sb.from("matches").select("receipt_id, transaction_id");
  matches.clear();
  (mx||[]).forEach(m=>{
    const arr = matches.get(m.receipt_id) || [];
    arr.push(m.transaction_id); matches.set(m.receipt_id, arr);
  });

  applyFilters(true);
}

function applyFilters(resetHighlight=false){
  const mode = $("filterMode").value;
  const q = ($("search").value||"").toLowerCase().trim();

  let rows = all.slice();
  rows = rows.filter(r=>{
    const hasMatch = matches.has(r.id);
    switch(mode){
      case "matched": return hasMatch;
      case "unmatched": return !hasMatch;
      case "recent": return true; // already sorted newest first
      default: return true;
    }
  });
  if(q){
    rows = rows.filter(r =>
      String(r.vendor||"").toLowerCase().includes(q) ||
      String(r.notes||"").toLowerCase().includes(q) ||
      String(r.source||"").toLowerCase().includes(q) ||
      String(r.category||"").toLowerCase().includes(q)
    );
  }
  render(rows, resetHighlight);
}

function render(rows, resetHighlight){
  // counters
  $("countAll").textContent = all.length;
  let m=0; for(const r of all) if(matches.has(r.id)) m++;
  $("countMatched").textContent = m; $("countUnmatched").textContent = all.length - m;

  // table
  if(!rows.length){
    tbody.innerHTML = `<tr><td colspan="10" class="muted">No receipts found.</td></tr>`;
    $("ftRows").textContent="0"; $("ftSubtotal").textContent=money(0); $("ftTax").textContent=money(0); $("ftTotal").textContent=money(0);
  }else{
    let subtotal=0, taxSum=0, totalSum=0;
    const html = rows.map(r=>{
      const status = matches.has(r.id)
        ? `<span class="badge ok">Matched${matches.get(r.id).length>1?` (${matches.get(r.id).length})`:``}</span>`
        : `<span class="badge muted">Unmatched</span>`;
      subtotal += Number(r.total||0) - Number(r.tax||0);
      taxSum   += Number(r.tax||0);
      totalSum += Number(r.total||0);

      const img = r.image_url ? `<img src="${esc(r.image_url)}" style="width:44px;height:44px;object-fit:cover;border-radius:8px;border:1px solid var(--border)" />` : "";

      return `<tr data-id="${r.id}">
        <td><input type="checkbox" class="sel" data-id="${r.id}" ${selected.has(r.id)?"checked":""}/></td>
        <td class="editable" data-field="receipt_date">${esc((r.receipt_date||"").slice(0,10))}</td>
        <td class="editable" data-field="vendor">${esc(r.vendor||"")}</td>
        <td class="right editable" data-field="total">${esc(Number(r.total||0).toFixed(2))}</td>
        <td class="right editable" data-field="tax">${esc(Number(r.tax||0).toFixed(2))}</td>
        <td class="editable" data-field="category">${esc(r.category||"")}</td>
        <td class="editable" data-field="source">${esc(r.source||"")}</td>
        <td>${status}</td>
        <td class="editable" data-field="notes">${esc(r.notes||"")}</td>
        <td>
          ${img}
          <a class="badge" href="${esc(r.image_url||'#')}" target="_blank" rel="noopener" style="margin-left:8px">Open</a>
          <button class="ghost btnDel" data-id="${r.id}">Delete</button>
        </td>
      </tr>`;
    }).join("");
    tbody.innerHTML = html;

    // Editable cells
    Array.from(tbody.querySelectorAll("td.editable")).forEach(td=>{
      const id = td.closest("tr").getAttribute("data-id");
      const field = td.getAttribute("data-field");
      td.addEventListener("click",()=>makeEditable(td,id,field));
    });
    // Selections
    document.querySelectorAll(".sel").forEach(cb=>{
      cb.addEventListener("change",(e)=>{ const id=e.target.getAttribute("data-id"); if(e.target.checked) selected.add(id); else selected.delete(id); });
    });
    // Deletes
    document.querySelectorAll(".btnDel").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id=btn.getAttribute("data-id");
        if(!confirm("Delete this receipt?")) return;
        const row = all.find(r=>r.id===id);
        const spath = storagePathFromPublicUrl(row?.image_url);
        await sb.from("receipts").delete().eq("id",id);
        if(spath) await sb.storage.from("receipts-warm").remove([spath]);
        selected.delete(id); await loadReceipts();
      });
    });

    $("ftRows").textContent=rows.length;
    $("ftSubtotal").textContent=money(subtotal);
    $("ftTax").textContent=money(taxSum);
    $("ftTotal").textContent=money(totalSum);
  }

  // mobile cards
  if(!rows.length){ cards.innerHTML=""; }
  else {
    cards.innerHTML = rows.map(r=>{
      const status = matches.has(r.id)
        ? `<span class="badge ok">Matched</span>`
        : `<span class="badge muted">Unmatched</span>`;
    return `<div class="card card-receipt" data-id="${r.id}">
      <img src="${esc(r.image_url||'')}" alt="">
      <div class="meta">
        <b>${esc(r.vendor||'Unknown Vendor')}</b>
        <div class="muted">${esc((r.receipt_date||'').slice(0,10))} ‚Ä¢ ${money(r.total||0)}</div>
        <div class="muted" style="margin-top:4px">${esc(r.category||'Uncategorized')} ‚Ä¢ ${esc(r.source||'No Source')}</div>
        <div style="margin-top:6px">${status}</div>
      </div>
      <div>
        <button class="ghost btnDel" data-id="${r.id}">Delete</button>
      </div>
    </div>`;
    }).join("");
    cards.querySelectorAll(".btnDel").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id=btn.getAttribute("data-id");
        if(!confirm("Delete this receipt?")) return;
        const row = all.find(r=>r.id===id);
        const spath = storagePathFromPublicUrl(row?.image_url);
        await sb.from("receipts").delete().eq("id",id);
        if(spath) await sb.storage.from("receipts-warm").remove([spath]);
        selected.delete(id); await loadReceipts();
      });
    });
  }

  // Hash highlight after render
  const hid = (location.hash||"").replace("#","");
  if(hid){
    const row = document.querySelector(`[data-id="${CSS.escape(hid)}"]`);
    if(row){ row.classList.add("hl"); row.scrollIntoView({behavior:"smooth", block:"center"});
      setTimeout(()=>row.classList.remove("hl"), 2500);
    }
  }
}

function makeEditable(td, id, field){
  if(td.classList.contains("editing")) return;
  const original = td.textContent.trim();
  td.classList.add("editing");
  const input = document.createElement("input");
  input.type = (field==="receipt_date") ? "date" : "text";
  input.value = (field==="total"||field==="tax") ? String(Number(original||0)) : (field==="receipt_date"?original:original);
  input.style.width="100%"; input.style.padding=".45rem .6rem"; input.style.border="1px solid #cfcfcf"; input.style.borderRadius="8px";
  input.addEventListener("keydown",e=>{ if(e.key==="Enter") input.blur(); if(e.key==="Escape"){ input.value=original; input.blur(); }});
  input.addEventListener("blur", async ()=>{
    let value = input.value.trim();
    if(field==="total"||field==="tax"){ value = value ? Number(value) : 0; }
    if(field==="receipt_date" && value.length>10) value = value.slice(0,10);
    const upd = {}; upd[field]= (field==="total"||field==="tax") ? Number(value||0) : (value||null);
    await sb.from("receipts").update(upd).eq("id",id);
    td.classList.remove("editing");
    td.textContent = (field==="total"||field==="tax") ? Number(value||0).toFixed(2) : (value||"");
  });
  td.innerHTML=""; td.appendChild(input); input.focus(); input.select();
}

/* ===== Actions ===== */
$("applyFilter").addEventListener("click", () => applyFilters());
$("search").addEventListener("input", ()=>{ clearTimeout(window._s); window._s=setTimeout(()=>applyFilters(),180); });

$("selectAll").addEventListener("change", (e)=>{
  if(e.target.checked) all.forEach(r=>selected.add(r.id)); else selected.clear();
  applyFilters();
});

$("deleteSelected").addEventListener("click", async ()=>{
  if(!selected.size) return;
  if(!confirm(`Delete ${selected.size} receipt(s)?`)) return;
  const ids=[...selected]; const chunk=300;
  for(let i=0;i<ids.length;i+=chunk){
    const slice = ids.slice(i,i+chunk);
    const toRemove = all.filter(r=>slice.includes(r.id))
                        .map(r=>storagePathFromPublicUrl(r.image_url))
                        .filter(Boolean);
    await sb.from("receipts").delete().in("id", slice);
    if(toRemove.length) await sb.storage.from("receipts-warm").remove(toRemove);
  }
  selected.clear(); await loadReceipts();
});

/* ===== Init ===== */
(async ()=>{
  try {
    await ensureUser();
    await loadReceipts();
  } catch (e) {
    console.warn(e);
  }
})();
</script>
</body>
</html>
