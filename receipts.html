<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Kosmos Bookkeeping â€” Receipts</title>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <!-- Tesseract (WASM OCR) -->
  <script src="https://unpkg.com/tesseract.js@5.0.3/dist/tesseract.min.js"></script>

  <!-- pdf.js (render PDFs to canvas so Tesseract can read them) -->
  <script src="https://unpkg.com/pdfjs-dist@4.6.82/build/pdf.min.js"></script>
  <script>
    // pdf.js worker (required)
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://unpkg.com/pdfjs-dist@4.6.82/build/pdf.worker.min.js";
  </script>

  <style>
    :root{--bg:#fafafa;--card:#fff;--border:#e5e7eb;--muted:#6b7280;--ok:#0a7a33;--err:#b00020;--ink:#111;--btn:#111;--btnH:#333;}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:var(--ink);}
    header{background:#fff;border-bottom:1px solid var(--border);padding:14px 24px;display:flex;justify-content:space-between;align-items:center;}
    header h1{font-size:1.2rem;margin:0;}
    nav a{margin-left:16px;color:var(--ink);text-decoration:none;font-weight:500;padding:6px 10px;border-radius:8px;}
    nav a:hover,nav a.active{background:#111;color:#fff;}
    main{padding:32px;max-width:1100px;margin:auto;}
    h2{margin-top:0}
    .grid{display:grid;grid-template-columns:520px 1fr;gap:24px;align-items:start;}
    @media (max-width:1100px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;margin-top:20px;}
    label{display:block;margin-top:.7rem;font-weight:600;}
    input{width:100%;padding:.6rem .7rem;border:1px solid #cfcfcf;border-radius:10px;margin-top:.35rem;background:#fff;}
    input[readonly]{background:#f7f7f7;}
    button{padding:.6rem 1rem;border-radius:10px;border:1px solid #bbb;background:var(--btn);color:#fff;cursor:pointer;}
    button:hover{background:var(--btnH);}
    .secondary{background:#f7f7f7;color:#111;border-color:#d0d0d0;}
    .secondary:hover{background:#eee;}
    .rowbtns{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;align-items:center;}
    table{width:100%;border-collapse:collapse;font-size:14px;}
    th,td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:left;}
    th{background:#f6f7f8;position:sticky;top:0;z-index:1;}
    .right{text-align:right;}
    .muted{color:var(--muted)} .ok{color:var(--ok)} .err{color:var(--err)}
    .chip{font-size:12px;background:#eef2ff;border:1px solid #c7d2fe;padding:2px 6px;border-radius:999px;}
    small.muted{color:var(--muted);display:block;margin-top:.25rem;}
    progress{width:100%;}
  </style>
</head>
<body>
<header>
  <h1>ðŸ“¸ Kosmos Bookkeeping</h1>
  <nav>
    <a href="index.html">Dashboard</a>
    <a href="receipts.html" class="active">Receipts</a>
    <a href="transactions.html">Transactions</a>
    <a href="reports.html">Reports</a>
  </nav>
</header>

<main>
  <h2>Receipt Upload & Scanner (Local OCR)</h2>
  <p class="muted">All scanning runs in your browser â€” no paid API. Review the extracted fields, then save to <code>public.receipts</code>.</p>

  <div class="grid">
    <div>
      <!-- Upload + Scan -->
      <div class="card">
        <h3>Upload & Scan</h3>
        <small class="muted">Images or PDFs are processed locally with Tesseract.js. Weâ€™ll pre-fill vendor/date/total/tax for you.</small>
        <div class="rowbtns">
          <input type="file" id="fileInput" accept="image/*,.pdf"/>
          <button id="scanBtn" class="secondary" title="OCR in your browser">Scan with AI (local)</button>
        </div>

        <div id="scanStatus" class="muted" style="margin-top:.5rem;"></div>
        <progress id="scanProgress" max="1" value="0" style="display:none;"></progress>

        <label>Vendor<input id="vendor" placeholder="e.g., Sysco, Costco"/></label>
        <label>Date<input id="rdate" type="date"/></label>
        <label>Total<input id="total" type="number" step="0.01"/></label>
        <label>Tax<input id="tax" type="number" step="0.01"/></label>
        <label>Subtotal (auto)<input id="subtotal" type="number" step="0.01" readonly/></label>
        <label>Category<input id="category" placeholder="Category"/></label>
        <label>Source<input id="source" placeholder="Bank/Card"/></label>
        <label>Notes<input id="notes" placeholder="optional"/></label>

        <div class="rowbtns">
          <button id="uploadBtn">Upload & Save</button>
        </div>
        <p id="msg" class="muted"></p>
      </div>

      <!-- Automation -->
      <div class="card">
        <h3>Automation</h3>
        <div class="rowbtns">
          <button id="btnApply" class="secondary">Apply Rules</button>
          <select id="matchMode">
            <option value="strict" selected>Strict</option>
            <option value="fuzzy">Fuzzy</option>
          </select>
          <button id="btnMatch" class="secondary">Match</button>
          <button id="exportBtn">Export Accountant CSV</button>
        </div>
        <p id="autoMsg" class="muted"></p>
      </div>
    </div>

    <!-- Unmatched -->
    <div class="card">
      <h3>Unmatched Receipts</h3>
      <div style="max-height:540px;overflow:auto;margin-top:8px;">
        <table id="unmatchedTable">
          <thead>
            <tr>
              <th>Date</th><th>Vendor</th><th class="right">Total</th><th class="right">Tax</th><th>Category</th><th>Source</th><th>Image</th>
            </tr>
          </thead>
          <tbody><tr><td colspan="7" class="muted">Loadingâ€¦</td></tr></tbody>
        </table>
      </div>
      <button id="refreshBtn" class="secondary" style="margin-top:8px;">Refresh</button>
    </div>
  </div>
</main>

<script>
  /* ====== Supabase setup ====== */
  const SUPABASE_URL="https://advihqhjjlxumgdlbwui.supabase.co";
  const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkdmlocWhqamx4dW1nZGxid3VpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMTg0MzIsImV4cCI6MjA3NjU5NDQzMn0.kVlaPQg2_o9DGJYv22Dgca7veok4drF6kgLPy2wPBeY";
  const sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
  const BUCKET="receipts-warm";

  const qs=id=>document.getElementById(id);
  const msgEl=qs("msg"), autoMsg=qs("autoMsg");
  const statusEl=qs("scanStatus"), prog=qs("scanProgress");

  function to2(n){ if(n===null||n===undefined||n==="") return ""; const v=Number(n); return Number.isNaN(v)?"":v.toFixed(2); }
  function updateSubtotalPreview(){ const t=parseFloat(qs("total").value)||0; const x=parseFloat(qs("tax").value)||0; qs("subtotal").value=(t-x).toFixed(2); }
  qs("total").addEventListener("input",updateSubtotalPreview);
  qs("tax").addEventListener("input",updateSubtotalPreview);

  /* ====== Unmatched table ====== */
  async function loadUnmatched(){
    const tbody=qs("unmatchedTable").querySelector("tbody");
    tbody.innerHTML=`<tr><td colspan="7">Loadingâ€¦</td></tr>`;
    const {data,error}=await sb.from("v_unmatched_receipts")
      .select("receipt_date,vendor,total,tax,category,source,image_url,created_at")
      .order("created_at",{ascending:false}).limit(25);
    if(error){ tbody.innerHTML = `<tr><td colspan="7" class="err">${error.message}</td></tr>`; return; }
    if(!data?.length){ tbody.innerHTML = `<tr><td colspan="7" class="muted">All caught upâ€”no unmatched receipts.</td></tr>`; return; }
    tbody.innerHTML = data.map(r=>{
      const tot = typeof r.total==="number" ? r.total.toFixed(2) : (r.total ?? "");
      const tax = typeof r.tax==="number" ? r.tax.toFixed(2)   : (r.tax ?? "");
      const img = r.image_url ? `<a href="${r.image_url}" target="_blank" class="chip">open</a>` : "";
      return `<tr><td>${r.receipt_date??""}</td><td>${r.vendor??""}</td><td class="right">$${tot}</td><td class="right">$${tax}</td><td>${r.category??""}</td><td>${r.source??""}</td><td>${img}</td></tr>`
    }).join("");
  }
  qs("refreshBtn").addEventListener("click",loadUnmatched);

  /* ====== PDF â†’ image (first page) ====== */
  async function pdfToImageDataURL(file){
    const ab = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: ab }).promise;
    const page = await pdf.getPage(1);                      // first page
    const scale = 2;                                        // hi-res render
    const viewport = page.getViewport({ scale });
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = viewport.width; canvas.height = viewport.height;
    await page.render({ canvasContext: ctx, viewport }).promise;
    return canvas.toDataURL("image/png", 1.0);
  }

  /* ====== Basic image preprocessing to help OCR ====== */
  function preprocessImage(dataUrl, maxW=1800){
    return new Promise(resolve=>{
      const img = new Image();
      img.onload = () => {
        const scale = Math.min(1, maxW / img.width);
        const w = Math.round(img.width * scale);
        const h = Math.round(img.height * scale);
        const c = document.createElement("canvas");
        c.width = w; c.height = h;
        const g = c.getContext("2d");
        g.drawImage(img, 0, 0, w, h);
        // grayscale + contrast
        const imgData = g.getImageData(0,0,w,h);
        const d = imgData.data;
        for(let i=0;i<d.length;i+=4){
          const r=d[i],g1=d[i+1],b=d[i+2];
          let y = 0.299*r + 0.587*g1 + 0.114*b;  // luminance
          y = (y-128)*1.2 + 128;                 // a touch more contrast
          y = Math.max(0, Math.min(255, y));
          d[i]=d[i+1]=d[i+2]=y;
        }
        g.putImageData(imgData,0,0);
        resolve(c.toDataURL("image/png", 1.0));
      };
      img.src = dataUrl;
    });
  }

  /* ====== OCR with Tesseract ====== */
  async function ocrDataUrl(dataUrl){
    prog.style.display="block"; prog.value=0; statusEl.textContent="Starting OCRâ€¦";
    const worker = await Tesseract.createWorker("eng", 1, {
      logger: m => {
        if(m.status) statusEl.textContent = `${m.status}â€¦`;
        if(m.progress!=null) prog.value = m.progress;
      }
    });
    const { data } = await worker.recognize(dataUrl);
    await worker.terminate();
    prog.style.display="none";
    return data.text || "";
  }

  /* ====== Parse text into fields ====== */
  function findDate(text){
    const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const rx = [
      /\b(\d{4})[-\/\.](\d{2})[-\/\.](\d{2})\b/,       // YYYY-MM-DD
      /\b(\d{2})[-\/\.](\d{2})[-\/\.](\d{4})\b/,       // MM/DD/YYYY or DD/MM/YYYY
      /\b([A-Za-z]{3,9})\s+(\d{1,2}),\s*(\d{4})\b/     // Month DD, YYYY
    ];
    for(const line of lines){
      for(const r of rx){
        const m = line.match(r);
        if(m){
          // normalize
          if(r===rx[0]) return `${m[1]}-${m[2]}-${m[3]}`;
          if(r===rx[1]){
            const a = [m[1],m[2],m[3]].map(s=>s.padStart(2,"0"));
            // assume MM/DD/YYYY; if you prefer DD/MM, swap a[0],a[1]
            return `${m[3]}-${a[0]}-${a[1]}`;
          }
          if(r===rx[2]){
            const months = ["january","february","march","april","may","june","july","august","september","october","november","december"];
            const mm = String(months.indexOf(m[1].toLowerCase())+1).padStart(2,"0");
            const dd = String(m[2]).padStart(2,"0");
            return `${m[3]}-${mm}-${dd}`;
          }
        }
      }
    }
    return null;
  }

  function findAmounts(text){
    const norm = s => s.replace(/[, ]/g,"");
    const lines = text.split(/\r?\n/);
    const candidates = [];
    const rxAmt = /([-+]?\$?\(?\d{1,3}(?:[,\s]\d{3})*(?:\.\d{2})?\)?)/g;
    lines.forEach((line,i)=>{
      const lower = line.toLowerCase();
      const nearTotal = /total|amount due|balance|grand\s*total/.test(lower);
      const nearTax   = /\b(hst|gst|pst|tps|tvq|tax)\b/.test(lower);
      const amts = [...line.matchAll(rxAmt)].map(m=>m[1]);
      for(const a of amts){
        let s = a.trim();
        const neg = /^\(.*\)$/.test(s) || s.startsWith("-");
        s = s.replace(/[\$()\s,]/g,"");
        const v = Number(s);
        if(Number.isFinite(v)){
          candidates.push({ v: Math.abs(v), line:i, nearTotal, nearTax, raw:a });
        }
      }
    });
    // pick tax: first amount near tax keyword
    const tax = candidates.find(c=>c.nearTax)?.v ?? 0;
    // pick total: first amount near total keyword, else the largest number
    let total = candidates.find(c=>c.nearTotal)?.v ?? 0;
    if(!total){
      total = candidates.sort((a,b)=>b.v-a.v)[0]?.v ?? 0;
    }
    return { total: total||null, tax: tax||0 };
  }

  function findVendor(text){
    const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    // Heuristic: top 6 lines without big numeric content
    for(let i=0;i<Math.min(6,lines.length);i++){
      const s = lines[i];
      if(/\d{5,}/.test(s)) continue;       // skip long numeric strings
      if(/(invoice|receipt|sale|store|order|transaction|subtotal|total|tax)/i.test(s)) continue;
      if(s.length >= 3) return s.replace(/\s{2,}/g," ");
    }
    // fallback: first line
    return lines[0] || null;
  }

  function extractFields(text){
    const date = findDate(text);
    const { total, tax } = findAmounts(text);
    const vendor = findVendor(text);
    return { vendor, date, total, tax, rawText: text };
  }

  /* ====== Orchestrate local scan ====== */
  async function localScan(file){
    statusEl.className="muted"; statusEl.textContent="Preparing fileâ€¦";
    let dataUrl = "";
    if(file.type === "application/pdf"){
      dataUrl = await pdfToImageDataURL(file);
    } else {
      dataUrl = URL.createObjectURL(file);
    }
    const pre = await preprocessImage(dataUrl);
    const text = await ocrDataUrl(pre);
    const out = extractFields(text);
    return out;
  }

  /* ====== Hook up buttons ====== */
  qs("scanBtn").addEventListener("click", async ()=>{
    const file=qs("fileInput").files?.[0];
    if(!file){ statusEl.className="err"; statusEl.textContent="Pick a file first."; return; }
    try{
      statusEl.className="muted"; statusEl.textContent="Scanning locallyâ€¦";
      const out = await localScan(file);
      if(out.vendor) qs("vendor").value = out.vendor;
      if(out.date) qs("rdate").value = out.date;
      if(typeof out.total === "number") qs("total").value = to2(out.total);
      if(typeof out.tax === "number") qs("tax").value = to2(out.tax);
      updateSubtotalPreview();
      statusEl.className="ok";
      statusEl.textContent="Scan complete â€” review & save.";
    }catch(e){
      statusEl.className="err"; statusEl.textContent="Scan failed: " + (e?.message || e);
    }
  });

  // Upload to storage & insert row (no OCR here)
  qs("uploadBtn").addEventListener("click", async ()=>{
    msgEl.className="muted"; msgEl.textContent="Uploadingâ€¦";
    const file=qs("fileInput").files?.[0];
    if(!file){ msgEl.className="err"; msgEl.textContent="Pick a file first."; return; }

    const path=`${Date.now()}-${file.name}`;
    const { error: upErr } = await sb.storage.from(BUCKET).upload(path, file, {
      contentType:file.type||"application/octet-stream", upsert:false
    });
    if(upErr){ msgEl.className="err"; msgEl.textContent="Storage error: "+upErr.message; return; }
    const { data: pub } = sb.storage.from(BUCKET).getPublicUrl(path);
    const publicUrl = pub?.publicUrl;

    const payload = {
      image_url: publicUrl,
      vendor: qs("vendor").value || null,
      receipt_date: qs("rdate").value || null,
      total: qs("total").value ? Number(qs("total").value) : null,
      tax: qs("tax").value ? Number(qs("tax").value) : 0,
      category: qs("category").value || null,
      source: qs("source").value || null,
      notes: qs("notes").value || null
    };
    const { error } = await sb.from("receipts").insert([payload]);
    if(error){ msgEl.className="err"; msgEl.textContent="DB error: " + error.message; return; }

    msgEl.className="ok"; msgEl.textContent="Uploaded & saved.";
    qs("fileInput").value="";
    await loadUnmatched();
  });

  // Automation
  qs("btnApply").addEventListener("click", async ()=>{
    autoMsg.className="muted"; autoMsg.textContent="Applying rulesâ€¦";
    const { error } = await sb.rpc("apply_rules");
    if(error){ autoMsg.className="err"; autoMsg.textContent=error.message; return; }
    autoMsg.className="ok"; autoMsg.textContent="Rules applied.";
    loadUnmatched();
  });

  qs("btnMatch").addEventListener("click", async ()=>{
    autoMsg.className="muted"; autoMsg.textContent="Matchingâ€¦";
    const fn = qs("matchMode").value === "fuzzy" ? "match_now_fuzzy" : "match_now";
    const { error } = await sb.rpc(fn);
    if(error){ autoMsg.className="err"; autoMsg.textContent=error.message; return; }
    autoMsg.className="ok"; autoMsg.textContent="Matching complete.";
    loadUnmatched();
  });

  // Export CSV (accountant view)
  qs("exportBtn").addEventListener("click", async ()=>{
    autoMsg.className="muted"; autoMsg.textContent="Building CSVâ€¦";
    const { data, error } = await sb.from("v_accountant_export_receipts").select("*").order("receipt_date",{ascending:true});
    if(error){ autoMsg.className="err"; autoMsg.textContent = error.message; return; }
    if(!data?.length){ autoMsg.textContent="No data."; return; }

    const cols = ["receipt_date","vendor","category","source","subtotal","tax","total","notes","image_url"];
    const header = cols.join(",");
    const rows = data.map(r => cols.map(k => {
      const v = r[k] ?? "";
      const s = String(v);
      return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    }).join(","));
    const csv = [header, ...rows].join("\n");

    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `accountant_export_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a);
    a.click(); a.remove(); URL.revokeObjectURL(url);

    autoMsg.className="ok"; autoMsg.textContent="CSV downloaded.";
  });

  // init
  loadUnmatched();
</script>
</body>
</html>
