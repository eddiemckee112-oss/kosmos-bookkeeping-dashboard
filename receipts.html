<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Kosmos Bookkeeping â€” Receipts</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root{--bg:#fafafa;--card:#fff;--border:#e5e7eb;--muted:#6b7280;
           --ok:#0a7a33;--err:#b00020;--ink:#111;--btn:#111;--btnH:#333;}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
         margin:0;background:var(--bg);color:var(--ink);}
    header{background:#fff;border-bottom:1px solid var(--border);
           padding:14px 24px;display:flex;justify-content:space-between;align-items:center;}
    header h1{font-size:1.2rem;margin:0;}
    nav a{margin-left:16px;color:var(--ink);text-decoration:none;font-weight:500;
           padding:6px 10px;border-radius:8px;}
    nav a:hover,nav a.active{background:#111;color:#fff;}
    main{padding:32px;max-width:900px;margin:auto;}
    h2{margin-top:0;}
    .card{background:var(--card);border:1px solid var(--border);
          border-radius:14px;padding:20px;margin-top:20px;}
    label{display:block;margin-top:.7rem;font-weight:600;}
    input{width:100%;padding:.6rem .7rem;border:1px solid #cfcfcf;
          border-radius:10px;margin-top:.35rem;}
    button{padding:.6rem 1rem;border-radius:10px;border:1px solid #bbb;
            background:var(--btn);color:#fff;cursor:pointer;}
    button:hover{background:var(--btnH);}
    .secondary{background:#f7f7f7;color:#111;border-color:#d0d0d0;}
    .secondary:hover{background:#eee;}
    table{width:100%;border-collapse:collapse;font-size:14px;}
    th,td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:left;}
    th{background:#f6f7f8;}
    .right{text-align:right;}
    .muted{color:var(--muted);} .ok{color:var(--ok);} .err{color:var(--err);}
  </style>
</head>
<body>
<header>
  <h1>ðŸ“¸ Kosmos Bookkeeping</h1>
  <nav>
    <a href="index.html">Dashboard</a>
    <a href="receipts.html" class="active">Receipts</a>
    <a href="transactions.html">Transactions</a>
    <a href="matched.html">Matched</a>
    <a href="reports.html">Reports</a>
  </nav>
</header>

<main>
  <h2>Receipt Upload & Matching</h2>
  <p class="muted">Add new receipts, apply vendor rules, and run matching.</p>

  <!-- upload -->
  <div class="card">
    <h3>Upload Receipt</h3>
    <input type="file" id="fileInput" accept="image/*,.pdf"/>
    <label>Vendor<input id="vendor"/></label>
    <label>Date<input id="rdate" type="date"/></label>
    <label>Total<input id="total" type="number" step="0.01"/></label>
    <label>Tax<input id="tax" type="number" step="0.01"/></label>
    <label>Category<input id="category"/></label>
    <label>Source<input id="source"/></label>
    <label>Notes<input id="notes"/></label>
    <button id="uploadBtn">Upload & Save</button>
    <p id="msg" class="muted"></p>
  </div>

  <!-- automation -->
  <div class="card">
    <h3>Automation</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button id="btnApply" class="secondary">Apply Rules</button>
      <select id="matchMode"><option value="strict" selected>Strict</option><option value="fuzzy">Fuzzy</option></select>
      <button id="btnMatch" class="secondary">Match</button>
    </div>
    <p id="autoMsg" class="muted"></p>
  </div>

  <!-- unmatched -->
  <div class="card">
    <h3>Unmatched Receipts</h3>
    <div style="max-height:400px;overflow:auto;">
      <table id="unmatchedTable">
        <thead><tr><th>Date</th><th>Vendor</th><th class="right">Total</th><th class="right">Tax</th><th>Category</th><th>Source</th></tr></thead>
        <tbody><tr><td colspan="6" class="muted">Loadingâ€¦</td></tr></tbody>
      </table>
    </div>
    <button id="refreshBtn" class="secondary" style="margin-top:8px;">Refresh</button>
  </div>
</main>

<script>
const SUPABASE_URL="https://advihqhjjlxumgdlbwui.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkdmlocWhqamx4dW1nZGxid3VpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMTg0MzIsImV4cCI6MjA3NjU5NDQzMn0.kVlaPQg2_o9DGJYv22Dgca7veok4drF6kgLPy2wPBeY";
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
const qs=id=>document.getElementById(id);
const autoMsg=qs("autoMsg");

async function loadUnmatched(){
  const tbody=qs("unmatchedTable").querySelector("tbody");
  tbody.innerHTML="<tr><td colspan=6>Loadingâ€¦</td></tr>";
  const {data,error}=await sb.from("v_unmatched_receipts").select("*").order("created_at",{ascending:false}).limit(25);
  if(error){tbody.innerHTML=`<tr><td colspan=6 class='err'>${error.message}</td></tr>`;return;}
  if(!data?.length){tbody.innerHTML=`<tr><td colspan=6 class='muted'>All matched.</td></tr>`;return;}
  tbody.innerHTML=data.map(r=>`<tr><td>${r.receipt_date||""}</td><td>${r.vendor||""}</td><td class='right'>$${r.total?.toFixed?.(2)||""}</td><td class='right'>$${r.tax?.toFixed?.(2)||""}</td><td>${r.category||""}</td><td>${r.source||""}</td></tr>`).join("");
}
qs("refreshBtn").addEventListener("click",loadUnmatched);

qs("btnMatch").addEventListener("click",async()=>{
  autoMsg.textContent="Matchingâ€¦";const fn=qs("matchMode").value==="fuzzy"?"match_now_fuzzy":"match_now";
  const {error}=await sb.rpc(fn);
  autoMsg.className=error?"err":"ok";
  autoMsg.textContent=error?error.message:"Matching complete.";
  loadUnmatched();
});

qs("btnApply").addEventListener("click",async()=>{
  autoMsg.textContent="Applying rulesâ€¦";
  const {error}=await sb.rpc("apply_rules");
  autoMsg.className=error?"err":"ok";
  autoMsg.textContent=error?error.message:"Rules applied.";
  loadUnmatched();
});

loadUnmatched();
</script>
</body>
</html>
