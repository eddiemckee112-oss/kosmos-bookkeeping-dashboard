<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kosmos ‚Äî Receipts</title>

  <link rel="stylesheet" href="style.css" />
  <script src="config.js"></script> <!-- NEW: AI toggle -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    .uploader{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:860px){.uploader{grid-template-columns:1fr}}
    .imgbox{border:1px dashed var(--border);border-radius:14px;background:#fff;padding:14px;text-align:center}
    .imgbox input{width:100%}
    .imgbox img{max-width:100%;height:auto;border-radius:10px;margin-top:10px}
    .mutetip{font-size:.85rem;color:var(--muted)}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .right{text-align:right}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--border);font-weight:600;font-size:.82rem}
    .badge.ok{background:#eef9f1;color:var(--ok);border-color:#cfe7d6}
    .badge.muted{background:#f6f7f8;color:var(--muted)}
    .kpill{padding:4px 10px;border:1px solid var(--border);border-radius:999px;background:#fff}
    .sticky-footer{display:flex;gap:10px;flex-wrap:wrap}
    .editgrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
    .editgrid .full{grid-column:1/-1}
    .danger{color:#b91c1c}
    .linkbtn{padding:4px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;cursor:pointer}
    .dim{opacity:.65}
  </style>
</head>
<body>
<header>
  <h1>Kosmos Bookkeeping</h1>
  <nav>
    <a href="index.html">Dashboard</a>
    <a href="receipts.html" class="active">Receipts</a>
    <a href="transactions.html">Transactions</a>
    <a href="reports.html">Reports</a>
  </nav>
</header>

<main class="container">
  <h2>üßæ Receipts</h2>
  <p class="muted">Upload, edit, delete, and link receipts. Category/Source fixed. ‚ÄúMatch Now‚Äù opens Transactions linking mode.</p>

  <!-- Upload -->
  <div class="card">
    <div class="uploader">
      <div class="imgbox">
        <input id="file" type="file" accept="image/*,.pdf" capture="environment" />
        <div class="mutetip" style="margin-top:6px">On mobile this opens your camera. PDFs allowed.</div>
        <img id="preview" alt="" />
      </div>

      <div>
        <div class="editgrid">
          <div><label>Vendor</label><input id="vendor" placeholder="e.g., NO FRILLS" required /></div>
          <div><label>Date</label><input id="rdate" type="date" required /></div>
          <div><label>Total</label><input id="total" type="number" step="0.01" placeholder="0.00" required /></div>
          <div><label>Tax</label><input id="tax" type="number" step="0.01" value="0.00" required /></div>
          <div>
            <label>Category</label>
            <select id="category" required></select>
          </div>
          <div>
            <label>Source</label>
            <select id="source" required></select>
          </div>
          <div class="full">
            <label>Notes <span class="muted">(optional)</span></label>
            <input id="notes" placeholder="Any notes‚Ä¶"/>
          </div>
        </div>

        <p id="upMsg" class="muted" style="margin-top:8px"></p>
        <div class="row" style="justify-content:flex-end;margin-top:8px;gap:8px">
          <button id="scanBtn" class="ghost" type="button">ü§ñ Scan with AI</button>
          <button id="clearBtn" class="ghost" type="button">Clear</button>
          <button id="uploadBtn" type="button">Upload Receipt</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters + table -->
  <div class="card">
    <div class="toolbar">
      <select id="filterMode">
        <option value="all">All</option>
        <option value="unmatched">Unmatched</option>
        <option value="matched">Matched</option>
        <option value="recent">Recently added</option>
      </select>
      <input id="search" placeholder="Search vendor/notes/source‚Ä¶" style="padding:.5rem .7rem;border:1px solid #cfcfcf;border-radius:10px;min-width:220px" />
      <button id="applyFilter">Apply</button>
      <span class="spacer"></span>
      <span class="kpill">Total: <b id="countAll">0</b></span>
      <span class="kpill">Matched: <b id="countMatched">0</b></span>
      <span class="kpill">Unmatched: <b id="countUnmatched">0</b></span>
    </div>
    <p id="status" class="muted" style="margin-top:6px"></p>
  </div>

  <div class="card" style="overflow:auto">
    <table id="recTable" style="min-width:1100px">
      <thead>
        <tr>
          <th style="min-width:110px;">Date</th>
          <th style="min-width:180px;">Vendor</th>
          <th class="right" style="min-width:110px;">Total</th>
          <th class="right" style="min-width:90px;">Tax</th>
          <th style="min-width:180px;">Category</th>
          <th style="min-width:160px;">Source</th>
          <th style="min-width:120px;">Status</th>
          <th style="min-width:220px;">Notes</th>
          <th style="min-width:280px;">Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr><td colspan="9">
          <div class="sticky-footer">
            <span class="kpill">Rows: <b id="ftRows">0</b></span>
            <span class="kpill">Subtotal: <b id="ftSubtotal">$0.00</b></span>
            <span class="kpill">Tax: <b id="ftTax">$0.00</b></span>
            <span class="kpill">Total: <b id="ftTotal">$0.00</b></span>
          </div>
        </td></tr>
      </tfoot>
    </table>
  </div>
</main>

<script>
/* ---------- Supabase ---------- */
const sb = supabase.createClient(
  "https://advihqhjjlxumgdlbwui.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkdmlocWhqamx4dW1nZGxid3VpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMTg0MzIsImV4cCI6MjA3NjU5NDQzMn0.kVlaPQg2_o9DGJYv22Dgca7veok4drF6kgLPy2wPBeY"
);

/* ---------- Fixed options ---------- */
const CATEGORIES = [
  "Uncategorized","Income","Bank Fees","Fuel","Utilities","Phone/Internet","Insurance",
  "Professional Fees","Software","Subscriptions","Repairs & Maintenance","Office",
  "Meals & Entertainment","Travel","Lodging","Building Maintenance","Building Miscellaneous",
  "Restaurant (Food & Supplies)","Taxes","Other"
];
const SOURCES = ["CIBC Bank Account","Rogers MasterCard","PC MasterCard","Cash"];

/* ---------- Helpers ---------- */
const $ = id => document.getElementById(id);
const tbody = document.querySelector("#recTable tbody");
let ALL = [];
let MATCHES = new Map();

const money = n => (Number(n)||0).toLocaleString(undefined,{style:'currency',currency:'CAD'});
function esc(s){ return String(s??"").replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }

/* ---------- Populate dropdowns & defaults ---------- */
function initUploadForm(){
  $("category").innerHTML = CATEGORIES.map(c=>`<option value="${esc(c)}">${esc(c)}</option>`).join("");
  $("source").innerHTML   = SOURCES.map(s=>`<option value="${esc(s)}">${esc(s)}</option>`).join("");

  $("category").value = "Uncategorized";
  $("source").value   = SOURCES[0];
  $("rdate").value    = new Date().toISOString().slice(0,10);
}
initUploadForm();

/* ---------- Upload ---------- */
$("file").addEventListener("change", e=>{
  const f=e.target.files?.[0];
  $("preview").src = f ? URL.createObjectURL(f) : "";
  $("upMsg").textContent = f ? `Selected: ${f.name}` : "";
});
$("clearBtn").onclick = ()=>{
  $("file").value=""; $("preview").src="";
  ["vendor","total","tax","notes"].forEach(id=>$(id).value="");
  $("tax").value="0.00"; $("upMsg").textContent="";
  initUploadForm();
};

/* ---------- AI Scan (prefill) ---------- */
(function setupAiButton(){
  const cfg = (window.KOSMOS_CFG||{});
  if (!cfg.AI_MODE || cfg.AI_MODE === "off") {
    $("scanBtn").style.display = "none";
    return;
  }
  $("scanBtn").onclick = async ()=>{
    try{
      const f=$("file").files?.[0];
      if(!f) { $("upMsg").textContent="Choose a file first (so AI can read it)."; return; }

      $("upMsg").textContent="Uploading image for AI‚Ä¶";
      const fname=`r_${Date.now()}_${(f.name||'img').replace(/[^\w.\-]+/g,'_')}`;
      const up = await sb.storage.from("receipts-warm").upload(fname,f,{contentType:f.type||"image/jpeg"});
      if(up.error){ $("upMsg").textContent=up.error.message; return; }
      const imageUrl=`https://advihqhjjlxumgdlbwui.supabase.co/storage/v1/object/public/receipts-warm/${fname}`;

      $("upMsg").textContent="Thinking (AI)‚Ä¶";
      const hints = {
        hint_vendor: $("vendor").value || null,
        hint_amount: Number($("total").value || 0) || null,
        hint_date: $("rdate").value || null,
        source: $("source").value || null
      };

      const aiRes = await fetch(`${location.origin}/functions/v1/ai-suggest`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ image_url: imageUrl, ...hints })
      });
      const payload = await aiRes.json();
      if(!payload?.ok){ $("upMsg").textContent = payload?.error || "AI error."; return; }

      const s = payload.suggestions || {};
      if(s.vendor) $("vendor").value = s.vendor;
      if(s.receipt_date) $("rdate").value = s.receipt_date;
      if(typeof s.total === "number") $("total").value = String(s.total.toFixed(2));
      if(typeof s.tax === "number") $("tax").value = String(s.tax.toFixed(2));
      if(s.category && CATEGORIES.includes(s.category)) $("category").value = s.category;
      if(s.source && SOURCES.includes(s.source)) $("source").value = s.source;

      $("upMsg").textContent = `AI suggestions applied${typeof s.confidence==="number" ? ` (conf ${Math.round(s.confidence*100)}%)` : ""}. Review & Upload.`;
      $("file").dataset.aiUploadedName = fname;
    }catch(e){
      $("upMsg").textContent = e?.message || String(e);
    }
  };
})();
</script>

<script>
/* ---------- Row actions etc. (unchanged) ---------- */
function badge(rec){ return MATCHES.has(rec.id) ? `<span class="badge ok">Matched</span>` : `<span class="badge muted">Unmatched</span>`; }
function actions(rec){
  const open = rec.image_url ? `<a class="linkbtn" href="${esc(rec.image_url)}" target="_blank" rel="noopener">Open</a>` : "";
  const matchBtn = `<button class="linkbtn" data-act="match" data-id="${rec.id}">Match Now</button>`;
  const editBtn  = `<button class="linkbtn" data-act="edit" data-id="${rec.id}">Edit</button>`;
  const delBtn   = `<button class="linkbtn danger" data-act="del" data-id="${rec.id}">Delete</button>`;
  return `${open} ${matchBtn} ${editBtn} ${delBtn}`;
}

function render(rows){
  $("countAll").textContent=ALL.length;
  let m=0; ALL.forEach(r=>{ if(MATCHES.has(r.id)) m++;});
  $("countMatched").textContent=m; $("countUnmatched").textContent=ALL.length-m;

  if(!rows.length){ tbody.innerHTML=`<tr><td colspan="9">No receipts.</td></tr>`; return; }

  let subtotal=0,taxSum=0,totalSum=0;
  tbody.innerHTML = rows.map(r=>{
    subtotal += (+r.total||0) - (+r.tax||0);
    taxSum   += (+r.tax||0);
    totalSum += (+r.total||0);
    return `<tr data-id="${r.id}">
      <td>${esc((r.receipt_date||"").slice(0,10))}</td>
      <td>${esc(r.vendor||"")}</td>
      <td class="right">${money(r.total||0)}</td>
      <td class="right">${money(r.tax||0)}</td>
      <td>${esc(r.category||"")}</td>
      <td>${esc(r.source||"")}</td>
      <td>${badge(r)}</td>
      <td>${esc(r.notes||"")}</td>
      <td>${actions(r)}</td>
    </tr>`;
  }).join("");

  $("ftRows").textContent=rows.length;
  $("ftSubtotal").textContent=money(subtotal);
  $("ftTax").textContent=money(taxSum);
  $("ftTotal").textContent=money(totalSum);

  tbody.querySelectorAll("button[data-act]").forEach(btn=>{
    const id=btn.getAttribute("data-id");
    const act=btn.getAttribute("data-act");

    if(act==="del"){
      btn.onclick = async ()=>{
        if(!confirm("Delete this receipt?")) return;
        await sb.from("matches").delete().eq("receipt_id", id);
        await sb.from("receipts").delete().eq("id", id);
        loadReceipts();
      };
    } else if(act==="edit"){
      btn.onclick = ()=> openEdit(id);
    } else if(act==="match"){
      btn.onclick = ()=>{
        sessionStorage.setItem('linkReceipt', id);
        location.href = 'transactions.html?linkReceipt=' + encodeURIComponent(id);
      };
    }
  });
}

$("applyFilter").onclick = applyFilters;
$("search").oninput = ()=>{ clearTimeout(window.__t); window.__t=setTimeout(applyFilters,200); };
function applyFilters(){
  const mode=$("filterMode").value;
  const q = ($("search").value||"").toLowerCase().trim();
  let rows = ALL.slice();
  rows = rows.filter(r=>{
    const hasMatch = MATCHES.has(r.id);
    if(mode==="matched") return hasMatch;
    if(mode==="unmatched") return !hasMatch;
    return true;
  });
  if(q){
    rows = rows.filter(r =>
      (r.vendor||"").toLowerCase().includes(q) ||
      (r.notes||"").toLowerCase().includes(q) ||
      (r.source||"").toLowerCase().includes(q)
    );
  }
  render(rows);
}

async function openEdit(id){
  const rec = ALL.find(r=>r.id===id); if(!rec) return;

  const vendor = prompt("Vendor", rec.vendor||""); if(vendor===null) return;
  const date   = prompt("Date (YYYY-MM-DD)", (rec.receipt_date||"").slice(0,10)); if(date===null) return;

  const totalStr  = prompt("Total", String(rec.total||0)); if(totalStr===null) return;
  const taxStr    = prompt("Tax", String(rec.tax||0)); if(taxStr===null) return;

  const cat = prompt(`Category (choose one exactly):\n${CATEGORIES.join(", ")}`, rec.category||"");
  if(cat===null) return;
  if(!CATEGORIES.includes(cat)) return alert("Category must be one of the fixed options.");

  const src = prompt(`Source (choose one exactly):\n${SOURCES.join(", ")}`, rec.source||"");
  if(src===null) return;
  if(!SOURCES.includes(src)) return alert("Source must be one of the fixed options.");

  const notes  = prompt("Notes", rec.notes||""); if(notes===null) return;

  const upd = {
    vendor: vendor.trim(),
    receipt_date: date,
    total: Number(totalStr)||0,
    tax: Number(taxStr)||0,
    category: cat,
    source: src,
    notes: notes.trim()
  };
  const { error } = await sb.from("receipts").update(upd).eq("id", id);
  if(error){ alert(error.message); return; }
  await loadReceipts();
}

/* ---------- Data load ---------- */
async function loadReceipts(){
  const { data: recs, error: rErr } = await sb.from("receipts")
    .select("id, receipt_date, total, tax, category, vendor, source, notes, image_url, created_at")
    .order("created_at",{ascending:false});
  if(rErr){ tbody.innerHTML=`<tr><td colspan="9">${rErr.message}</td></tr>`; return; }
  ALL = recs||[];

  const { data: mx } = await sb.from("matches").select("receipt_id, transaction_id");
  MATCHES.clear(); (mx||[]).forEach(m=>{
    const arr = MATCHES.get(m.receipt_id)||[];
    arr.push(m.transaction_id);
    MATCHES.set(m.receipt_id, arr);
  });

  applyFilters();
}
loadReceipts();
</script>
<script src="roles.js"></script>

<!-- ====== ADD: Tiny floating chat (calls your ai-chat Edge Function) ====== -->
<style>
  #kosmos-chat-btn{position:fixed;right:18px;bottom:18px;border:none;border-radius:999px;padding:12px 14px;box-shadow:0 6px 24px rgba(0,0,0,.15);background:#111;color:#fff;cursor:pointer;z-index:9999}
  #kosmos-chat{position:fixed;right:18px;bottom:70px;width:340px;max-width:90vw;height:480px;background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 12px 40px rgba(0,0,0,.18);display:none;flex-direction:column;overflow:hidden;z-index:9999}
  #kc-head{padding:10px 12px;border-bottom:1px solid #eee;font-weight:600}
  #kc-log{flex:1;overflow:auto;padding:12px;font-size:14px;line-height:1.45;background:#fafafa;display:flex;flex-direction:column}
  #kc-log .me{align-self:flex-end;background:#e9f5ff;border-radius:10px;padding:8px 10px;margin:6px 0;max-width:85%}
  #kc-log .ai{align-self:flex-start;background:#fff;border:1px solid #eee;border-radius:10px;padding:8px 10px;margin:6px 0;max-width:85%}
  #kc-row{display:flex;gap:8px;padding:10px;border-top:1px solid #eee;background:#fff}
  #kc-row input{flex:1;border:1px solid #ddd;border-radius:10px;padding:10px}
</style>

<button id="kosmos-chat-btn">üí¨ Chat</button>
<div id="kosmos-chat">
  <div id="kc-head">Kosmos AI</div>
  <div id="kc-log"></div>
  <div id="kc-row">
    <input id="kc-input" placeholder="Ask about receipts, transactions‚Ä¶"/>
    <button id="kc-send">Send</button>
  </div>
</div>

<script>
(function(){
  const ENDPOINT = "https://advihqhjjlxumgdlbwui.supabase.co/functions/v1/ai-chat";
  const ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkdmlocWhqamx4dW1nZGxid3VpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMTg0MzIsImV4cCI6MjA3NjU5NDQzMn0.kVlaPQg2_o9DGJYv22Dgca7veok4drF6kgLPy2wPBeY";

  const btn=document.getElementById("kosmos-chat-btn");
  const box=document.getElementById("kosmos-chat");
  const log=document.getElementById("kc-log");
  const input=document.getElementById("kc-input");
  const send=document.getElementById("kc-send");

  btn.onclick=()=>{ box.style.display = box.style.display==="flex"?"none":"flex"; if(box.style.display==="flex") box.style.display="flex"; };

  const history = JSON.parse(localStorage.getItem("kosmos_chat_history")||"[]");
  const push = (role, content)=>{ history.push({role, content}); localStorage.setItem("kosmos_chat_history", JSON.stringify(history)); render(); }
  const esc = s => String(s||"").replace(/[&<>]/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;" }[m]));
  function render(){
    log.innerHTML="";
    history.forEach(m=>{
      const div=document.createElement("div");
      div.className = m.role==="user"?"me":"ai";
      div.innerHTML = esc(m.content);
      log.appendChild(div);
    });
    log.scrollTop = log.scrollHeight;
  }
  render();
  if(history.length===0){ push("assistant","Hey! I‚Äôm your Kosmos AI. Ask me to match receipts, check vendors, or explain a transaction."); }

  async function talk(q){
    push("user", q);
    input.value="";
    try{
      const res = await fetch(ENDPOINT,{
        method:"POST",
        headers:{ "Authorization":"Bearer "+ANON_KEY, "Content-Type":"application/json" },
        body: JSON.stringify({ messages: history })
      });
      const data = await res.json().catch(()=>({}));
      const reply = (data && (data.reply || data.raw?.choices?.[0]?.message?.content)) || "No reply.";
      push("assistant", reply);
    }catch(e){ push("assistant","(Error) "+(e?.message||e)); }
  }
  send.onclick = ()=> input.value.trim() && talk(input.value.trim());
  input.addEventListener("keydown",e=>{ if(e.key==="Enter" && input.value.trim()) talk(input.value.trim()); });
})();
</script>
<!-- ====== /floating chat ====== -->
</body>
</html>
