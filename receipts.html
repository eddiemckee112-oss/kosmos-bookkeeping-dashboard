<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Kosmos â€” Receipts</title>

  <!-- Shared theme -->
  <link rel="stylesheet" href="style.css"/>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <!-- Tesseract (local OCR) -->
  <script src="https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    /* page-local tweaks */
    .two-col{ display:grid; grid-template-columns: 1.2fr .8fr; gap:16px; }
    @media (max-width: 960px){ .two-col{ grid-template-columns:1fr; } }
    .drop {
      border:2px dashed var(--border); border-radius:14px; padding:16px; text-align:center;
      background:#fff;
    }
    .drop.drag{ background:#f6faff; border-color:#bcd4ff; }
    .chip{ display:inline-block; border:1px solid var(--border); border-radius:999px; padding:3px 8px; margin-left:6px; font-size:.8rem; }
    .chip.ok{ border-color:#c7f0d7; background:#e9fbf0; }
    .chip.warn{ border-color:#ffe59a; background:#fff8d8; }
    .chip.bad{ border-color:#ffc0c0; background:#fff0f0; }
    .advanced { margin-top:8px; }
    .advanced summary { cursor:pointer; font-weight:700; }
    canvas { max-width:100%; border:1px solid var(--border); border-radius:10px; background:#fff }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <h1>Kosmos Bookkeeping</h1>
    <nav>
      <a href="index.html">Dashboard</a>
      <a href="receipts.html" class="active">Receipts</a>
      <a href="transactions.html">Transactions</a>
      <a href="reports.html">Reports</a>
    </nav>
  </header>

  <main class="container">
    <h2>ðŸ§¾ Receipts Scanner</h2>
    <p class="muted">Scan locally with Tesseract (no paid API). Auto-enhance, extract vendor/date/total/tax, review, then save.</p>

    <div class="two-col">
      <!-- LEFT: Scanner + form -->
      <section class="grid" style="gap:16px;">
        <!-- Upload / drop -->
        <div class="card">
          <div id="drop" class="drop">
            <p><strong>Drop an image or PDF page here</strong> (PNG/JPG best). Or choose a file:</p>
            <input id="file" type="file" accept="image/*"/>
          </div>
          <div class="row" style="margin-top:12px;">
            <button id="btnRotateL" class="ghost">âŸ² Rotate</button>
            <button id="btnRotateR" class="ghost">âŸ³ Rotate</button>
            <button id="btnZoomOut" class="ghost">âˆ’ Zoom</button>
            <button id="btnZoomIn" class="ghost">ï¼‹ Zoom</button>
            <span class="muted" id="status" style="margin-left:auto;"></span>
          </div>
        </div>

        <!-- Preview -->
        <div class="card">
          <canvas id="canvas" width="1200" height="1600"></canvas>
        </div>

        <!-- Scan controls -->
        <div class="card">
          <div class="row">
            <button id="btnAutoScan">âœ¨ Auto-Enhance & Scan</button>
            <button id="btnUseDetected" class="ghost" title="Fill the form below with detected values">Use detected values</button>
            <label class="muted" style="margin-left:auto;">
              <input type="checkbox" id="toggleRaw"/> Show OCR text
            </label>
          </div>

          <details class="advanced">
            <summary>Advanced</summary>
            <div class="row" style="margin-top:10px;">
              <button id="btnManualScan" class="ghost">Scan (manual)</button>
              <button id="btnCancel" class="ghost">Cancel</button>
              <button id="btnSharpen" class="ghost">Sharpen</button>
              <button id="btnBinarize" class="ghost">Binarize</button>
              <span class="muted">These tweaks re-process the current image before OCR.</span>
            </div>
            <pre id="rawBox" style="display:none; max-height:220px; overflow:auto; border:1px solid var(--border); border-radius:10px; padding:10px; background:#fff; margin-top:10px;"></pre>
          </details>
        </div>

        <!-- Detected -->
        <div class="card">
          <h3 style="margin:0 0 8px 0;">Detected</h3>
          <div class="grid grid-2">
            <div>Vendor: <b id="detVendor">â€”</b> <span id="confVendor" class="chip">â€”</span></div>
            <div>Date: <b id="detDate">â€”</b> <span id="confDate" class="chip">â€”</span></div>
            <div>Total: <b id="detTotal">â€”</b> <span id="confTotal" class="chip">â€”</span></div>
            <div>Tax: <b id="detTax">â€”</b> <span id="confTax" class="chip">â€”</span></div>
          </div>
        </div>

        <!-- Review & save -->
        <div class="card">
          <h3 style="margin:0 0 8px 0;">Review & Save</h3>
          <div class="grid grid-2">
            <div>
              <label>Vendor</label>
              <input id="inVendor" placeholder="Vendor"/>
            </div>
            <div>
              <label>Date</label>
              <input id="inDate" type="date"/>
            </div>
            <div>
              <label>Total</label>
              <input id="inTotal" type="number" step="0.01" placeholder="0.00"/>
            </div>
            <div>
              <label>Tax</label>
              <input id="inTax" type="number" step="0.01" placeholder="0.00"/>
            </div>
          </div>
          <div style="margin-top:8px;">
            <label>Notes</label>
            <input id="inNotes" placeholder="Optional notes (category/source can be added later in rules)"/>
          </div>
          <div class="row" style="margin-top:12px;">
            <button id="btnSave">Upload & Save</button>
            <span id="saveMsg" class="muted" style="margin-left:8px;"></span>
          </div>
        </div>
      </section>

      <!-- RIGHT: Unmatched receipts list -->
      <aside class="grid" style="gap:16px;">
        <div class="card">
          <div class="row" style="justify-content:space-between;">
            <h3 style="margin:0;">Unmatched Receipts</h3>
            <button id="btnRefresh" class="ghost">Refresh</button>
          </div>
          <table>
            <thead>
              <tr>
                <th style="min-width:110px;">Date</th>
                <th style="min-width:160px;">Vendor</th>
                <th class="right" style="min-width:100px;">Total</th>
                <th>Open</th>
              </tr>
            </thead>
            <tbody id="unmatchedBody">
              <tr><td colspan="4" class="muted">No items.</td></tr>
            </tbody>
          </table>
        </div>
      </aside>
    </div>
  </main>

  <script>
    // ===== Supabase client =====
    const SUPABASE_URL = "https://advihqhjjlxumgdlbwui.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkdmlocWhqamx4dW1nZGxid3VpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMTg0MzIsImV4cCI6MjA3NjU5NDQzMn0.kVlaPQg2_o9DGJYv22Dgca7veok4drF6kgLPy2wPBeY";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ===== DOM =====
    const el = (id) => document.getElementById(id);
    const file = el("file"), drop = el("drop"), canvas = el("canvas");
    const ctx = canvas.getContext("2d");
    const statusEl = el("status"), rawBox = el("rawBox");

    const det = {
      vendor: el("detVendor"), date: el("detDate"), total: el("detTotal"), tax: el("detTax")
    };
    const conf = {
      vendor: el("confVendor"), date: el("confDate"), total: el("confTotal"), tax: el("confTax")
    };
    const form = {
      vendor: el("inVendor"), date: el("inDate"), total: el("inTotal"), tax: el("inTax"), notes: el("inNotes")
    };

    let imageBitmap = null;
    let rotation = 0;
    let zoom = 1;
    let cancelFlag = false;

    // ===== Helpers =====
    function setStatus(t){ statusEl.textContent = t || ""; }
    function setChip(el, v){
      el.textContent = v.label;
      el.className = "chip " + (v.level || "warn");
    }
    function resetDetected(){
      ["vendor","date","total","tax"].forEach(k => det[k].textContent = "â€”");
      ["vendor","date","total","tax"].forEach(k => setChip(conf[k], {label:"â€”",level:""}));
    }
    function draw(){
      if(!imageBitmap){ ctx.clearRect(0,0,canvas.width,canvas.height); return; }
      const w = imageBitmap.width * zoom, h = imageBitmap.height * zoom;
      canvas.width = w; canvas.height = h;
      ctx.save();
      ctx.clearRect(0,0,w,h);
      // rotation around center
      ctx.translate(w/2, h/2);
      ctx.rotate(rotation*Math.PI/180);
      ctx.translate(-w/2, -h/2);
      ctx.drawImage(imageBitmap, 0, 0, w, h);
      ctx.restore();
    }
    async function loadImage(file){
      const bitmap = await createImageBitmap(file);
      imageBitmap = bitmap;
      rotation = 0; zoom = Math.min(1200 / bitmap.width, 1600 / bitmap.height) || 1;
      draw(); resetDetected(); rawBox.style.display="none";
    }
    function preprocessSharpen(){
      const {width:w,height:h} = canvas;
      const img = ctx.getImageData(0,0,w,h);
      const d = img.data;
      // simple unsharp mask
      for(let i=0;i<d.length;i+=4){
        const avg = (d[i]+d[i+1]+d[i+2])/3;
        d[i] = Math.min(255, avg*1.15);
        d[i+1] = Math.min(255, avg*1.15);
        d[i+2] = Math.min(255, avg*1.15);
      }
      ctx.putImageData(img,0,0);
    }
    function preprocessBinarize(){
      const {width:w,height:h} = canvas;
      const img = ctx.getImageData(0,0,w,h);
      const d = img.data;
      for(let i=0;i<d.length;i+=4){
        const g = 0.2126*d[i] + 0.7152*d[i+1] + 0.0722*d[i+2];
        const v = g > 180 ? 255 : 0;
        d[i]=d[i+1]=d[i+2]=v;
      }
      ctx.putImageData(img,0,0);
    }

    function parseOCR(text){
      // basic CA-friendly parser
      const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      // vendor: first non-allcaps-numbers-ish line near top
      const top = lines.slice(0,10);
      let vendor = (top.find(s => /[a-zA-Z]/.test(s) && !/total|visa|master|debit|credit|hst|gst|pst|balance/i.test(s)) || "").replace(/\s{2,}/g,' ');
      if (vendor.length > 40) vendor = vendor.slice(0,40);

      // date: look for YYYY-MM-DD / YYYY/MM/DD / DD-MM-YYYY / MM/DD/YYYY
      let date = null;
      for(const s of lines){
        const ymd = s.match(/(20\d{2})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})/);
        const dmy = s.match(/(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](20\d{2})/);
        if(ymd){ const [_,Y,M,D]=ymd; date = `${Y}-${String(M).padStart(2,'0')}-${String(D).padStart(2,'0')}`; break; }
        if(dmy){ const [_,D,M,Y]=dmy; date = `${Y}-${String(M).padStart(2,'0')}-${String(D).padStart(2,'0')}`; break; }
      }

      // amounts
      const money = lines.flatMap(s => (s.match(/([$]?\s*\d{1,3}(?:[,\s]\d{3})*(?:\.\d{2})?)/g)||[]))
        .map(v => Number(String(v).replace(/[^0-9.]/g,'')))
        .filter(n => Number.isFinite(n) && n>0).sort((a,b)=>a-b);

      // tax candidates
      let tax = null;
      for(const s of lines){
        const m = s.match(/\b(HST|GST|PST|TVQ|TPS)\b[^\d]*([\$]?\s*\d+(?:\.\d{2})?)/i);
        if(m){ tax = Number(String(m[2]).replace(/[^0-9.]/g,'')); break; }
      }
      // total candidates with keyword bias
      let total = null;
      for(const s of lines){
        if(/grand\s*total|amount\s*due|total/i.test(s)){
          const m = s.match(/([\$]?\s*\d+(?:[,\s]\d{3})*(?:\.\d{2})?)/);
          if(m){ total = Number(String(m[1]).replace(/[^0-9.]/g,'')); break; }
        }
      }
      if (!total && money.length) total = money[money.length-1];

      // confidence heuristics
      const conf = {
        vendor: vendor ? {label:"high",level:"ok"} : {label:"low",level:"bad"},
        date: date ? {label:"med",level:"ok"} : {label:"low",level:"bad"},
        total: total ? {label:"high",level:"ok"} : {label:"low",level:"bad"},
        tax: tax!=null ? {label:"med",level:"ok"} : {label:"unknown",level:"warn"}
      };

      return { vendor, date, total, tax, conf, text };
    }

    async function runOCR(){
      setStatus("Running OCRâ€¦"); cancelFlag=false;
      const blob = await new Promise(res => canvas.toBlob(res,"image/png",0.95));
      const { data: { text } } = await Tesseract.recognize(blob, "eng", { logger: _ => {} });
      if (cancelFlag) { setStatus("Canceled."); return null; }
      setStatus("Parsingâ€¦");
      return parseOCR(text);
    }

    // ===== Actions =====
    el("btnRotateL").addEventListener("click",()=>{ rotation -= 90; draw(); });
    el("btnRotateR").addEventListener("click",()=>{ rotation += 90; draw(); });
    el("btnZoomIn").addEventListener("click",()=>{ zoom *= 1.1; draw(); });
    el("btnZoomOut").addEventListener("click",()=>{ zoom /= 1.1; draw(); });

    el("btnSharpen").addEventListener("click",()=>{ preprocessSharpen(); });
    el("btnBinarize").addEventListener("click",()=>{ preprocessBinarize(); });

    el("toggleRaw").addEventListener("change",(e)=>{
      rawBox.style.display = e.target.checked ? "block" : "none";
    });

    el("btnCancel").addEventListener("click",()=>{ cancelFlag=true; setStatus("Cancelingâ€¦"); });

    async function autoEnhance(){
      // simple: brighten a touch before OCR
      preprocessSharpen();
    }

    el("btnAutoScan").addEventListener("click", async ()=>{
      if(!imageBitmap){ alert("Pick an image first."); return; }
      setStatus("Enhancingâ€¦");
      await autoEnhance();
      const out = await runOCR();
      if(!out) return;
      // show
      det.vendor.textContent = out.vendor || "â€”";
      det.date.textContent = out.date || "â€”";
      det.total.textContent = out.total!=null ? `$${out.total.toFixed(2)}` : "â€”";
      det.tax.textContent = out.tax!=null ? `$${Number(out.tax).toFixed(2)}` : "â€”";
      setChip(conf.vendor,out.conf.vendor);
      setChip(conf.date,out.conf.date);
      setChip(conf.total,out.conf.total);
      setChip(conf.tax,out.conf.tax);
      rawBox.textContent = out.text;
      setStatus("Done.");
      el("btnUseDetected").onclick = ()=>{
        if(out.vendor) form.vendor.value = out.vendor;
        if(out.date) form.date.value = out.date;
        if(out.total!=null) form.total.value = out.total.toFixed(2);
        if(out.tax!=null) form.tax.value = Number(out.tax).toFixed(2);
      };
    });

    el("btnManualScan").addEventListener("click", async ()=>{
      if(!imageBitmap){ alert("Pick an image first."); return; }
      const out = await runOCR();
      if(!out) return;
      det.vendor.textContent = out.vendor || "â€”";
      det.date.textContent = out.date || "â€”";
      det.total.textContent = out.total!=null ? `$${out.total.toFixed(2)}` : "â€”";
      det.tax.textContent = out.tax!=null ? `$${Number(out.tax).toFixed(2)}` : "â€”";
      setChip(conf.vendor,out.conf.vendor);
      setChip(conf.date,out.conf.date);
      setChip(conf.total,out.conf.total);
      setChip(conf.tax,out.conf.tax);
      rawBox.textContent = out.text;
      setStatus("Done.");
    });

    // upload / drop
    file.addEventListener("change", e=>{
      const f = e.target.files?.[0];
      if(!f) return;
      loadImage(f);
    });
    ["dragenter","dragover"].forEach(ev=>drop.addEventListener(ev,(e)=>{e.preventDefault(); drop.classList.add("drag");}));
    ["dragleave","drop"].forEach(ev=>drop.addEventListener(ev,(e)=>{e.preventDefault(); drop.classList.remove("drag");}));
    drop.addEventListener("drop", e=>{
      const f = e.dataTransfer.files?.[0];
      if(!f) return;
      loadImage(f);
    });

    // Save
    el("btnUseDetected").addEventListener("click", ()=>{}); // assigned after scan
    el("btnSave").addEventListener("click", async ()=>{
      if(!imageBitmap){ alert("Scan an image first."); return; }
      const vendor = form.vendor.value.trim();
      const date = form.date.value || null;
      const total = form.total.value ? Number(form.total.value) : null;
      const tax = form.tax.value ? Number(form.tax.value) : 0;
      const notes = form.notes.value || null;

      if(!total || !date){ alert("Date and Total are required."); return; }

      el("saveMsg").textContent = "Uploadingâ€¦";
      const pngBlob = await new Promise(res => canvas.toBlob(res,"image/png",0.95));
      const size_bytes = pngBlob.size;

      const fname = `receipt_${Date.now()}.png`;
      const { data: up, error: upErr } = await sb.storage.from("receipts").upload(fname, pngBlob, { contentType:"image/png", upsert:false });
      if(upErr){ el("saveMsg").className="err"; el("saveMsg").textContent = upErr.message; return; }

      const { data: pub } = sb.storage.from("receipts").getPublicUrl(up.path);
      const image_url = pub?.publicUrl || null;

      const ins = {
        image_url, size_bytes, receipt_date: date, total, tax,
        vendor: vendor || null, notes: notes || null, source: "local_ocr"
      };

      const { error: insErr } = await sb.from("receipts").insert(ins);
      if(insErr){ el("saveMsg").className="err"; el("saveMsg").textContent = insErr.message; return; }

      el("saveMsg").className="ok";
      el("saveMsg").textContent = "Saved.";
      // refresh unmatched panel
      loadUnmatched();
    });

    // Unmatched list
    async function loadUnmatched(){
      const body = el("unmatchedBody");
      body.innerHTML = `<tr><td colspan="4" class="muted">Loadingâ€¦</td></tr>`;
      let q = sb.from("v_unmatched_receipts").select("id,receipt_date,vendor,total,image_url,created_at").order("created_at", {ascending:false}).limit(50);
      const { data, error } = await q;
      if(error){ body.innerHTML = `<tr><td colspan="4" class="err">${error.message}</td></tr>`; return; }
      if(!data?.length){ body.innerHTML = `<tr><td colspan="4" class="muted">No unmatched receipts.</td></tr>`; return; }
      body.innerHTML = data.map(r=>{
        const t = Number(r.total||0).toFixed(2);
        const link = r.image_url ? `<a href="${r.image_url}" target="_blank">Open</a>` : `<span class="muted">â€”</span>`;
        const d = (r.receipt_date||"").slice(0,10);
        const v = (r.vendor||"").substring(0,40);
        return `<tr>
          <td>${d}</td>
          <td>${v}</td>
          <td class="right">$${t}</td>
          <td>${link}</td>
        </tr>`;
      }).join("");
    }
    el("btnRefresh").addEventListener("click", loadUnmatched);

    // init
    loadUnmatched();
  </script>
</body>
</html>
