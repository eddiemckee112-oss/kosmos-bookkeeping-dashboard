<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kosmos ‚Äî Transactions</title>

  <link rel="stylesheet" href="style.css" />
  <script src="config.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .right{text-align:right}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--border);font-weight:600;font-size:.82rem}
    .badge.ok{background:#eef9f1;color:var(--ok);border-color:#cfe7d6}
    .badge.muted{background:#f6f7f8;color:var(--muted)}
    /* Always-visible, high-contrast action buttons */
    .linkbtn{padding:6px 12px;border:1px solid #111;border-radius:999px;background:#111;color:#fff;cursor:pointer;opacity:1;transition:opacity .15s ease}
    .linkbtn:hover{opacity:.85}
    .linkbtn.light{background:#fff;color:#111;border-color:#ccc}
    .linkbtn.danger{background:#b91c1c;border-color:#b91c1c;color:#fff}
    .imgthumb{height:40px;width:auto;border-radius:6px;vertical-align:middle}
    .previewbox{display:flex;align-items:center;gap:8px}
  </style>
</head>

<body>
<header>
  <h1>Kosmos Bookkeeping</h1>
  <nav>
    <a href="index.html">Dashboard</a>
    <a href="receipts.html">Receipts</a>
    <a href="transactions.html" class="active">Transactions</a>
    <a href="reports.html">Reports</a>
  </nav>
</header>

<main class="container">
  <h2>üè¶ Transactions</h2>
  <p class="muted">View, filter, and link transactions to receipts.</p>

  <div class="card">
    <div class="toolbar">
      <select id="filterMode">
        <option value="all">All</option>
        <option value="unmatched">Unmatched</option>
        <option value="matched">Matched</option>
        <option value="recent">Recently added</option>
      </select>
      <input id="search" placeholder="Search description/vendor‚Ä¶" style="padding:.5rem .7rem;border:1px solid #cfcfcf;border-radius:10px;min-width:220px" />
      <button id="applyFilter">Apply</button>
      <span class="spacer"></span>
      <span class="kpill">Total: <b id="countAll">0</b></span>
      <span class="kpill">Matched: <b id="countMatched">0</b></span>
      <span class="kpill">Unmatched: <b id="countUnmatched">0</b></span>
    </div>
  </div>

  <div class="card" style="overflow:auto">
    <table id="txnTable" style="min-width:1100px">
      <thead>
        <tr>
          <th>Date</th>
          <th>Description</th>
          <th class="right">Amount</th>
          <th>Direction</th>
          <th>Category</th>
          <th>Source</th>
          <th>Linked Receipt</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</main>

<script>
/* ---------- Supabase ---------- */
const sb = supabase.createClient(
  "https://advihqhjjlxumgdlbwui.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkdmlocWhqamx4dW1nZGxid3VpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMTg0MzIsImV4cCI6MjA3NjU5NDQzMn0.kVlaPQg2_o9DGJYv22Dgca7veok4drF6kgLPy2wPBeY"
);

/* ---------- Helpers ---------- */
const $ = id => document.getElementById(id);
const tbody = document.querySelector("#txnTable tbody");
let ALL = [];
let RECEIPTS = new Map();
let MATCHES = new Map();

const money = n => (Number(n)||0).toLocaleString(undefined,{style:'currency',currency:'CAD'});
function esc(s){ return String(s??"").replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

/* ---------- Rendering ---------- */
function badge(id){return MATCHES.has(id)?`<span class="badge ok">Matched</span>`:`<span class="badge muted">Unmatched</span>`;}

function receiptPreview(txid){
  const rid = MATCHES.get(txid);
  if(!rid) return "";
  const r = RECEIPTS.get(rid);
  if(!r) return "(missing)";
  return `
    <div class="previewbox">
      ${r.image_url ? `<a href="${esc(r.image_url)}" target="_blank" rel="noopener"><img class="imgthumb" src="${esc(r.image_url)}" alt=""></a>` : ""}
      <span>${esc(r.vendor || "Receipt")}</span>
    </div>`;
}

/* Actions logic:
   - If transaction ALREADY matched -> show "Unlink"
   - Else if a receipt is selected (coming from 'Match Now') -> "Link to This"
   - Else -> show "Upload Receipt" (go to receipts page)
*/
function actions(txid){
  const hasMatch = MATCHES.has(txid);
  const selectedReceipt = sessionStorage.getItem('linkReceipt');

  if(hasMatch){
    return `<button class="linkbtn danger" data-act="unlink" data-id="${txid}">Unlink</button>`;
  }
  if(selectedReceipt){
    return `<button class="linkbtn" data-act="link" data-id="${txid}">Link to This</button>`;
  }
  return `<a class="linkbtn light" href="receipts.html">Upload Receipt</a>`;
}

function render(rows){
  $("countAll").textContent=ALL.length;
  let matchedCount = 0;
  rows.forEach(r=>{if(MATCHES.has(r.id)) matchedCount++;});
  $("countMatched").textContent = matchedCount;
  $("countUnmatched").textContent = ALL.length - matchedCount;

  if(!rows.length){
    tbody.innerHTML = `<tr><td colspan="9">No transactions found.</td></tr>`;
    return;
  }

  tbody.innerHTML = rows.map(r => `
    <tr>
      <td>${esc((r.txn_date||"").slice(0,10))}</td>
      <td>${esc(r.description||"")}</td>
      <td class="right">${money(r.amount)}</td>
      <td>${esc(r.direction)}</td>
      <td>${esc(r.category||"")}</td>
      <td>${esc(r.source_account_name||"")}</td>
      <td>${receiptPreview(r.id)}</td>
      <td>${badge(r.id)}</td>
      <td>${actions(r.id)}</td>
    </tr>`).join("");

  tbody.querySelectorAll("button[data-act]").forEach(btn=>{
    const act=btn.dataset.act,id=btn.dataset.id;
    if(act==="link") btn.onclick=()=>linkReceiptToTxn(id);
    if(act==="unlink") btn.onclick=()=>unlinkReceiptFromTxn(id);
  });
}

/* ---------- Data Loading ---------- */
async function loadData(){
  const { data: txns, error: tErr } = await sb.from("transactions").select("id, txn_date, description, amount, direction, category, source_account_name, created_at").order("txn_date",{ascending:false});
  if(tErr){tbody.innerHTML=`<tr><td colspan="9">${tErr.message}</td></tr>`;return;}
  ALL = txns||[];

  const { data: recs } = await sb.from("receipts").select("id,vendor,image_url");
  RECEIPTS.clear(); (recs||[]).forEach(r => RECEIPTS.set(r.id, r));

  const { data: mx } = await sb.from("matches").select("transaction_id, receipt_id");
  MATCHES.clear(); (mx||[]).forEach(m => MATCHES.set(m.transaction_id, m.receipt_id));

  render(ALL);
}

/* ---------- Filtering ---------- */
$("applyFilter").onclick = applyFilters;
$("search").oninput = ()=>{clearTimeout(window.__t);window.__t=setTimeout(applyFilters,200);};
function applyFilters(){
  const mode=$("filterMode").value;
  const q=($("search").value||"").toLowerCase().trim();
  let rows=ALL.slice();
  if(mode==="matched") rows=rows.filter(r=>MATCHES.has(r.id));
  else if(mode==="unmatched") rows=rows.filter(r=>!MATCHES.has(r.id));
  if(q){rows=rows.filter(r=>(r.description||"").toLowerCase().includes(q));}
  render(rows);
}

/* ---------- Linking / Unlinking ---------- */
async function linkReceiptToTxn(txnId){
  const rid=sessionStorage.getItem("linkReceipt");
  if(!rid){alert("No receipt selected.");return;}
  const { error } = await sb.from("matches").insert([{ transaction_id: txnId, receipt_id: rid, matched_amount: 0, confidence: 1.0, method: "manual", match_type: "manual" }]);
  if(error){alert(error.message);return;}
  sessionStorage.removeItem("linkReceipt");
  await loadData();
  alert("Receipt linked successfully!");
  location.href="receipts.html";
}

async function unlinkReceiptFromTxn(txnId){
  const { error } = await sb.from("matches").delete().eq("transaction_id",txnId);
  if(error){alert(error.message);return;}
  await loadData();
}

/* ---------- Auto Load ---------- */
document.addEventListener("DOMContentLoaded",loadData);
</script>

<script src="roles.js"></script>
</body>
</html>
