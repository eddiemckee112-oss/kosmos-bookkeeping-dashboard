<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kosmos ‚Äî Transactions</title>

  <link rel="stylesheet" href="style.css" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    td.editable{cursor:text} td.editing{background:#fffbe6}
    .hint{font-size:.85rem;color:var(--muted);margin-top:6px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .spacer{flex:1 1 auto}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--border);font-weight:600;font-size:.82rem;text-decoration:none}
    .badge.ok{background:#eef9f1;color:var(--ok);border-color:#cfe7d6}
    .badge.muted{background:#f6f7f8;color:var(--muted)}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{width:min(920px,92vw);max-height:85vh;overflow:auto;background:#fff;border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 10px 35px rgba(0,0,0,.18)}
    .map-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media (max-width:760px){.map-grid{grid-template-columns:1fr}}
    .preview{border:1px solid var(--border);border-radius:10px;overflow:auto;background:#fff;max-height:320px}
    .sticky-footer{position:sticky;bottom:0;background:#fff;border-top:1px solid var(--border);padding:10px 12px;display:flex;gap:12px;flex-wrap:wrap;justify-content:flex-end}
    .upgrid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:860px){.upgrid{grid-template-columns:1fr}}
    .imgbox{border:1px solid var(--border);border-radius:12px;background:#fff;padding:10px;text-align:center}
    .imgbox img{max-width:100%;height:auto;border-radius:8px}
    .bulkbar{display:none;align-items:center;gap:10px;margin-top:12px;padding:10px;border:1px dashed var(--border);border-radius:12px;background:#fff}
    .bulkbar.show{display:flex}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;font-weight:600;cursor:pointer}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .viewsbar{display:flex;align-items:center;gap:8px}
    .viewsbar select{min-width:200px}
  </style>
</head>
<body>
<header>
  <h1>Kosmos Bookkeeping</h1>
  <nav>
    <a href="index.html">Dashboard</a>
    <a href="receipts.html">Receipts</a>
    <a href="transactions.html" class="active">Transactions</a>
    <a href="reports.html">Reports</a>
  </nav>
</header>

<main class="container">
  <h2>üí≥ Transactions</h2>
  <p class="muted">Filter, import, categorize, save views, attach receipts, create vendor rules, and use bulk actions for speed.</p>

  <div class="card">
    <div class="toolbar">
      <label>Date Range:</label>
      <input type="date" id="fromDate" /><span>‚Äì</span><input type="date" id="toDate" />
      <select id="filterMode">
        <option value="all">All</option>
        <option value="matched">Matched</option>
        <option value="unmatched">Unmatched</option>
        <option value="categorized">Categorized</option>
        <option value="uncategorized">Uncategorized</option>
        <option value="with_source">With Source</option>
        <option value="without_source">Without Source</option>
        <option value="debits">Debits only</option>
        <option value="credits">Credits only</option>
      </select>
      <button id="filterBtn">Apply</button>
      <span class="spacer"></span>
      <input id="quickSearch" placeholder="Search description/category/source‚Ä¶" style="padding:.5rem .7rem;border:1px solid #cfcfcf;border-radius:10px;min-width:260px" />
      <button id="importBtn" class="ghost">‚¨ÜÔ∏è Import CSV</button>
      <button id="backfillBtn" class="ghost">‚Ü∫ Backfill Sources</button>
      <button id="exportBtn" class="ghost">üìÅ Export CSV</button>
    </div>

    <div class="viewsbar" style="margin-top:8px;">
      <label>Saved View:</label>
      <select id="viewsSelect"></select>
      <button id="saveViewBtn" class="ghost">üíæ Save Current</button>
      <button id="setDefaultViewBtn" class="ghost">‚≠ê Set Default</button>
      <button id="deleteViewBtn" class="ghost">üóëÔ∏è Delete</button>
      <span class="muted" id="viewsMsg"></span>
    </div>

    <div class="hint">Status is clickable when matched and jumps to the receipt. ‚ÄúSource‚Äù prefers the account name (fallback: institution). Your last filters auto-restore.</div>
    <p id="status" class="muted" style="margin-top:6px;"></p>

    <div class="chips">
      <span id="chipUnmatched" class="chip">Unmatched: <b id="countUnmatched">0</b></span>
      <span id="chipUncategorized" class="chip">Uncategorized: <b id="countUncat">0</b></span>
      <span id="chipNoSource" class="chip">No Source: <b id="countNoSource">0</b></span>
      <span id="chipDupes" class="chip">Duplicates: <b id="countDupes">0</b></span>
    </div>

    <div id="bulkbar" class="bulkbar">
      <span class="chip">Selected: <b id="selCount">0</b></span>
      <input id="bulkCategory" placeholder="Set category‚Ä¶" />
      <button id="applyCategory">Apply Category</button>
      <input id="bulkSource" placeholder="Set source‚Ä¶" />
      <button id="applySource">Apply Source</button>
      <button id="clearCategory" class="ghost">Clear Category</button>
      <button id="bulkMakeRule" title="Create a rule from the first selected row">‚öôÔ∏è Create Rule from Selection</button>
    </div>
  </div>

  <div class="card">
    <div class="grid-2">
      <div><strong>Total Transactions:</strong> <span id="txnCount">‚Äî</span></div>
      <div><strong>Debits:</strong> <span id="debits">‚Äî</span></div>
      <div><strong>Credits:</strong> <span id="credits">‚Äî</span></div>
      <div><strong>Net:</strong> <span id="net">‚Äî</span></div>
    </div>
    <p class="muted" style="margin-top:8px;">Numbers reflect the current filter. Use Quick Search to instantly narrow the table.</p>
  </div>

  <div class="card" style="overflow:auto;">
    <table id="txnTable">
      <thead>
      <tr>
        <th style="width:40px;"><input type="checkbox" id="selectAll" /></th>
        <th style="min-width:110px;">Date</th>
        <th style="min-width:320px;">Description</th>
        <th class="right" style="min-width:120px;">Amount</th>
        <th style="min-width:90px;">Type</th>
        <th style="min-width:140px;">Status</th>
        <th style="min-width:160px;">Category</th>
        <th style="min-width:180px;">Source</th>
        <th style="min-width:240px;">Actions</th>
      </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
      <tr>
        <td colspan="9">
          <div class="sticky-footer">
            <span class="kpill">Rows: <b id="ftRows">0</b></span>
            <span class="kpill">Debits: <b id="ftDebits">$0.00</b></span>
            <span class="kpill">Credits: <b id="ftCredits">$0.00</b></span>
            <span class="kpill">Net: <b id="ftNet">$0.00</b></span>
          </div>
        </td>
      </tr>
      </tfoot>
    </table>
  </div>
</main>

<!-- Import Modal (unchanged UI) -->
<div id="modalBackdrop" class="modal-backdrop"> ... </div>
<!-- Upload Receipt Modal (unchanged UI) -->
<div id="uploadBackdrop" class="modal-backdrop"> ... </div>

<!-- Create Rule Modal -->
<div id="ruleBackdrop" class="modal-backdrop">
  <div class="modal">
    <h3>Create Vendor Rule</h3>
    <p class="muted">Use a pattern that matches how the vendor appears in your statements (e.g., ‚ÄúSQUARE‚Äù, ‚ÄúAMAZON‚Äù).</p>

    <div class="card">
      <div class="grid grid-2">
        <div>
          <label>Vendor Pattern</label>
          <input id="rulePattern" placeholder="e.g., SQUARE" />
        </div>
        <div>
          <label>Category <span class="muted">(optional)</span></label>
          <input id="ruleCategory" placeholder="e.g., Income" />
        </div>
        <div>
          <label>Source <span class="muted">(optional)</span></label>
          <input id="ruleSource" placeholder="e.g., CIBC Chequing" />
        </div>
        <div>
          <label>Tax <span class="muted">(optional)</span></label>
          <input id="ruleTax" type="number" step="0.01" placeholder="0.00" />
        </div>

        <div>
          <label>Apply to</label>
          <select id="ruleDirection">
            <option value="">Any (debit or credit)</option>
            <option value="credit">Credits only</option>
            <option value="debit">Debits only</option>
          </select>
        </div>
        <div class="row" style="align-items:center;gap:8px;margin-top:6px">
          <input type="checkbox" id="ruleAutoMatch" />
          <label for="ruleAutoMatch">Auto-match (create virtual receipt)</label>
        </div>
      </div>

      <p id="ruleMsg" class="muted" style="margin-top:8px;"></p>
      <div class="row" style="justify-content:flex-end; margin-top:8px;">
        <button id="ruleCancel" class="ghost">Cancel</button>
        <button id="ruleSave">Save Rule</button>
        <button id="ruleSaveApply">Save & Apply Now</button>
      </div>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL = "https://advihqhjjlxumgdlbwui.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkdmlocWhqamx4dW1nZGxid3VpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMTg0MzIsImV4cCI6MjA3NjU5NDQzMn0.kVlaPQg2_o9DGJYv22Dgca7veok4drF6kgLPy2wPBeY";
const sb = supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

const $ = id => document.getElementById(id);
const tbody = document.querySelector("#txnTable tbody");
const statusEl=$("status"); const quickSearch=$("quickSearch");

let allRows=[], txToReceipts=new Map(), viewRows=[], selected=new Set();

// ---------- helpers & existing UI code omitted for brevity in this snippet ----------
// (Use the exact working version you already pasted; only new pieces are below.)
// To keep this message short, I‚Äôll include only the new/changed JS. Everything else stays the same.

// ========= OPEN RULE (prefill) =========
const ruleBackdrop=$("ruleBackdrop"), rulePattern=$("rulePattern"),
      ruleCategory=$("ruleCategory"), ruleSource=$("ruleSource"),
      ruleTax=$("ruleTax"), ruleMsg=$("ruleMsg"),
      ruleDirection=$("ruleDirection"), ruleAutoMatch=$("ruleAutoMatch");

function defaultPatternFromRow(r){
  const base=(r.vendor_clean||r.description||"").toUpperCase();
  return base.replace(/\d{2,}/g,"").replace(/\s{2,}/g," ").trim();
}
function openRuleFor(id){
  const r=allRows.find(x=>x.id===id); if(!r) return;
  rulePattern.value=defaultPatternFromRow(r);
  ruleCategory.value=r.category||"";
  ruleSource.value=r.source_account_name||r.institution||"";
  ruleTax.value="";
  ruleDirection.value="";
  ruleAutoMatch.checked=false;
  ruleMsg.textContent=""; ruleMsg.className="muted";
  ruleBackdrop.style.display="flex"; ruleBackdrop.setAttribute("data-txn",id);
}
$("bulkMakeRule").addEventListener("click",()=>{
  const firstSel=selected.values().next().value;
  if(!firstSel){ alert("Select at least one row."); return; }
  openRuleFor(firstSel);
});
$("ruleCancel").addEventListener("click",()=>{ ruleBackdrop.style.display="none"; });

// ========= SAVE RULE CORE (adds direction + auto-match) =========
async function saveRuleCore(applyNow){
  const vendor_pattern=(rulePattern.value||"").trim();
  const category=(ruleCategory.value||"").trim();
  const source=(ruleSource.value||"").trim();
  const taxVal=ruleTax.value?Number(ruleTax.value):null;
  const direction_filter=ruleDirection.value || null;
  const auto_match=!!ruleAutoMatch.checked;

  if(!vendor_pattern){ ruleMsg.className="err"; ruleMsg.textContent="Vendor Pattern is required."; return; }

  ruleMsg.className="muted"; ruleMsg.textContent="Saving rule‚Ä¶";
  const { error:rErr } = await sb.from("vendor_rules").insert({
    vendor_pattern,
    category: category || null,
    source: source || null,
    tax: Number.isFinite(taxVal)?taxVal:null,
    direction_filter,
    auto_match
  });
  if(rErr){ ruleMsg.className="err"; ruleMsg.textContent=rErr.message; return; }

  if(!applyNow){
    ruleMsg.className="ok"; ruleMsg.textContent="Rule saved.";
    setTimeout(()=>{ ruleBackdrop.style.display="none"; },600);
    return;
  }

  // ---- APPLY NOW ----
  ruleMsg.textContent="Applying to existing transactions‚Ä¶";
  const like=`%${vendor_pattern}%`;
  let filter=sb.from("transactions").select("id,org_id,account_id,txn_date,amount,direction,description,category,source_account_name")
               .ilike("description",like);
  if(direction_filter){ filter=filter.eq("direction",direction_filter); }
  const { data:rows, error:sErr } = await filter;
  if(sErr){ ruleMsg.className="err"; ruleMsg.textContent=sErr.message; return; }
  if(!rows?.length){ ruleMsg.className="ok"; ruleMsg.textContent="Rule saved. No rows matched current history."; return; }

  // category/source updates (only where NULL)
  let updated = 0;
  if(category){
    const { count, error: u1 } = await sb.from("transactions")
      .update({ category })
      .ilike("description",like)
      .is("category",null)
      .select("id",{count:"exact",head:true})
      .maybeSingle();
    if(u1){ ruleMsg.className="err"; ruleMsg.textContent=u1.message; return; }
    updated += (count||0);
  }
  if(source){
    const { count, error: u2 } = await sb.from("transactions")
      .update({ source_account_name: source })
      .ilike("description",like)
      .is("source_account_name",null)
      .select("id",{count:"exact",head:true})
      .maybeSingle();
    if(u2){ ruleMsg.className="err"; ruleMsg.textContent=u2.message; return; }
    updated += (count||0);
  }

  // Auto-match: create virtual receipts for unmatched rows
  if(auto_match){
    // find which of these rows are already matched
    const ids = rows.map(r=>r.id);
    const { data:mrows } = await sb.from("matches").select("transaction_id").in("transaction_id",ids);
    const matchedSet = new Set((mrows||[]).map(m=>m.transaction_id));
    const toCreate = rows.filter(r=>!matchedSet.has(r.id));

    if(toCreate.length){
      // 1) insert virtual receipts in the same order
      const receipts = toCreate.map(r=>({
        org_id: r.org_id || null,
        account_id: r.account_id || null,
        image_url: null,
        size_bytes: 0,
        receipt_date: r.txn_date,
        total: Number(r.amount)||0,
        tax: 0,
        vendor: vendor_pattern,
        source: "virtual_rule",
        notes: "Virtual receipt generated by rule"
      }));
      const { data:insReceipts, error:insErr } = await sb.from("receipts").insert(receipts).select("id");
      if(insErr){ ruleMsg.className="err"; ruleMsg.textContent=insErr.message; return; }

      // 2) link them 1:1 via matches
      const matches = toCreate.map((r,i)=>({
        org_id: r.org_id || null,
        transaction_id: r.id,
        receipt_id: insReceipts[i].id,
        matched_amount: Number(r.amount)||0,
        confidence: 0.98,
        method: "rule_auto",
        match_type: "auto"
      }));
      const { error:mErr } = await sb.from("matches").insert(matches);
      if(mErr){ ruleMsg.className="err"; ruleMsg.textContent=mErr.message; return; }
      updated += toCreate.length;
    }
  }

  ruleMsg.className="ok";
  ruleMsg.textContent=`Rule saved and applied. Updated ${updated} rows${auto_match?' (auto-matched where needed)':''
    }.`;
  setTimeout(async ()=>{ ruleBackdrop.style.display="none"; await loadTransactions(); },700);
}
$("ruleSave").addEventListener("click",()=>saveRuleCore(false));
$("ruleSaveApply").addEventListener("click",()=>saveRuleCore(true));

// -------------- the rest of your existing page script remains the same --------------
// Load, render, import, upload modal, bulk actions, views, etc.
// (Keep all of that from your current working file.)

</script>
</body>
</html>
