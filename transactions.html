<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Kosmos Bookkeeping â€” Transactions</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js"></script>
  <style>
    :root{--bg:#fafafa;--card:#fff;--border:#e5e7eb;--muted:#6b7280;
          --ok:#0a7a33;--err:#b00020;--ink:#111;--btn:#111;--btnH:#333;}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
         margin:0;background:var(--bg);color:var(--ink)}
    header{background:#fff;border-bottom:1px solid var(--border);
           padding:14px 24px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:10}
    header h1{font-size:1.2rem;margin:0}
    nav a{margin-left:16px;color:var(--ink);text-decoration:none;font-weight:500;padding:6px 10px;border-radius:8px}
    nav a:hover,nav a.active{background:#111;color:#fff}
    main{padding:32px;max-width:1100px;margin:auto}
    h2{margin-top:0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin-top:16px}
    label{font-weight:600}
    input,select,button{padding:.55rem .75rem;border-radius:10px;border:1px solid #cfcfcf;background:#fff}
    button{background:var(--btn);color:#fff;border-color:#bbb;cursor:pointer}
    button:hover{background:var(--btnH)}
    .secondary{background:#f7f7f7;color:#111;border-color:#d0d0d0}
    .muted{color:var(--muted)} .ok{color:var(--ok)} .err{color:var(--err)}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:left}
    th{background:#f6f7f8;position:sticky;top:0}
    .right{text-align:right}
    .totals{display:grid;grid-template-columns:repeat(3,minmax(180px,1fr));gap:10px}
    .kpi{background:#f9fafb;border:1px solid var(--border);border-radius:12px;padding:12px}
    .kpi span{display:block;color:var(--muted);font-size:12px}
    .kpi b{font-size:1.15rem}
    @media(max-width:900px){table{font-size:12px}}
  </style>
</head>
<body>
  <header>
    <h1>ðŸ’³ Kosmos Bookkeeping</h1>
    <nav>
      <a href="index.html">Dashboard</a>
      <a href="receipts.html">Receipts</a>
      <a href="transactions.html" class="active">Transactions</a>
      <a href="matched.html">Matched</a>
      <a href="reports.html">Reports</a>
    </nav>
  </header>

  <main>
    <h2>Transactions</h2>
    <p class="muted">Filter by date, review totals, import CSVs from your bank, and view the line items.</p>

    <!-- Filters -->
    <div class="card">
      <div class="row">
        <label>Date from <input type="date" id="fromDate"></label>
        <label>Date to <input type="date" id="toDate"></label>
        <button id="loadBtn">Load</button>
        <div style="margin-left:auto;display:flex;gap:8px;flex-wrap:wrap;">
          <button id="btnWeek" class="secondary">This Week</button>
          <button id="btnMonth" class="secondary">This Month</button>
          <button id="btnYear" class="secondary">This Year</button>
          <button id="btnAll" class="secondary">All Time</button>
        </div>
      </div>
      <p id="msg" class="muted" style="margin-top:6px;"></p>
    </div>

    <!-- Totals + Chart -->
    <div class="card">
      <div class="totals">
        <div class="kpi"><span>Total Debits (spend)</span><b id="totDeb">â€”</b></div>
        <div class="kpi"><span>Total Credits (inflow)</span><b id="totCred">â€”</b></div>
        <div class="kpi"><span>Net (credits - debits)</span><b id="totNet">â€”</b></div>
      </div>
      <div style="margin-top:14px;"><canvas id="txnChart" height="120"></canvas></div>
    </div>

    <!-- CSV Import -->
    <div class="card">
      <h3>Import Bank CSV</h3>
      <p class="muted">Drag-drop or choose a .CSV; we auto-parse most formats (CIBC, TD, RBC, etc.).</p>
      <div class="row">
        <input type="file" id="bankCsvInput" accept=".csv"/>
        <button id="importCsvBtn">Import CSV</button>
      </div>
      <p id="csvMsg" class="muted" style="margin-top:6px;"></p>
    </div>

    <!-- Table -->
    <div class="card">
      <h3>Transactions List</h3>
      <div style="max-height:520px;overflow:auto;margin-top:8px;">
        <table id="txnTable">
          <thead>
            <tr><th>Date</th><th>Description</th><th class="right">Amount</th><th>Direction</th></tr>
          </thead>
          <tbody><tr><td colspan="4" class="muted">Loadingâ€¦</td></tr></tbody>
        </table>
      </div>
    </div>
  </main>

  <script>
    // --- Supabase
    const SUPABASE_URL="https://advihqhjjlxumgdlbwui.supabase.co";
    const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkdmlocWhqamx4dW1nZGxid3VpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMTg0MzIsImV4cCI6MjA3NjU5NDQzMn0.kVlaPQg2_o9DGJYv22Dgca7veok4drF6kgLPy2wPBeY";
    const sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
    const qs=id=>document.getElementById(id);
    let chart=null;

    // --- Date helpers
    const today=new Date();
    const fmt=d=>d.toISOString().slice(0,10);
    function setRange(kind){
      if(kind==="all"){ qs("fromDate").value="1900-01-01"; qs("toDate").value="2100-12-31"; return; }
      const from=new Date(today);
      if(kind==="week") from.setDate(today.getDate()-7);
      if(kind==="month") from.setMonth(today.getMonth()-1);
      if(kind==="year") from.setFullYear(today.getFullYear()-1);
      qs("fromDate").value=fmt(from); qs("toDate").value=fmt(today);
    }

    // --- Load data
    async function loadTransactions(){
      qs("msg").textContent="Loadingâ€¦";
      const from=qs("fromDate").value||"1900-01-01";
      const to  =qs("toDate").value||"2100-12-31";
      const {data,error}=await sb.from("transactions").select("*").gte("txn_date",from).lte("txn_date",to).order("txn_date",{ascending:false});
      if(error){ qs("msg").className="err"; qs("msg").textContent=error.message; return; }
      qs("msg").className="muted"; qs("msg").textContent=`Loaded ${data.length} rows.`;
      renderTable(data); renderTotalsAndChart(data);
    }

    function renderTable(rows){
      const tbody=qs("txnTable").querySelector("tbody");
      if(!rows.length){ tbody.innerHTML="<tr><td colspan='4' class='muted'>No transactions.</td></tr>"; return; }
      tbody.innerHTML = rows.map(r=>`
        <tr>
          <td>${r.txn_date||""}</td>
          <td>${r.description||""}</td>
          <td class="right">$${Number(r.amount||0).toFixed(2)}</td>
          <td>${r.direction||""}</td>
        </tr>`).join("");
    }

    function renderTotalsAndChart(rows){
      const deb = rows.filter(r=>String(r.direction).toLowerCase()==="debit").reduce((a,r)=>a+(Number(r.amount)||0),0);
      const cred= rows.filter(r=>String(r.direction).toLowerCase()==="credit").reduce((a,r)=>a+(Number(r.amount)||0),0);
      const net = cred - deb;
      qs("totDeb").textContent  = "$"+deb.toFixed(2);
      qs("totCred").textContent = "$"+cred.toFixed(2);
      qs("totNet").textContent  = (net>=0?"+":"") + "$" + net.toFixed(2);

      // Simple daily spend chart (sum by date, debits as positive spend)
      const byDate=new Map();
      for(const r of rows){
        const d=r.txn_date; if(!d) continue;
        const amt=Number(r.amount)||0;
        const spend = String(r.direction).toLowerCase()==="debit" ? amt : 0;
        byDate.set(d,(byDate.get(d)||0)+spend);
      }
      const labels=[...byDate.keys()].sort();
      const values=labels.map(d=>byDate.get(d));
      const ctx=document.getElementById("txnChart").getContext("2d");
      if(chart) chart.destroy();
      chart=new Chart(ctx,{type:"line",data:{labels,datasets:[{label:"Daily Spend (Debits)",data:values,fill:false}]},options:{responsive:true,scales:{y:{beginAtZero:true}}}});
    }

    // --- CSV import (same importer you tested, moved here)
    qs("importCsvBtn").onclick = async ()=>{
      const set=(cls,msg)=>{qs("csvMsg").className=cls; qs("csvMsg").textContent=msg; console.log("[CSV]",msg);}
      try{
        const file=qs("bankCsvInput").files?.[0];
        if(!file){ set("err","Pick a CSV first."); return; }
        set("muted","Reading CSVâ€¦");
        let rows=null;

        // Preferred: SheetJS
        try{
          const ab=await file.arrayBuffer();
          const wb=XLSX.read(ab,{type:"array"});
          const sheet=wb.Sheets[wb.SheetNames?.[0]];
          if(!sheet) throw new Error("No sheet found");
          rows=XLSX.utils.sheet_to_json(sheet,{header:1,raw:true,defval:""});
          if(!rows?.length) throw new Error("Parsed zero rows.");
        }catch(_e){
          // Fallback mini-parser
          set("muted","Reading CSV (fallback)â€¦");
          const text=await file.text();
          rows=text.split(/\r?\n/).map(line=>{
            const out=[]; let cur="",inQ=false;
            for(let i=0;i<line.length;i++){
              const ch=line[i];
              if(ch==='"'){ inQ=!inQ; continue; }
              if(ch==="," && !inQ){ out.push(cur); cur=""; continue; }
              cur+=ch;
            }
            out.push(cur);
            return out.map(c=>c.trim().replace(/^"(.*)"$/,"$1"));
          }).filter(r=>r.some(c=>String(c).trim().length>0));
          if(!rows?.length){ throw new Error("Fallback parsed zero rows."); }
        }

        const isLikelyDate=v=>{ if(v instanceof Date) return true; const s=String(v).trim(); return /^\d{4}[-\/]\d{2}[-\/]\d{2}$/.test(s)||/^\d{2}[-\/]\d{2}[-\/]\d{4}$/.test(s); }
        const first=rows[0]||[];
        const headerLooksLikeData= isLikelyDate(first[0]) && String(first[1]||"").length>0;

        let header=[], dataRows=[];
        if(headerLooksLikeData){ header=["date","description","debit","credit"]; dataRows=rows; }
        else { header=first.map(h=>String(h).trim().toLowerCase()); dataRows=rows.slice(1); }

        const idx=name=>header.findIndex(h=>h===name);
        const findCol=regex=>header.findIndex(h=>regex.test(h));
        let iDate=idx("date");             if(iDate<0)   iDate=findCol(/date/);
        let iDesc=idx("description");      if(iDesc<0)   iDesc=findCol(/desc|vendor|memo|details?/);
        let iAmount=idx("amount");         if(iAmount<0) iAmount=findCol(/amount/);
        let iDebit=idx("debit");           if(iDebit<0)  iDebit=findCol(/debit|withdrawal/);
        let iCredit=idx("credit");         if(iCredit<0) iCredit=findCol(/credit|deposit/);
        if(headerLooksLikeData){ iDate=0; iDesc=1; iDebit=2; iCredit=3; }

        if(iDate<0 || iDesc<0 || (iAmount<0 && iDebit<0 && iCredit<0)){
          set("err","Missing key columns (need date, description, and amount or debit/credit).");
          return;
        }

        const toNum=v=>{
          if(v==null) return 0;
          if(typeof v==="number") return v;
          let s=String(v).trim(); if(!s) return 0;
          const neg=/^\(.*\)$/.test(s);
          s=s.replace(/[(),$]/g,"").replace(/\s+/g,"");
          let n=Number(s.replace(/[^0-9.-]/g,""));
          if(Number.isNaN(n)) n=0;
          return neg? -Math.abs(n) : n;
        };

        const txns=[];
        for(let r=0;r<dataRows.length;r++){
          const row=dataRows[r]||[];
          const rawDate=row[iDate]; if(!rawDate) continue;
          let isoDate="";
          if(rawDate instanceof Date){ isoDate=rawDate.toISOString().slice(0,10); }
          else{
            const s=String(rawDate).trim();
            if(/^\d{2}\/\d{2}\/\d{4}$/.test(s)){ const [dd,mm,yyyy]=s.split("/"); isoDate=`${yyyy}-${mm}-${dd}`; }
            else{ const d=new Date(s); if(!isNaN(d.getTime())) isoDate=d.toISOString().slice(0,10); }
          }
          if(!isoDate) continue;

          const desc=String(row[iDesc]??"").trim(); if(!desc) continue;

          let amount=0, direction="debit";
          if(iAmount>=0){
            const a=toNum(row[iAmount]); if(a===0) continue;
            direction= a<0 ? "debit" : "credit";
            amount=Math.abs(a);
          } else {
            const d=iDebit>=0?toNum(row[iDebit]):0;
            const c=iCredit>=0?toNum(row[iCredit]):0;
            if(d===0 && c===0) continue;
            if(d!==0){ amount=Math.abs(d); direction="debit"; }
            else { amount=Math.abs(c); direction="credit"; }
          }

          txns.push({
            org_id:null, account_id:null,
            txn_date:isoDate, post_date:isoDate,
            description:desc, vendor_clean:desc,
            amount, direction, currency:"CAD",
            imported_from:file.name, csv_row:(headerLooksLikeData ? r+1 : r+2)
          });
        }

        if(!txns.length){ set("err","No valid transaction rows found."); return; }
        set("muted",`Uploading ${txns.length} transactionsâ€¦`);
        const {error}=await sb.from("transactions").insert(txns);
        if(error){ set("err","DB error: "+error.message); return; }

        set("ok",`Imported ${txns.length} transactions. Running strict matchâ€¦`);
        const {error:merr}=await sb.rpc("match_now");
        if(merr){ set("err","Imported, but matching failed: "+merr.message); return; }

        set("ok",`Imported ${txns.length} and ran matcher. Reloading listâ€¦`);
        await loadTransactions();
      }catch(e){
        console.error(e); set("err","Importer crashed: "+(e?.message||e));
      }
    };

    // --- Events & init
    qs("btnWeek").onclick = ()=>{ setRange("week");  loadTransactions(); };
    qs("btnMonth").onclick= ()=>{ setRange("month"); loadTransactions(); };
    qs("btnYear").onclick = ()=>{ setRange("year");  loadTransactions(); };
    qs("btnAll").onclick  = ()=>{ setRange("all");   loadTransactions(); };
    qs("loadBtn").onclick = loadTransactions;
    // Default: this month
    qs("fromDate").value = fmt(new Date(today.getFullYear(), today.getMonth(), 1));
    qs("toDate").value   = fmt(today);
    loadTransactions();
  </script>
</body>
</html>
