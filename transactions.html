<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kosmos ‚Äî Transactions</title>

  <!-- Shared theme -->
  <link rel="stylesheet" href="style.css" />

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <h1>Kosmos Bookkeeping</h1>
    <nav>
      <a href="index.html">Dashboard</a>
      <a href="receipts.html">Receipts</a>
      <a href="transactions.html" class="active">Transactions</a>
      <a href="reports.html">Reports</a>
    </nav>
  </header>

  <main class="container">
    <h2>üí≥ Transactions Overview</h2>
    <p class="muted">View, filter, and export all transactions. CSV imports work great; bank sync is hidden for now.</p>

    <!-- Filters -->
    <div class="card">
      <div class="row">
        <label>Date Range:</label>
        <input type="date" id="fromDate" />
        <span>‚Äì</span>
        <input type="date" id="toDate" />
        <select id="filterMode">
          <option value="all">All</option>
          <option value="matched">Matched</option>
          <option value="unmatched">Unmatched</option>
        </select>
        <button id="filterBtn">Apply</button>
        <button id="exportBtn" class="ghost">üìÅ Export CSV</button>
      </div>
    </div>

    <!-- Summary -->
    <div class="card">
      <div class="grid-2">
        <div><strong>Total Transactions:</strong> <span id="txnCount">‚Äî</span></div>
        <div><strong>Debits:</strong> <span id="debits">‚Äî</span></div>
        <div><strong>Credits:</strong> <span id="credits">‚Äî</span></div>
        <div><strong>Net:</strong> <span id="net">‚Äî</span></div>
      </div>
      <p class="muted" style="margin-top:8px;">Numbers reflect current filters.</p>
    </div>

    <!-- Table -->
    <div class="card">
      <table id="txnTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Description</th>
            <th class="right">Amount</th>
            <th>Type</th>
            <th>Source</th>
            <th>Institution</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

  <script>
    // ===== Supabase client =====
    const SUPABASE_URL = "https://advihqhjjlxumgdlbwui.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkdmlocWhqamx4dW1nZGxid3VpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMTg0MzIsImV4cCI6MjA3NjU5NDQzMn0.kVlaPQg2_o9DGJYv22Dgca7veok4drF6kgLPy2wPBeY";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ===== DOM helpers =====
    const qs = (id) => document.getElementById(id);
    const tableBody = qs("txnTable").querySelector("tbody");

    // ===== Data loading =====
    async function loadTransactions() {
      const from = qs("fromDate").value || "1900-01-01";
      const to   = qs("toDate").value   || "2999-12-31";
      const mode = qs("filterMode").value;

      let query = sb
        .from("transactions")
        .select("*")
        .gte("txn_date", from)
        .lte("txn_date", to)
        .order("txn_date", { ascending: false });

      // Matched/unmatched via matches table
      if (mode === "matched") {
        const ids = (await sb.from("matches").select("transaction_id")).data?.map(x => x.transaction_id) || [];
        query = query.in("id", ids);
      }
      if (mode === "unmatched") {
        const ids = (await sb.from("matches").select("transaction_id")).data?.map(x => x.transaction_id) || [];
        query = query.not("id", "in", ids);
      }

      const { data, error } = await query;
      if (error) {
        console.error(error);
        tableBody.innerHTML = `<tr><td colspan="6" class="err">${error.message}</td></tr>`;
        qs("txnCount").textContent = "‚Äî";
        qs("debits").textContent   = "‚Äî";
        qs("credits").textContent  = "‚Äî";
        qs("net").textContent      = "‚Äî";
        return;
      }
      renderTable(data);
    }

    function renderTable(data) {
      if (!data?.length) {
        tableBody.innerHTML = `<tr><td colspan="6" class="muted">No transactions found.</td></tr>`;
        qs("txnCount").textContent = 0;
        qs("debits").textContent   = "$0.00";
        qs("credits").textContent  = "$0.00";
        qs("net").textContent      = "$0.00";
        return;
      }

      let debitSum = 0, creditSum = 0;
      const rows = data.map(t => {
        const amt = Number(t.amount) || 0;
        if (t.direction === "debit") debitSum += amt; else creditSum += amt;

        return `<tr>
          <td>${t.txn_date ?? ""}</td>
          <td>${t.description ?? ""}</td>
          <td class="right">$${amt.toFixed(2)}</td>
          <td>${t.direction ?? ""}</td>
          <td>${t.source_account_name ?? ""}</td>
          <td>${t.institution ?? ""}</td>
        </tr>`;
      }).join("");

      tableBody.innerHTML = rows;
      qs("txnCount").textContent = data.length;
      qs("debits").textContent   = `$${debitSum.toFixed(2)}`;
      qs("credits").textContent  = `$${creditSum.toFixed(2)}`;
      qs("net").textContent      = `$${(creditSum - debitSum).toFixed(2)}`;
    }

    // ===== Export receipts CSV (uses accountant view) =====
    async function exportCSV() {
      const { data, error } = await sb.from("v_accountant_export_receipts").select("*");
      if (error || !data?.length) { alert("No export data."); return; }

      const header = Object.keys(data[0]);
      const rows = data.map(r => header.map(h => JSON.stringify(r[h] ?? "")).join(","));
      const csv = [header.join(","), ...rows].join("\n");

      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "accountant_export.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // ===== Events =====
    qs("filterBtn").addEventListener("click", loadTransactions);
    qs("exportBtn").addEventListener("click", exportCSV);

    // Initial load
    loadTransactions();
  </script>
</body>
</html>
