<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Kosmos Bookkeeping ‚Äî Transactions</title>
  <link rel="stylesheet" href="style.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{padding:4px 10px;border:1px solid var(--border);border-radius:999px;background:#fff}
    .right{text-align:right}
    .muted{color:var(--muted)} .err{color:var(--err)} .ok{color:var(--ok)}
    .status-pill{font-size:.75rem;padding:4px 10px;border-radius:999px;border:1px solid var(--border);background:#fff;white-space:nowrap}
    .status-pill.ok{background:#ecfdf5;border-color:#a7f3d0}
    .status-pill.dim{opacity:.75}
    .upload-btn{font-size:.8rem;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#f9f9f9;cursor:pointer}
    .cat-select{min-width:150px}
    .save-mark{font-size:12px;margin-left:6px;opacity:0;transition:opacity .2s}
    .save-mark.show{opacity:1}
    .link{color:#2563eb;text-decoration:none}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.18);display:none;align-items:flex-start;justify-content:center;padding:40px 12px;z-index:50}
    .modal{background:#fff;width:min(1100px,100%);max-height:85vh;overflow:auto;border:1px solid var(--border);border-radius:16px;padding:16px}
    .hidden{display:none}
    .grid-2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .grid-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-weight:600}
    .hl{outline:3px solid var(--brand);box-shadow:0 0 0 4px color-mix(in oklab, var(--brand) 18%, transparent)}
    .banner{display:flex;gap:10px;align-items:center;padding:8px 12px;border:1px dashed var(--border);border-radius:12px;background:#fafafa}
    .row-actions{display:flex;gap:8px;flex-wrap:wrap}
  </style>
</head>
<body>
<header>
  <h1>Kosmos Bookkeeping</h1>
  <nav>
    <a href="index.html">Dashboard</a>
    <a href="receipts.html">Receipts</a>
    <a class="active" href="transactions.html">Transactions</a>
    <a href="reports.html">Reports</a>
  </nav>
</header>

<main class="container">
  <h2>üí≥ Transactions</h2>
  <p class="muted">Filter, import, categorize, attach receipts, link existing receipts, and track sources.</p>

  <!-- Pending link banner (appears when focus_receipt=...) -->
  <div id="linkBanner" class="banner hidden">
    <div>üîó Linking receipt <code id="bannerRid"></code> ‚Äî <span id="bannerMeta" class="muted"></span></div>
    <span class="pill">Tip: rows with same amount & ¬±5 days show a ‚ÄúLink to this‚Äù button.</span>
    <span style="flex:1 1 auto"></span>
    <button id="pickReceiptBtn" class="ghost">Choose receipt‚Ä¶</button>
    <button id="clearLinkBtn" class="ghost">Clear</button>
  </div>

  <div class="card" style="margin-top:10px;margin-bottom:14px;">
    <div class="toolbar">
      <label>Date Range:</label>
      <input id="fromDate" type="date"/><span>‚Äì</span><input id="toDate" type="date"/>
      <select id="typeFilter" title="Filter">
        <option value="all">All</option>
        <option value="debit">Debits only</option>
        <option value="credit">Credits only</option>
        <option value="uncategorized">Uncategorized</option>
        <option value="no_source">No Source</option>
        <option value="matched">Matched only</option>
        <option value="unmatched">Unmatched only</option>
      </select>
      <button id="applyBtn">Apply</button>
      <input id="quickSearch" placeholder="Search description/category/source‚Ä¶" style="flex:1;min-width:220px"/>
      <button id="importBtn" class="ghost">üì• Import CSV</button>
      <button id="exportBtn" class="ghost">‚¨áÔ∏è Export CSV</button>
    </div>
    <div class="row" style="gap:10px;margin-top:10px;">
      <span class="pill">Matched: <b id="chipMatched">‚Äî</b></span>
      <span class="pill">Unmatched: <b id="chipUnmatched">‚Äî</b></span>
      <span class="pill">Uncategorized: <b id="chipUncat">‚Äî</b></span>
      <span class="pill">No Source: <b id="chipNoSource">‚Äî</b></span>
      <span class="pill">Duplicates: <b id="chipDupes">‚Äî</b></span>
    </div>
  </div>

  <div class="card" style="margin-bottom:14px;">
    <div>Total Transactions: <b id="totalRows">‚Äî</b></div>
    <div>Debits: <b id="totalDebits">$0.00</b></div>
    <div>Credits: <b id="totalCredits">$0.00</b></div>
    <div>Net: <b id="totalNet">$0.00</b></div>
    <small class="muted">Numbers reflect the current filter.</small>
    <div id="pageError" class="err small" style="margin-top:6px"></div>
  </div>

  <div class="card">
    <table id="txTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Description</th>
          <th class="right">Amount</th>
          <th>Type</th>
          <th>Category</th>
          <th>Source</th>
          <th>Status</th>
          <th>Receipt</th>
        </tr>
      </thead>
      <tbody id="txBody"></tbody>
    </table>
    <div class="muted" id="rowsCount" style="margin-top:8px">Rows: 0</div>
  </div>
</main>

<!-- Import Modal (unchanged) -->
<div id="impBackdrop" class="modal-backdrop">
  <div class="modal">
    <h3>Import Transactions (CSV)</h3>
    <p class="note muted small">Mapping is <b>A=Date</b>, <b>B=Description</b>, <b>C=Debit</b>, <b>D=Credit</b>.</p>
    <div class="card" style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
      <input id="csvFile" type="file" accept=".csv,text/csv"/>
      <button id="closeImport" class="ghost">Close</button>
    </div>
    <div class="row" style="gap:10px;align-items:center;margin-top:10px">
      <label for="fileSourceSelect"><b>Source for this file:</b></label>
      <select id="fileSourceSelect"></select>
      <input id="fileSourceCustom" class="hidden" placeholder="Type custom source‚Ä¶"/>
    </div>
    <p id="impStatus" class="muted small" style="margin-top:10px;">Select a CSV to begin.</p>
    <div class="kpill small" id="countPill" style="display:inline-block;margin-top:6px;">Parsed ‚Äî ¬∑ Valid ‚Äî ¬∑ Skipped ‚Äî ¬∑ Debits ‚Äî ¬∑ Credits ‚Äî</div>
    <div id="impPreview" class="card" style="margin-top:12px;display:none;">
      <h4 style="margin:0 0 8px 0">Preview (first 20 rows)</h4>
      <table style="width:100%;border-collapse:collapse;">
        <thead><tr><th>Date</th><th>Description</th><th class="right">Amount</th><th>Direction</th><th>Source</th></tr></thead>
        <tbody id="prevBody"><tr><td colspan="5" class="muted">No rows yet</td></tr></tbody>
      </table>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:12px">
      <button id="importGo" class="ghost">Import</button>
    </div>
  </div>
</div>

<!-- Upload Modal (new or same as before) -->
<div id="uploadBackdrop" class="modal-backdrop">
  <div class="modal">
    <h3>Attach Receipt ‚Äî Review & Save</h3>
    <p id="upDesc" class="muted small" style="margin-top:-6px"></p>

    <div class="grid-2" style="margin-top:12px">
      <div class="field"><label>Vendor *</label><input id="upVendor"/></div>
      <div class="field"><label>Receipt Date *</label><input id="upDate" type="date"/></div>
    </div>
    <div class="grid-3" style="margin-top:8px">
      <div class="field"><label>Total *</label><input id="upTotal" type="number" step="0.01" min="0"/></div>
      <div class="field"><label>Tax *</label><input id="upTax" type="number" step="0.01" min="0" placeholder="0.00"/></div>
      <div class="field"><label>Category *</label><select id="upCategory"></select></div>
    </div>
    <div class="field" style="margin-top:8px"><label>Source *</label><input id="upSource"/></div>
    <div class="field" style="margin-top:8px"><label>Image *</label><input id="uploadFile" type="file" accept="image/*" capture="environment"/></div>

    <p id="uploadError" class="err small" style="margin-top:6px"></p>
    <p id="uploadStatus" class="small muted" style="margin-top:4px;"></p>

    <div class="row" style="justify-content:flex-end;margin-top:12px">
      <button id="cancelUpload" class="ghost">Cancel</button>
      <button id="confirmUpload">Save receipt</button>
    </div>
  </div>
</div>

<!-- Link Existing Receipt Modal -->
<div id="linkBackdrop" class="modal-backdrop">
  <div class="modal">
    <h3>Link Existing Receipt</h3>
    <p class="muted small" id="linkHelp">Showing unmatched receipts. Use search or adjust filters.</p>

    <div class="grid-3" style="margin-top:8px">
      <div class="field"><label>Search</label><input id="linkSearch" placeholder="Vendor, notes, source‚Ä¶"/></div>
      <div class="field"><label>Date ¬± days</label><input id="linkDays" type="number" min="0" value="5"/></div>
      <div class="field"><label>Amount tolerance</label><input id="linkTol" type="number" step="0.01" min="0" value="0.01"/></div>
    </div>

    <div class="card" style="margin-top:10px;max-height:50vh;overflow:auto">
      <table style="width:100%;border-collapse:collapse;">
        <thead>
          <tr><th>Date</th><th>Vendor</th><th class="right">Total</th><th>Tax</th><th>Category</th><th>Source</th><th>Actions</th></tr>
        </thead>
        <tbody id="linkBody"><tr><td colspan="7" class="muted">Loading‚Ä¶</td></tr></tbody>
      </table>
    </div>

    <div class="row" style="justify-content:flex-end;margin-top:12px">
      <button id="linkClose" class="ghost">Close</button>
    </div>
  </div>
</div>

<script>
(function(){
  const sb = supabase.createClient(
    "https://advihqhjjlxumgdlbwui.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkdmlocWhqamx4dW1nZGxid3VpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMTg0MzIsImV4cCI6MjA3NjU5NDQzMn0.kVlaPQg2_o9DGJYv22Dgca7veok4drF6kgLPy2wPBeY"
  );

  const $ = id => document.getElementById(id);
  const money = n => (n==null?0:n).toLocaleString(undefined,{style:"currency",currency:"CAD"});
  const esc = s => String(s??"").replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]));

  // Locked categories (keep in sync with receipts)
  const CATEGORY_OPTIONS = [
    "Uncategorized","Income","Sales","Refunds",
    "Restaurant (Food & Supplies)","Alcohol","Software","Subscriptions",
    "Travel","Lodging","Fuel","Utilities","Phone/Internet","Office",
    "Professional Fees","Bank Fees","Taxes","Insurance",
    "Repairs & Maintenance","Building Maintenance","Miscellaneous","Other"
  ];

  // state
  let pendingReceipt = null;     // { id, date, total }
  let rows = [];                 // transactions
  let matchMap = new Map();      // txn_id -> {receipt_id, confidence}

  function renderCategorySelect(value, id){
    const opts = CATEGORY_OPTIONS.map(c=>`<option value="${esc(c)}"${c===value?' selected':''}>${esc(c)}</option>`).join("");
    return `<select class="cat-select" data-txn="${id}" onchange="updateCategory(this)">${opts}</select><span class="save-mark" id="sv_${id}">‚úì saved</span>`;
  }
  window.updateCategory = async (sel)=>{
    const id = sel.getAttribute("data-txn");
    const { error } = await sb.from("transactions").update({ category: sel.value||null }).eq("id", id);
    const mark = $("sv_"+id);
    if(error){ sel.classList.add("err"); if(mark){ mark.textContent="‚úó error"; mark.classList.add("show"); } return; }
    sel.classList.remove("err"); if(mark){ mark.textContent="‚úì saved"; mark.classList.add("show"); setTimeout(()=>mark.classList.remove("show"),1200); }
  };

  function showError(msg){ $("pageError").textContent = msg||""; }

  // load transactions + matches
  async function loadTransactions(){
    showError("");

    const from = $("fromDate").value || null;
    const to   = $("toDate").value || null;
    const type = $("typeFilter").value;
    const q    = $("quickSearch").value.trim().toLowerCase();

    let query = sb.from("transactions").select("id, txn_date, description, amount, direction, category, source_account_name");
    if(from) query = query.gte("txn_date", from);
    if(to)   query = query.lte("txn_date", to);
    if(type==="debit")  query = query.eq("direction","debit");
    if(type==="credit") query = query.eq("direction","credit");

    const { data, error } = await query.order("txn_date",{ascending:false});
    if(error){ showError(error.message); $("txBody").innerHTML=""; $("rowsCount").textContent="Rows: 0"; return; }
    rows = data || [];

    // matches
    matchMap = new Map();
    try{
      const ids = rows.map(r=>r.id);
      if(ids.length){
        const { data: mm } = await sb.from("matches")
          .select("transaction_id, receipt_id, confidence")
          .in("transaction_id", ids);
        (mm||[]).forEach(m=>{
          if(!matchMap.has(m.transaction_id)) matchMap.set(m.transaction_id, m);
        });
      }
    }catch(e){ /* ignore */ }

    renderRows();
  }

  function withinDays(txnDateISO, recDateISO, days){
    if(!txnDateISO || !recDateISO) return false;
    const t = new Date(txnDateISO+"T00:00:00Z").getTime();
    const r = new Date(recDateISO+"T00:00:00Z").getTime();
    const diff = Math.abs(t - r) / 86400000;
    return diff <= (days||5);
  }

  function isCandidate(r, row){
    if(!pendingReceipt) return false;
    const amtOk = Math.abs((+row.amount||0) - (+pendingReceipt.total||0)) <= 0.01;
    const dateOk = withinDays(row.txn_date, pendingReceipt.date, 5);
    return amtOk && dateOk;
  }

  async function renderRows(){
    // totals and chips
    const deb = rows.filter(r=>r.direction==='debit').reduce((s,r)=>s+(+r.amount||0),0);
    const cre = rows.filter(r=>r.direction==='credit').reduce((s,r)=>s+(+r.amount||0),0);
    $("totalRows").textContent   = rows.length;
    $("totalDebits").textContent = money(deb);
    $("totalCredits").textContent= money(cre);
    $("totalNet").textContent    = money(cre-deb);

    const uncat = rows.filter(r => !r.category || r.category==="Uncategorized").length;
    const noSrc = rows.filter(r => !r.source_account_name).length;
    const mat   = rows.filter(r => matchMap.has(r.id)).length;
    const unmat = rows.length - mat;
    $("chipUncat").textContent     = uncat;
    $("chipNoSource").textContent  = noSrc;
    $("chipMatched").textContent   = mat;
    $("chipUnmatched").textContent = unmat;

    // render table
    $("txBody").innerHTML = rows.map(r=>{
      const m = matchMap.get(r.id);
      const matched = !!m;
      const statusHtml = matched
        ? `<span class="status-pill ok" title="Confidence ${m.confidence ?? 1}">Matched</span>`
        : `<span class="status-pill dim">Unmatched</span>`;

      // Actions cell:
      // - if already matched: link
      // - if pendingReceipt set and row is candidate: show "Link to this"
      // - otherwise: offer Upload or "Link existing‚Ä¶"
      let actionsHtml = "";
      if(matched){
        actionsHtml = `<a class="link" href="receipts.html#${esc(m.receipt_id||'')}" title="Open receipt">View</a>`;
      }else if(pendingReceipt && isCandidate(pendingReceipt, r)){
        actionsHtml = `
          <div class="row-actions">
            <button class="upload-btn" onclick="linkNow('${r.id}')">Link to this</button>
            <button class="upload-btn" onclick="openLinkPicker('${r.id}')">Link existing‚Ä¶</button>
            <button class="upload-btn" onclick="openUpload('${r.id}')">üì∑ Upload</button>
          </div>`;
      }else{
        actionsHtml = `
          <div class="row-actions">
            <button class="upload-btn" onclick="openUpload('${r.id}')">üì∑ Upload</button>
            <button class="upload-btn" onclick="openLinkPicker('${r.id}')">Link existing‚Ä¶</button>
          </div>`;
      }

      return `
        <tr data-id="${r.id}">
          <td>${esc(r.txn_date||"")}</td>
          <td>${esc(r.description||"")}</td>
          <td class="right">${money(r.amount)}</td>
          <td>${esc(r.direction||"")}</td>
          <td>${renderCategorySelect(r.category||"Uncategorized", r.id)}</td>
          <td>${esc(r.source_account_name||"")}</td>
          <td>${statusHtml}</td>
          <td>${actionsHtml}</td>
        </tr>
      `;
    }).join("");
    $("rowsCount").textContent = `Rows: ${rows.length}`;

    // highlight candidates
    if(pendingReceipt){
      const candIds = rows.filter(r=>isCandidate(pendingReceipt, r)).map(r=>r.id);
      candIds.forEach(id=>{
        const row = document.querySelector(`#txTable tbody tr[data-id="${id}"]`);
        if(row){ row.classList.add('hl'); setTimeout(()=>row.classList.remove('hl'), 2000); }
      });
      if(candIds.length===1){
        const row = document.querySelector(`#txTable tbody tr[data-id="${candIds[0]}"]`);
        if(row) row.scrollIntoView({behavior:'smooth', block:'center'});
      }
    }
  }

  // ---------- Manual link flow ----------
  async function fetchReceiptMeta(id){
    const { data, error } = await sb.from('receipts')
      .select('id, receipt_date, total, vendor, source, category')
      .eq('id', id).single();
    if(error) throw error;
    return data;
  }

  async function doLink(transaction_id, receipt_id){
    // fetch receipt for amount to store as matched_amount
    const { data: rec } = await sb.from('receipts').select('total').eq('id', receipt_id).single();
    const matched_amount = rec?.total ?? null;
    const { error } = await sb.from('matches').insert([{
      org_id: null, transaction_id, receipt_id,
      matched_amount, confidence: 1, method: 'manual', match_type: 'exact'
    }]);
    if(error) throw error;
  }

  // quick button when a row matches the candidate rules
  window.linkNow = async (txnId)=>{
    if(!pendingReceipt){ alert("No receipt selected."); return; }
    try{
      await doLink(txnId, pendingReceipt.id);
      // clear banner/hash and refresh
      clearPending();
      await loadTransactions();
      alert("Linked!");
    }catch(e){ alert("Link failed: "+(e?.message||e)); }
  };

  // ---------- Link picker modal (unmatched receipts) ----------
  let currentLinkTxn = null;
  $("pickReceiptBtn").onclick = ()=>{ if(!rows.length){return;} openLinkPicker(); };
  $("clearLinkBtn").onclick = ()=>{ clearPending(); renderRows(); };

  function clearPending(){
    pendingReceipt = null;
    $("linkBanner").classList.add('hidden');
    history.replaceState(null, "", "transactions.html");
  }

  async function openLinkPicker(txnId){
    currentLinkTxn = txnId || null;
    $("linkBackdrop").style.display = "flex";
    $("linkBody").innerHTML = `<tr><td colspan="7" class="muted">Loading‚Ä¶</td></tr>`;
    await populateLinkList();
  }
  $("linkClose").onclick = ()=>{ $("linkBackdrop").style.display="none"; };

  $("linkSearch").addEventListener("input", ()=>{
    clearTimeout(window.__lkT); window.__lkT=setTimeout(populateLinkList, 200);
  });
  $("linkDays").addEventListener("change", populateLinkList);
  $("linkTol").addEventListener("change", populateLinkList);

  async function populateLinkList(){
    const q = ($("linkSearch").value||"").toLowerCase().trim();
    const days = Math.max(0, Number($("linkDays").value||5));
    const tol  = Math.max(0, Number($("linkTol").value||0.01));
    let tx = null;
    if(currentLinkTxn){
      tx = rows.find(r=>r.id===currentLinkTxn) || null;
    }

    // load unmatched receipts
    const { data: recsRaw } = await sb
      .from('receipts')
      .select('id, receipt_date, total, tax, category, vendor, source, notes')
      .order('receipt_date', { ascending:false });

    // remove those already matched
    const { data: matched } = await sb.from('matches').select('receipt_id');
    const matchedSet = new Set((matched||[]).map(m=>m.receipt_id));
    let recs = (recsRaw||[]).filter(r=> !matchedSet.has(r.id) );

    // filter by picker context
    if(tx){
      recs = recs.filter(r=>{
        const amtOk = Math.abs((+r.total||0) - (+tx.amount||0)) <= tol;
        const dateOk = withinDays(tx.txn_date, r.receipt_date, days);
        return amtOk && dateOk;
      });
    }

    // search term
    if(q){
      recs = recs.filter(r =>
        (r.vendor||"").toLowerCase().includes(q) ||
        (r.source||"").toLowerCase().includes(q) ||
        (r.category||"").toLowerCase().includes(q) ||
        (r.notes||"").toLowerCase().includes(q)
      );
    }

    if(!recs.length){
      $("linkBody").innerHTML = `<tr><td colspan="7" class="muted">No unmatched receipts found for current filters.</td></tr>`;
      return;
    }

    $("linkBody").innerHTML = recs.map(r=>`
      <tr>
        <td>${esc((r.receipt_date||"").slice(0,10))}</td>
        <td>${esc(r.vendor||"")}</td>
        <td class="right">${money(r.total||0)}</td>
        <td>${esc(r.tax==null?"":r.tax)}</td>
        <td>${esc(r.category||"")}</td>
        <td>${esc(r.source||"")}</td>
        <td>
          <button class="upload-btn" onclick="pickLink('${r.id}')">Link</button>
          ${r.notes?`<span class="muted small" style="margin-left:6px" title="${esc(r.notes)}">üõà</span>`:""}
        </td>
      </tr>
    `).join("");
  }

  window.pickLink = async (receiptId)=>{
    // If opened for a specific transaction, link to it; else require a click on a row first
    const txnId = currentLinkTxn || (function(){
      const row = document.querySelector('#txTable tbody tr.hl');
      return row?.getAttribute('data-id') || null;
    })();

    if(!txnId){ alert("Choose a transaction row first."); return; }
    try{
      await doLink(txnId, receiptId);
      $("linkBackdrop").style.display="none";
      clearPending();
      await loadTransactions();
      alert("Linked!");
    }catch(e){ alert("Link failed: "+(e?.message||e)); }
  };

  // ---------- Upload modal (unchanged logic) ----------
  let currentTxn=null;
  function applyCategoryOptions(selected){
    const opts=CATEGORY_OPTIONS.map(c=>`<option value="${esc(c)}"${c===selected?' selected':''}>${esc(c)}</option>`).join("");
    $("upCategory").innerHTML=opts;
    if(selected && CATEGORY_OPTIONS.includes(selected)) $("upCategory").value=selected;
    else if(CATEGORY_OPTIONS.includes("Uncategorized")) $("upCategory").value="Uncategorized";
  }
  async function openUpload(id){
    const { data: row, error } = await sb.from("transactions").select("id, txn_date, description, amount, source_account_name, category").eq("id", id).single();
    if(error || !row){ alert("Transaction not found."); return; }
    currentTxn={ id:row.id, desc:row.description||"", date:(row.txn_date||"").slice(0,10), amt:Number(row.amount)||0, source:row.source_account_name||"", category:row.category||"Uncategorized" };
    $("upDesc").textContent = `${currentTxn.desc} ‚Äî ${money(currentTxn.amt)} on ${currentTxn.date}`;
    $("uploadFile").value=""; $("uploadError").textContent=""; $("uploadStatus").textContent="";
    $("upVendor").value=currentTxn.desc; $("upDate").value=currentTxn.date; $("upTotal").value=currentTxn.amt?currentTxn.amt.toFixed(2):""; $("upTax").value="0.00"; $("upSource").value=currentTxn.source;
    applyCategoryOptions(currentTxn.category); $("uploadBackdrop").style.display="flex";
  }
  window.openUpload=openUpload;
  $("cancelUpload").onclick = ()=>{ $("uploadBackdrop").style.display="none"; };
  function valNumber(el){ const n=Number(el.value); return Number.isFinite(n)?n:NaN; }

  $("confirmUpload").onclick = async ()=>{
    $("uploadError").textContent=""; $("uploadStatus").textContent="";
    const vendor=$("upVendor").value.trim(), date=$("upDate").value, total=valNumber($("upTotal")), tax=valNumber($("upTax")), cat=$("upCategory").value, src=$("upSource").value.trim(), file=$("uploadFile").files[0];
    if(!vendor || !date || !src || !file || !Number.isFinite(total) || !Number.isFinite(tax)){ $("uploadError").textContent="Please complete all fields."; return; }
    if(total<0 || tax<0){ $("uploadError").textContent="Amounts must be zero or positive."; return; }
    if(tax>total){ $("uploadError").textContent="Tax cannot exceed Total."; return; }

    $("uploadStatus").textContent="Uploading image‚Ä¶";
    const filename=`${Date.now()}_${file.name}`;
    const { error: upErr } = await sb.storage.from("receipts-warm").upload(filename, file);
    if(upErr){ $("uploadStatus").textContent=""; $("uploadError").textContent="Upload failed: "+upErr.message; return; }
    const imageUrl=`https://advihqhjjlxumgdlbwui.supabase.co/storage/v1/object/public/receipts-warm/${filename}`;

    $("uploadStatus").textContent="Saving receipt‚Ä¶";
    const { data: orgRow } = await sb.from("orgs").select("id").limit(1).single();
    const org_id = orgRow?.id || null;

    const { data: rIns, error: rErr } = await sb.from("receipts").insert([{
      org_id, account_id:null, image_url:imageUrl, size_bytes:file.size||0,
      receipt_date:date, total:total, tax:tax, category:cat||null, vendor:vendor,
      source:src, notes:`Uploaded from transaction view for txn ${currentTxn?.id}`, entered_by:"You"
    }]).select("id").single();
    if(rErr){ $("uploadStatus").textContent=""; $("uploadError").textContent="Insert failed: "+rErr.message; return; }

    const receipt_id=rIns?.id; if(receipt_id && currentTxn?.id){
      await sb.from("matches").insert([{ org_id, transaction_id: currentTxn.id, receipt_id, matched_amount: total, confidence: 1, method:"manual", match_type:"exact" }]);
    }
    $("uploadStatus").textContent="‚úÖ Saved & linked!";
    setTimeout(async ()=>{ $("uploadBackdrop").style.display="none"; await loadTransactions(); }, 700);
  };

  // ---------- Importer (unchanged) ----------
  let __valid=[]; let __skipped=[];
  function detectDelimiterBlock(sample){ const c=(sample.match(/,/g)||[]).length, s=(sample.match(/;/g)||[]).length, t=(sample.match(/\t/g)||[]).length; if(Math.max(c,s,t)===s) return ";"; if(Math.max(c,s,t)===t) return "\t"; return ","; }
  function parseLine(line, delim){ const out=[]; let cur='',q=false; for(let i=0;i<line.length;i++){ const ch=line[i]; if(ch==='"'){ if(q&&line[i+1]==='"'){cur+='"';i++;} else q=!q; } else if(ch===delim && !q){ out.push(cur); cur=''; } else cur+=ch; } out.push(cur); return out.map(x=>x.trim()); }
  function parseCSV(text){ const sample=text.split(/\r?\n/).slice(0,8).join("\n"); const delim=detectDelimiterBlock(sample); const lines=text.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n"); const rows=lines.map(l=> l.trim()==="" ? null : parseLine(l,delim)); return { rows, delim }; }
  function isDateLike(s){ if(!s) return false; const t=String(s).trim(); if(/^\d{4}[-/]\d{2}[-/]\d{2}$/.test(t)) return true; const d=new Date(t); return !isNaN(d.valueOf()); }
  function toISO(s){ if(!s) return null; const t=String(s).trim(); if(/^\d{4}[-/]\d{2}[-/]\d{2}$/.test(t)) return t.replace(/\//g,"-"); const d=new Date(t); if(isNaN(d.valueOf())) return null; return d.toISOString().slice(0,10); }
  function parseNum(s){ if(s==null) return null; let v=String(s).trim(); if(!v) return null; const paren=/^\(.*\)$/.test(v); if(paren) v=v.replace(/[()]/g,""); v=v.replace(/\$/g,"").replace(/,/g,""); const n=Number(v); if(Number.isNaN(n)) return null; return paren?-Math.abs(n):n; }

  async function populateSourceOptions(){
    const sel=$("fileSourceSelect"), custom=$("fileSourceCustom"); sel.innerHTML="";
    const fixed=["CIBC Bank Account","PC MasterCard","Rogers MasterCard","Cash"];
    fixed.forEach(name=> sel.insertAdjacentHTML("beforeend", `<option value="${esc(name)}">${esc(name)}</option>`));
    const { data: accs } = await sb.from("accounts").select("name").order("name");
    const have=new Set(fixed); (accs||[]).forEach(a=>{ if(a?.name && !have.has(a.name)){ sel.insertAdjacentHTML("beforeend", `<option value="${esc(a.name)}">${esc(a.name)} (seen)</option>`); have.add(a.name);} });
    sel.insertAdjacentHTML("beforeend", `<option value="__custom__">Custom‚Ä¶</option>`);
    const custom=$("fileSourceCustom");
    custom.classList.add("hidden");
    sel.onchange = ()=>{ if(sel.value==="__custom__") custom.classList.remove("hidden"); else custom.classList.add("hidden"); };
    sel.value="CIBC Bank Account";
  }

  $("importBtn").onclick = async ()=>{ $("impBackdrop").style.display="flex"; $("impStatus").textContent="Select a CSV to begin."; $("impPreview").style.display="none"; $("csvFile").value=""; $("countPill").textContent="Parsed ‚Äî ¬∑ Valid ‚Äî ¬∑ Skipped ‚Äî ¬∑ Debits ‚Äî ¬∑ Credits ‚Äî"; await populateSourceOptions(); };
  $("closeImport").onclick = ()=>{ $("impBackdrop").style.display="none"; };

  $("csvFile").addEventListener("change", async (e)=>{
    __valid=[]; __skipped=[];
    const f=e.target.files?.[0]; if(!f) return;
    $("impStatus").textContent="Reading file‚Ä¶";
    const text=await f.text(); const { rows }=parseCSV(text);
    const parsed=rows.filter(r=>r!==undefined).length;
    const nonBlank=rows.filter(r=> r && r.some(x=>String(x).trim().length));
    if(nonBlank.length===0){ $("impStatus").className="err small"; $("impStatus").textContent="No rows detected."; $("impPreview").style.display="none"; $("countPill").textContent=`Parsed ${parsed} ¬∑ Valid 0 ¬∑ Skipped ${parsed} ¬∑ Debits 0 ¬∑ Credits 0`; return; }

    let start=0; if(nonBlank[0] && !isDateLike(nonBlank[0][0])) start=1;
    const DATE_COL=0,DESC_COL=1,DEBIT_COL=2,CREDIT_COL=3;
    let debSum=0, credSum=0, valid=0;

    const srcSel=$("fileSourceSelect"), srcCustom=$("fileSourceCustom");
    const previewSource = srcSel.value==="__custom__" ? srcCustom.value.trim() : srcSel.value;

    for(let i=start;i<nonBlank.length;i++){
      const r=nonBlank[i];
      const date=toISO(r[DATE_COL]); const desc=String(r[DESC_COL]||"").trim();
      if(!date || !desc){ __skipped.push({line:i+1,reason:'bad date/desc'}); continue; }
      const dVal=parseNum(r[DEBIT_COL]), cVal=parseNum(r[CREDIT_COL]);
      let amount=null, direction=null;
      if(cVal!=null && cVal>0){ amount=Math.abs(cVal); direction='credit'; credSum+=amount; }
      else if(dVal!=null && dVal!==0){ amount=Math.abs(dVal); direction='debit'; debSum+=amount; }
      else { __skipped.push({line:i+1,reason:'no debit/credit'}); continue; }
      __valid.push({date, desc, amount, direction, source: previewSource||null}); valid++;
    }
    const skippedCount=Math.max(parsed - (start>0?1:0) - valid, 0);
    $("countPill").textContent=`Parsed ${parsed} ¬∑ Valid ${valid} ¬∑ Skipped ${skippedCount} ¬∑ Debits ${debSum.toFixed(2)} ¬∑ Credits ${credSum.toFixed(2)}`;

    if(valid===0){ $("impStatus").className="err small"; $("impStatus").textContent="No valid rows after parsing."; $("impPreview").style.display="none"; return; }

    const first20=__valid.slice(0,20);
    $("prevBody").innerHTML=first20.map(v=>`
      <tr><td>${esc(v.date)}</td><td>${esc(v.desc)}</td><td class="right">${money(v.amount)}</td><td>${v.direction}</td><td>${esc(v.source||"")}</td></tr>
    `).join("");
    $("impPreview").style.display="block"; $("impStatus").className="muted small"; $("impStatus").textContent=`Ready to import ${valid} transactions.`;
  });

  $("importGo").onclick = async ()=>{
    if(!__valid.length){ alert("No valid rows."); return; }
    const sel=$("fileSourceSelect"), custom=$("fileSourceCustom");
    let chosen = sel.value==="__custom__" ? custom.value.trim() : sel.value;
    if(!chosen){ alert("Choose a Source for this file."); sel.focus(); return; }
    __valid = __valid.map(v=>({...v, source: chosen}));
    $("impStatus").className="muted small"; $("impStatus").textContent=`Importing ${__valid.length} transactions‚Ä¶`;

    const rowsIns = __valid.map(v=>({
      txn_date: v.date, post_date: v.date, description: v.desc,
      amount: v.amount, direction: v.direction, category: "Uncategorized",
      source_account_name: v.source, currency:"CAD", imported_via:"csv"
    }));
    try{
      for(let i=0;i<rowsIns.length;i+=300){
        const chunk=rowsIns.slice(i,i+300);
        const { error } = await sb.from("transactions").insert(chunk);
        if(error) throw error;
        $("impStatus").textContent=`Importing ${rowsIns.length}‚Ä¶ ${Math.min(i+300,rowsIns.length)}/${rowsIns.length}`;
      }
      $("impStatus").className="ok small"; $("impStatus").textContent=`‚úÖ Imported ${rowsIns.length}.`;
      $("impBackdrop").style.display="none"; await loadTransactions();
    }catch(err){ $("impStatus").className="err small"; $("impStatus").textContent=String(err.message||err); }
  };

  // ---------- Deep-link + banner ----------
  async function handleDeepLink(){
    const hash = window.location.hash || '';
    const rcpMatch = hash.match(/focus_receipt=([0-9a-f-]{36})/i);
    if(rcpMatch){
      try{
        const meta = await fetchReceiptMeta(rcpMatch[1]);
        pendingReceipt = { id: meta.id, date: meta.receipt_date?.slice(0,10) || null, total: +meta.total || 0 };
        $("linkBanner").classList.remove('hidden');
        $("bannerRid").textContent = pendingReceipt.id.slice(0,8);
        $("bannerMeta").textContent = `${money(pendingReceipt.total)} on ${pendingReceipt.date||'‚Äî'}`;
      }catch(_){}
    }
    await loadTransactions();
  }

  // expose for onclicks
  window.openLinkPicker = openLinkPicker;

  // UI wire-up
  $("applyBtn").onclick = loadTransactions;
  $("quickSearch").addEventListener("input", ()=>{ clearTimeout(window.__qsT); window.__qsT=setTimeout(loadTransactions,150); });
  window.addEventListener('load', handleDeepLink);

  // ---------- Upload modal handlers (same as earlier) ----------
  let currentTxn=null;
  function applyCategoryOptions(selected){
    const opts=CATEGORY_OPTIONS.map(c=>`<option value="${esc(c)}"${c===selected?' selected':''}>${esc(c)}</option>`).join("");
    $("upCategory").innerHTML=opts;
    if(selected && CATEGORY_OPTIONS.includes(selected)) $("upCategory").value=selected;
    else if(CATEGORY_OPTIONS.includes("Uncategorized")) $("upCategory").value="Uncategorized";
  }
  window.openUpload = async (id)=>{
    const { data: row, error } = await sb.from("transactions").select("id, txn_date, description, amount, source_account_name, category").eq("id", id).single();
    if(error || !row){ alert("Transaction not found."); return; }
    currentTxn={ id:row.id, desc:row.description||"", date:(row.txn_date||"").slice(0,10), amt:Number(row.amount)||0, source:row.source_account_name||"", category:row.category||"Uncategorized" };
    $("upDesc").textContent = `${currentTxn.desc} ‚Äî ${money(currentTxn.amt)} on ${currentTxn.date}`;
    $("uploadFile").value=""; $("uploadError").textContent=""; $("uploadStatus").textContent="";
    $("upVendor").value=currentTxn.desc; $("upDate").value=currentTxn.date; $("upTotal").value=currentTxn.amt?currentTxn.amt.toFixed(2):""; $("upTax").value="0.00"; $("upSource").value=currentTxn.source;
    applyCategoryOptions(currentTxn.category); $("uploadBackdrop").style.display="flex";
  };
  $("cancelUpload").onclick = ()=>{ $("uploadBackdrop").style.display="none"; };
  function valNumber(el){ const n=Number(el.value); return Number.isFinite(n)?n:NaN; }
  $("confirmUpload").onclick = async ()=>{
    $("uploadError").textContent=""; $("uploadStatus").textContent="";
    const vendor=$("upVendor").value.trim(), date=$("upDate").value, total=valNumber($("upTotal")), tax=valNumber($("upTax")), cat=$("upCategory").value, src=$("upSource").value.trim(), file=$("uploadFile").files[0];
    if(!vendor || !date || !src || !file || !Number.isFinite(total) || !Number.isFinite(tax)){ $("uploadError").textContent="Please complete all fields."; return; }
    if(total<0 || tax<0){ $("uploadError").textContent="Amounts must be zero or positive."; return; }
    if(tax>total){ $("uploadError").textContent="Tax cannot exceed Total."; return; }
    $("uploadStatus").textContent="Uploading image‚Ä¶";
    const filename=`${Date.now()}_${file.name}`;
    const { error: upErr } = await sb.storage.from("receipts-warm").upload(filename, file);
    if(upErr){ $("uploadStatus").textContent=""; $("uploadError").textContent="Upload failed: "+upErr.message; return; }
    const imageUrl=`https://advihqhjjlxumgdlbwui.supabase.co/storage/v1/object/public/receipts-warm/${filename}`;
    $("uploadStatus").textContent="Saving receipt‚Ä¶";
    const { data: orgRow } = await sb.from("orgs").select("id").limit(1).single();
    const org_id = orgRow?.id || null;
    const { data: rIns, error: rErr } = await sb.from("receipts").insert([{
      org_id, account_id:null, image_url:imageUrl, size_bytes:file.size||0,
      receipt_date:date, total:total, tax:tax, category:cat||null, vendor:vendor,
      source:src, notes:`Uploaded from transaction view for txn ${currentTxn?.id}`, entered_by:"You"
    }]).select("id").single();
    if(rErr){ $("uploadStatus").textContent=""; $("uploadError").textContent="Insert failed: "+rErr.message; return; }
    const receipt_id=rIns?.id; if(receipt_id && currentTxn?.id){
      await sb.from("matches").insert([{ org_id, transaction_id: currentTxn.id, receipt_id, matched_amount: total, confidence: 1, method:"manual", match_type:"exact" }]);
    }
    $("uploadStatus").textContent="‚úÖ Saved & linked!";
    setTimeout(async ()=>{ $("uploadBackdrop").style.display="none"; await loadTransactions(); }, 700);
  };
})();
</script>
<script src="roles.js"></script>
</body>
</html>
