<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kosmos Transactions</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js"></script>
  <style>
    :root {
      --bg: #fafafa;
      --card: #fff;
      --border: #e5e7eb;
      --muted: #6b7280;
      --ok: #0a7a33;
      --err: #b00020;
      --ink: #111;
      --btn: #111;
      --btnH: #333;
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--ink);
    }
    header {
      background: #111;
      color: #fff;
      padding: 12px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header nav a {
      color: #fff;
      text-decoration: none;
      margin: 0 12px;
      font-weight: 500;
    }
    header nav a:hover { text-decoration: underline; }
    main { padding: 24px; }
    h1 { font-size: 1.6rem; margin: 0 0 1rem; }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 24px;
    }
    .filters { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 12px; }
    button {
      padding: 0.55rem 1rem;
      border-radius: 10px;
      border: 1px solid #bbb;
      background: var(--btn);
      color: #fff;
      cursor: pointer;
    }
    button:hover { background: var(--btnH); }
    .secondary { background: #f7f7f7; color: #111; border-color: #ccc; }
    .secondary:hover { background: #eee; }
    input, select {
      padding: 0.5rem;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }
    th {
      background: #f6f7f8;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .right { text-align: right; }
    .ok { color: var(--ok); }
    .err { color: var(--err); }
    .muted { color: var(--muted); }
    @media (max-width: 700px) {
      .filters { flex-direction: column; align-items: stretch; }
    }
  </style>
</head>
<body>
  <header>
    <div><strong>Kosmos Bookkeeping</strong></div>
    <nav>
      <a href="index.html">Dashboard</a>
      <a href="transactions.html">Transactions</a>
      <a href="receipts.html">Receipts</a>
      <a href="reports.html">Reports</a>
    </nav>
  </header>

  <main>
    <h1>Transactions</h1>
    <div class="card">
      <div class="filters">
        <button class="secondary" id="btnAll">All</button>
        <button class="secondary" id="btnMatched">Matched</button>
        <button class="secondary" id="btnUnmatched">Unmatched</button>
        <label>Start <input type="date" id="startDate"></label>
        <label>End <input type="date" id="endDate"></label>
        <select id="presetRange">
          <option value="custom">Custom</option>
          <option value="week">This Week</option>
          <option value="month">This Month</option>
          <option value="year">This Year</option>
        </select>
        <button id="applyRange" class="secondary">Apply Filter</button>
        <button id="exportBtn" class="secondary">Export Accountant CSV</button>
      </div>
      <p id="status" class="muted">Loading…</p>
      <table id="txnTable">
        <thead><tr><th>Date</th><th>Description</th><th class="right">Amount</th><th>Direction</th><th>Matched</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

  <script>
    const sb = supabase.createClient(
      "https://advihqhjjlxumgdlbwui.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkdmlocWhqamx4dW1nZGxid3VpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMTg0MzIsImV4cCI6MjA3NjU5NDQzMn0.kVlaPQg2_o9DGJYv22Dgca7veok4drF6kgLPy2wPBeY"
    );
    const qs = id => document.getElementById(id);
    let currentFilter = "all";

    function getPresetRange(value){
      const now = new Date();
      let start = null, end = new Date();
      if(value==="week"){
        const day = now.getDay();
        start = new Date(now); start.setDate(now.getDate()-day);
      } else if(value==="month"){
        start = new Date(now.getFullYear(), now.getMonth(), 1);
      } else if(value==="year"){
        start = new Date(now.getFullYear(), 0, 1);
      }
      return start ? {start, end} : null;
    }

    async function loadTransactions(){
      const tbody = qs("txnTable").querySelector("tbody");
      tbody.innerHTML = "<tr><td colspan='5'>Loading…</td></tr>";
      const start = qs("startDate").value;
      const end = qs("endDate").value;
      let query = sb.from("transactions")
        .select("id, txn_date, description, amount, direction, matches(id)", {count:"exact"})
        .order("txn_date",{ascending:false});
      if(start) query = query.gte("txn_date", start);
      if(end) query = query.lte("txn_date", end);
      if(currentFilter==="matched") query = query.not("matches","is",null);
      if(currentFilter==="unmatched") query = query.is("matches",null);
      const { data, error } = await query;
      if(error){ qs("status").textContent="Error: "+error.message; qs("status").className="err"; return; }
      if(!data.length){ qs("status").textContent="No transactions found."; tbody.innerHTML=""; return; }
      const rows = data.map(r=>{
        const matched = r.matches?.length>0 ? "✅" : "—";
        return `<tr><td>${r.txn_date??""}</td><td>${r.description??""}</td><td class='right'>$${Number(r.amount||0).toFixed(2)}</td><td>${r.direction??""}</td><td>${matched}</td></tr>`;
      }).join("");
      tbody.innerHTML = rows;
      const total = data.reduce((a,r)=>a+(Number(r.amount)||0),0);
      qs("status").className="ok";
      qs("status").textContent=`${data.length} transactions • Total $${total.toFixed(2)} (${currentFilter})`;
    }

    qs("btnAll").onclick = ()=>{ currentFilter="all"; loadTransactions(); };
    qs("btnMatched").onclick = ()=>{ currentFilter="matched"; loadTransactions(); };
    qs("btnUnmatched").onclick = ()=>{ currentFilter="unmatched"; loadTransactions(); };
    qs("applyRange").onclick = loadTransactions;
    qs("presetRange").onchange = e=>{
      const preset = getPresetRange(e.target.value);
      if(preset){
        qs("startDate").value = preset.start.toISOString().slice(0,10);
        qs("endDate").value = preset.end.toISOString().slice(0,10);
      }
    };

    qs("exportBtn").onclick = async ()=>{
      qs("status").textContent="Building export…";
      const { data, error } = await sb.from("v_accountant_export_receipts").select("*");
      if(error){ qs("status").textContent="Export failed: "+error.message; qs("status").className="err"; return; }
      const header = Object.keys(data[0]||{});
      const rows = [header.join(","), ...data.map(r=>header.map(h=>r[h]).join(","))];
      const blob = new Blob([rows.join("\n")],{type:"text/csv"});
      const a=document.createElement("a");a.href=URL.createObjectURL(blob);
      a.download=`accountant_export_${new Date().toISOString().slice(0,10)}.csv`;a.click();
      qs("status").className="ok";qs("status").textContent="CSV downloaded.";
    };

    loadTransactions();
  </script>
</body>
</html>
