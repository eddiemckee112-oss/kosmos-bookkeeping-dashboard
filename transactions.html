<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Kosmos Bookkeeping ‚Äî Transactions</title>
  <link rel="stylesheet" href="style.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{padding:4px 10px;border:1px solid var(--border);border-radius:999px;background:#fff}
    .right{text-align:right}
    .muted{color:var(--muted)} .err{color:var(--err)} .ok{color:var(--ok)}
    .status-pill{font-size:.75rem;padding:4px 10px;border-radius:999px;border:1px solid var(--border);background:#fff;white-space:nowrap}
    .status-pill.ok{background:#ecfdf5;border-color:#a7f3d0}
    .status-pill.dim{opacity:.75}
    .upload-btn{font-size:.8rem;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#f9f9f9;cursor:pointer}
    .cat-select{min-width:150px}
    .save-mark{font-size:12px;margin-left:6px;opacity:0;transition:opacity .2s}
    .save-mark.show{opacity:1}
    .link{color:#2563eb;text-decoration:none}
    .linkmode{background:#ede9fe;border:1px solid #c4b5fd;padding:8px 12px;border-radius:10px;margin-bottom:10px}
  </style>
</head>
<body>
<header>
  <h1>Kosmos Bookkeeping</h1>
  <nav>
    <a href="index.html">Dashboard</a>
    <a href="receipts.html">Receipts</a>
    <a class="active" href="transactions.html">Transactions</a>
    <a href="reports.html">Reports</a>
  </nav>
</header>

<main class="container">
  <h2>üí≥ Transactions</h2>
  <div id="linkBanner" class="linkmode" style="display:none">
    üîó Linking mode active ‚Äî click ‚ÄúLink to this‚Äù on a transaction to attach the selected receipt.
    <button id="cancelLink" class="ghost" style="margin-left:10px">Cancel</button>
  </div>

  <div class="card">
    <div class="toolbar">
      <input id="quickSearch" placeholder="Search description/category/source‚Ä¶" style="flex:1;min-width:220px"/>
      <button id="applyBtn">Apply</button>
      <button id="exportBtn" class="ghost">‚¨áÔ∏è Export CSV</button>
    </div>
  </div>

  <div class="card">
    <table id="txTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Description</th>
          <th class="right">Amount</th>
          <th>Category</th>
          <th>Source</th>
          <th>Status</th>
          <th>Receipt</th>
        </tr>
      </thead>
      <tbody id="txBody"></tbody>
    </table>
    <div class="muted" id="rowsCount" style="margin-top:8px">Rows: 0</div>
  </div>
</main>

<script>
const sb = supabase.createClient(
  "https://advihqhjjlxumgdlbwui.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkdmlocWhqamx4dW1nZGxid3VpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMTg0MzIsImV4cCI6MjA3NjU5NDQzMn0.kVlaPQg2_o9DGJYv22Dgca7veok4drF6kgLPy2wPBeY"
);
const $ = id => document.getElementById(id);
const money = n => (Number(n)||0).toLocaleString(undefined,{style:"currency",currency:"CAD"});
const esc = s => String(s??"").replace(/[&<>]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m]));

const CATEGORIES = [
  "Uncategorized","Income","Bank Fees","Fuel","Utilities","Phone/Internet","Insurance",
  "Professional Fees","Software","Subscriptions","Repairs & Maintenance","Office",
  "Meals & Entertainment","Travel","Lodging","Building Maintenance","Building Miscellaneous",
  "Restaurant (Food & Supplies)","Taxes","Other"
];
const SOURCES = ["CIBC Bank Account","Rogers MasterCard","PC MasterCard","Cash"];

let linkReceipt = null;

function getQueryParam(name){
  return new URLSearchParams(location.search).get(name);
}

async function loadTransactions(){
  const { data: txns, error } = await sb.from("transactions")
    .select("id, txn_date, description, amount, category, source_account_name")
    .order("txn_date",{ascending:false});
  if(error){ $("txBody").innerHTML=`<tr><td colspan="7">${error.message}</td></tr>`; return; }

  // load matches
  const { data: mx } = await sb.from("matches").select("transaction_id, receipt_id");
  const matchMap = new Map(); (mx||[]).forEach(m=>matchMap.set(m.transaction_id,m.receipt_id));

  let filtered = txns;
  const q = $("quickSearch").value.trim().toLowerCase();
  if(q) filtered = filtered.filter(t =>
    (t.description||"").toLowerCase().includes(q) ||
    (t.category||"").toLowerCase().includes(q) ||
    (t.source_account_name||"").toLowerCase().includes(q)
  );

  $("txBody").innerHTML = filtered.map(t=>{
    const matched = matchMap.has(t.id);
    const status = matched ? `<span class="status-pill ok">Matched</span>` : `<span class="status-pill dim">Unmatched</span>`;
    const receiptHtml = matched
      ? `<a class="link" href="receipts.html#${matchMap.get(t.id)}">View</a>`
      : (linkReceipt ? `<button class="upload-btn" data-act="link" data-id="${t.id}">Link to this</button>` : "");
    return `<tr>
      <td>${esc(t.txn_date||"")}</td>
      <td>${esc(t.description||"")}</td>
      <td class="right">${money(t.amount)}</td>
      <td>${esc(t.category||"Uncategorized")}</td>
      <td>${esc(t.source_account_name||"")}</td>
      <td>${status}</td>
      <td>${receiptHtml}</td>
    </tr>`;
  }).join("");
  $("rowsCount").textContent=`Rows: ${filtered.length}`;

  // linking click
  document.querySelectorAll("[data-act='link']").forEach(btn=>{
    btn.onclick = ()=>linkToTransaction(btn.dataset.id);
  });
}

async function linkToTransaction(txnId){
  if(!linkReceipt) return alert("No receipt selected.");
  const { data: rec } = await sb.from("receipts").select("id,total,receipt_date").eq("id",linkReceipt).single();
  const { data: txn } = await sb.from("transactions").select("id,amount,txn_date").eq("id",txnId).single();
  if(!rec || !txn) return alert("Invalid data.");

  const amtMatch = Math.abs(rec.total - txn.amount) < 0.01;
  const dateDiff = Math.abs(new Date(rec.receipt_date) - new Date(txn.txn_date)) / (1000*60*60*24);
  if(!amtMatch && dateDiff>5){
    if(!confirm("Amounts or dates differ more than 5 days. Link anyway?")) return;
  }

  const { error } = await sb.from("matches").insert([{
    org_id:null, transaction_id:txnId, receipt_id:linkReceipt,
    matched_amount:rec.total, confidence:amtMatch?1:0.8, method:"manual", match_type:"manual-link"
  }]);
  if(error) return alert(error.message);
  alert("‚úÖ Linked!");
  sessionStorage.removeItem("linkReceipt");
  location.href="receipts.html";
}

$("applyBtn").onclick=loadTransactions;
$("quickSearch").oninput=()=>{clearTimeout(window.__s);window.__s=setTimeout(loadTransactions,200);};
$("cancelLink").onclick=()=>{sessionStorage.removeItem("linkReceipt");location.href="transactions.html";};

// init
linkReceipt = getQueryParam("linkReceipt") || sessionStorage.getItem("linkReceipt");
if(linkReceipt){
  $("linkBanner").style.display="block";
  sessionStorage.setItem("linkReceipt",linkReceipt);
}
loadTransactions();

// export csv
$("exportBtn").onclick = async ()=>{
  const { data, error } = await sb.from("transactions")
    .select("txn_date,description,amount,category,source_account_name")
    .order("txn_date",{ascending:false});
  if(error){ alert(error.message); return; }
  const rows=[["Date","Description","Amount","Category","Source"],
    ...data.map(r=>[r.txn_date||"",r.description||"",r.amount,r.category||"",r.source_account_name||""])];
  const csv=rows.map(r=>r.map(c=>`"${String(c??"").replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="transactions_export.csv"; a.click();
  URL.revokeObjectURL(a.href);
};
</script>
</body>
</html>
