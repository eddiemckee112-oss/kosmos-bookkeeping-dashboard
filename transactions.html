<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Kosmos Bookkeeping ‚Äî Transactions</title>
  <link rel="stylesheet" href="style.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{padding:4px 10px;border:1px solid var(--border);border-radius:999px;background:#fff}
    .right{text-align:right}
    .muted{color:var(--muted)} .err{color:var(--err)} .ok{color:var(--ok)}
    .status-pill{font-size:.75rem;padding:4px 10px;border-radius:999px;border:1px solid var(--border);background:#fff;white-space:nowrap}
    .status-pill.ok{background:#ecfdf5;border-color:#a7f3d0}
    .status-pill.dim{opacity:.75}
    .upload-btn{font-size:.8rem;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#f9f9f9;cursor:pointer}
    .cat-select{min-width:160px}
    .save-mark{font-size:12px;margin-left:6px;opacity:0;transition:opacity .2s}
    .save-mark.show{opacity:1}
    .link{color:#2563eb;text-decoration:none}
    .btn{padding:6px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer}
    .btn.ghost{background:#f9f9f9}
    .btn.small{padding:4px 8px;font-size:.85rem}

    .banner{display:none;align-items:center;gap:10px;border:1px dashed var(--border);border-radius:12px;background:#fff;padding:8px 10px}
    .banner b{font-weight:600}
    .hint{font-size:.85rem;color:var(--muted)}

    /* Simple modal for choosing an existing receipt */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.18);display:none;align-items:flex-start;justify-content:center;padding:40px 12px;z-index:50}
    .modal{background:#fff;width:min(1100px,100%);max-height:85vh;overflow:auto;border:1px solid var(--border);border-radius:16px;padding:16px}
    .field{display:flex;flex-direction:column;gap:6px}
    .grid-2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .row{display:flex;gap:10px;align-items:center}
    .list{border:1px solid var(--border);border-radius:10px;overflow:hidden}
    .list table{width:100%;border-collapse:collapse}
    .list th,.list td{padding:8px 10px;border-bottom:1px solid #eee}
    .list tr:last-child td{border-bottom:none}
  </style>
</head>
<body>
<header>
  <h1>Kosmos Bookkeeping</h1>
  <nav>
    <a href="index.html">Dashboard</a>
    <a href="receipts.html">Receipts</a>
    <a class="active" href="transactions.html">Transactions</a>
    <a href="reports.html">Reports</a>
  </nav>
</header>

<main class="container">
  <h2>üí≥ Transactions</h2>
  <p class="muted">Filter, import, categorize, attach receipts, and link existing receipts.</p>

  <!-- Linking banner (only filters when a real receipt is selected) -->
  <div id="linkBanner" class="banner" style="margin-bottom:10px">
    <span>üîó <b>Linking receipt</b></span>
    <button id="chooseReceiptBtn" class="btn small">Choose receipt‚Ä¶</button>
    <span class="hint">Tip: rows with same amount & ¬±5 days show a ‚ÄúLink to this‚Äù button.</span>
    <span class="spacer" style="flex:1 1 auto"></span>
    <button id="clearLinkBtn" class="btn small">Clear</button>
  </div>

  <!-- Filters -->
  <div class="card" style="margin-bottom:14px;">
    <div class="toolbar">
      <label>Date Range:</label>
      <input id="fromDate" type="date"/><span>‚Äì</span><input id="toDate" type="date"/>
      <select id="typeFilter" title="Filter">
        <option value="all">All</option>
        <option value="debit">Debits only</option>
        <option value="credit">Credits only</option>
        <option value="uncategorized">Uncategorized</option>
        <option value="no_source">No Source</option>
        <option value="matched">Matched only</option>
        <option value="unmatched">Unmatched only</option>
      </select>
      <button id="applyBtn" class="btn small">Apply</button>
      <input id="quickSearch" placeholder="Search description/category/source‚Ä¶" style="flex:1;min-width:220px"/>
      <button id="exportBtn" class="btn ghost small">‚¨áÔ∏è Export CSV</button>
      <button id="importBtn" class="btn ghost small">üì• Import CSV</button>
    </div>
    <div class="row" style="gap:10px;margin-top:10px;">
      <span class="pill">Matched: <b id="chipMatched">‚Äî</b></span>
      <span class="pill">Unmatched: <b id="chipUnmatched">‚Äî</b></span>
      <span class="pill">Uncategorized: <b id="chipUncat">‚Äî</b></span>
      <span class="pill">No Source: <b id="chipNoSource">‚Äî</b></span>
      <span class="pill">Duplicates: <b id="chipDupes">‚Äî</b></span>
    </div>
  </div>

  <!-- Totals -->
  <div class="card" style="margin-bottom:14px;">
    <div>Total Transactions: <b id="totalRows">‚Äî</b></div>
    <div>Debits: <b id="totalDebits">$0.00</b></div>
    <div>Credits: <b id="totalCredits">$0.00</b></div>
    <div>Net: <b id="totalNet">$0.00</b></div>
    <small class="muted">Numbers reflect the current filter.</small>
    <div id="pageError" class="err small" style="margin-top:6px"></div>
  </div>

  <!-- Table -->
  <div class="card">
    <table id="txTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Description</th>
          <th class="right">Amount</th>
          <th>Type</th>
          <th>Category</th>
          <th>Source</th>
          <th>Status</th>
          <th>Receipt</th>
        </tr>
      </thead>
      <tbody id="txBody"></tbody>
    </table>
    <div class="muted" id="rowsCount" style="margin-top:8px">Rows: 0</div>
  </div>
</main>

<!-- Modal: choose existing receipt to link -->
<div id="pickBackdrop" class="modal-backdrop">
  <div class="modal">
    <h3>Choose a Receipt to Link</h3>
    <p class="muted" id="pickHelp">Showing 30 most recent receipts (unmatched first). Select one to enter ‚Äúlinking mode.‚Äù</p>
    <div id="pickList" class="list" style="margin-top:8px">
      <table>
        <thead><tr><th>Date</th><th>Vendor</th><th class="right">Total</th><th>Status</th><th>Action</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:12px">
      <button id="closePick" class="btn ghost">Close</button>
    </div>
  </div>
</div>

<!-- Import Modal -->
<div id="impBackdrop" class="modal-backdrop">
  <div class="modal">
    <h3>Import Transactions (CSV)</h3>
    <p class="note muted small">Mapping is <b>A=Date</b>, <b>B=Description</b>, <b>C=Debit</b>, <b>D=Credit</b>.</p>
    <div class="card" style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
      <input id="csvFile" type="file" accept=".csv,text/csv"/>
      <button id="closeImport" class="btn ghost">Close</button>
    </div>
    <div class="row" style="gap:10px;align-items:center;margin-top:10px">
      <label for="fileSourceSelect"><b>Source for this file:</b></label>
      <select id="fileSourceSelect"></select>
      <input id="fileSourceCustom" class="hidden" placeholder="Type custom source‚Ä¶"/>
    </div>
    <p id="impStatus" class="muted small" style="margin-top:10px;">Select a CSV to begin.</p>
    <div class="pill small" id="countPill" style="display:inline-block;margin-top:6px;">Parsed ‚Äî ¬∑ Valid ‚Äî ¬∑ Skipped ‚Äî ¬∑ Debits ‚Äî ¬∑ Credits ‚Äî</div>
    <div id="impPreview" class="card" style="margin-top:12px;display:none;">
      <h4 style="margin:0 0 8px 0">Preview (first 20 rows)</h4>
      <table style="width:100%;border-collapse:collapse;">
        <thead><tr><th>Date</th><th>Description</th><th class="right">Amount</th><th>Direction</th><th>Source</th></tr></thead>
        <tbody id="prevBody"><tr><td colspan="5" class="muted">No rows yet</td></tr></tbody>
      </table>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:12px">
      <button id="importGo" class="btn">Import</button>
    </div>
  </div>
</div>

<script>
(function(){
  // --- Supabase client ---
  const sb = supabase.createClient(
    "https://advihqhjjlxumgdlbwui.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkdmlocWhqamx4dW1nZGxid3VpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMTg0MzIsImV4cCI6MjA3NjU5NDQzMn0.kVlaPQg2_o9DGJYv22Dgca7veok4drF6kgLPy2wPBeY"
  );

  // --- helpers ---
  const $ = id => document.getElementById(id);
  const money = n => (n==null?0:n).toLocaleString(undefined,{style:"currency",currency:"CAD"});
  const esc = s => String(s??"").replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]));

  // Fixed sources & curated categories (locked list)
  const FIXED_SOURCES = ["CIBC Bank Account","PC MasterCard","Rogers MasterCard","Cash"];
  const CATEGORIES = [
    "Uncategorized",
    "Income","Sales","Refunds",
    "Food & Beverage","Restaurant Supplies","Cleaning Supplies",
    "Building Maintenance","Tools & Equipment","General Supplies",
    "Software","Subscriptions",
    "Travel","Lodging",
    "Fuel","Utilities","Phone/Internet","Office","Professional Fees","Bank Fees","Taxes","Insurance","Repairs",
    "Other"
  ];

  // state
  let CATEGORY_OPTIONS = CATEGORIES.slice(); // already curated
  let rows = [];
  let matchMap = new Map(); // txn_id -> {receipt_id, confidence}
  let linkReceipt = null;   // {id, date, total}

  // ---------- Linking banner ----------
  async function readLinkContextFromURL(){
    const params = new URLSearchParams(location.search);
    const id = params.get("linkReceipt") || sessionStorage.getItem("linkReceipt") || null;
    if(!id){ linkReceipt = null; return; }
    // Try to load the receipt; if not found, treat as no-link
    const { data: r } = await sb.from("receipts").select("id, receipt_date, total, vendor").eq("id", id).single();
    if(r && Number.isFinite(+r.total) && r.receipt_date){
      linkReceipt = { id: r.id, date: String(r.receipt_date).slice(0,10), total: Math.abs(+r.total), vendor: r.vendor||"" };
      $("linkBanner").style.display = "flex";
    }else{
      linkReceipt = null;
      $("linkBanner").style.display = "none";
      sessionStorage.removeItem("linkReceipt");
    }
  }

  function setLinkContext(id){
    if(id){
      const u = new URL(location.href);
      u.searchParams.set("linkReceipt", id);
      history.replaceState(null, "", u.toString());
      sessionStorage.setItem("linkReceipt", id);
    }else{
      const u = new URL(location.href);
      u.searchParams.delete("linkReceipt");
      history.replaceState(null, "", u.toString());
      sessionStorage.removeItem("linkReceipt");
    }
  }

  $("clearLinkBtn").onclick = async ()=>{
    setLinkContext(null);
    $("linkBanner").style.display = "none";
    linkReceipt = null;
    await loadTransactions(); // repaint without narrowing
  };

  $("chooseReceiptBtn").onclick = async ()=>{
    await openPickModal();
  };

  // ---------- Category select ----------
  function renderCategorySelect(value, id){
    const opts = CATEGORY_OPTIONS.map(c=>`<option value="${esc(c)}"${c===value?' selected':''}>${esc(c)}</option>`).join("");
    return `<select class="cat-select" data-txn="${id}" onchange="updateCategory(this)">${opts}</select><span class="save-mark" id="sv_${id}">‚úì saved</span>`;
  }
  window.updateCategory = async (sel)=>{
    const id = sel.getAttribute("data-txn");
    const { error } = await sb.from("transactions").update({ category: sel.value||null }).eq("id", id);
    const mark = $("sv_"+id);
    if(error){ sel.classList.add("err"); if(mark){ mark.textContent="‚úó error"; mark.classList.add("show"); } return; }
    sel.classList.remove("err"); if(mark){ mark.textContent="‚úì saved"; mark.classList.add("show"); setTimeout(()=>mark.classList.remove("show"),1200); }
  };

  // ---------- Main load ----------
  function showError(msg){ $("pageError").textContent = msg||""; }

  async function loadTransactions(){
    showError("");
    // Base query
    const from = $("fromDate").value || null;
    const to   = $("toDate").value || null;
    const type = $("typeFilter").value;
    const q    = $("quickSearch").value.trim().toLowerCase();

    let q1 = sb.from("transactions").select("id, txn_date, description, amount, direction, category, source_account_name");
    if(from) q1 = q1.gte("txn_date", from);
    if(to)   q1 = q1.lte("txn_date", to);
    if(type==="debit")  q1 = q1.eq("direction","debit");
    if(type==="credit") q1 = q1.eq("direction","credit");
    const { data, error } = await q1.order("txn_date",{ascending:false});
    if(error){ showError(error.message); $("txBody").innerHTML=""; $("rowsCount").textContent="Rows: 0"; return; }
    rows = data || [];

    // Load matches for visible txns
    matchMap = new Map();
    const ids = rows.map(r=>r.id);
    if(ids.length){
      const { data: mm } = await sb.from("matches")
        .select("transaction_id, receipt_id, confidence")
        .in("transaction_id", ids);
      (mm||[]).forEach(m=>{
        if(!matchMap.has(m.transaction_id)) matchMap.set(m.transaction_id, m);
      });
    }

    // Filter type variants
    if(type==="uncategorized") rows = rows.filter(r => !r.category || r.category==="Uncategorized");
    if(type==="no_source")     rows = rows.filter(r => !r.source_account_name);
    if(type==="matched")       rows = rows.filter(r => matchMap.has(r.id));
    if(type==="unmatched")     rows = rows.filter(r => !matchMap.has(r.id));

    // QUICK SEARCH
    if(q){
      rows = rows.filter(r =>
        (r.description||"").toLowerCase().includes(q) ||
        (r.category||"").toLowerCase().includes(q) ||
        (r.source_account_name||"").toLowerCase().includes(q)
      );
    }

    // Linking MODE: only narrow if we *truly* have a receipt context
    if(linkReceipt){
      $("linkBanner").style.display = "flex";
      // show vendor/total hint in banner text
      $("pickHelp").textContent = "Showing 30 most recent receipts (unmatched first). Select one to enter ‚Äúlinking mode.‚Äù";
      rows = rows.filter(r=>{
        const amtOk = Math.abs(Math.abs(+r.amount) - linkReceipt.total) < 0.005;
        const d = (r.txn_date||"").slice(0,10);
        const days = Math.abs((new Date(d) - new Date(linkReceipt.date)) / 86400000);
        return amtOk && days <= 5;
      });
    } else {
      $("linkBanner").style.display = "none";
    }

    // Totals & chips
    const deb = rows.filter(r=>r.direction==='debit').reduce((s,r)=>s+(+r.amount||0),0);
    const cre = rows.filter(r=>r.direction==='credit').reduce((s,r)=>s+(+r.amount||0),0);
    $("totalRows").textContent   = rows.length;
    $("totalDebits").textContent = money(deb);
    $("totalCredits").textContent= money(cre);
    $("totalNet").textContent    = money(cre-deb);

    const uncat = rows.filter(r => !r.category || r.category==="Uncategorized").length;
    const noSrc = rows.filter(r => !r.source_account_name).length;
    const mat   = rows.filter(r => matchMap.has(r.id)).length;
    const unmat = rows.length - mat;
    $("chipUncat").textContent     = uncat;
    $("chipNoSource").textContent  = noSrc;
    $("chipMatched").textContent   = mat;
    $("chipUnmatched").textContent = unmat;

    // Duplicate signal
    const norm = s => (s||"").toLowerCase().replace(/\s+/g," ").trim().slice(0,80);
    const keyOf = r => `${r.txn_date}|${(+r.amount||0).toFixed(2)}|${norm(r.description)}`;
    const freq = new Map();
    rows.forEach(r=>{ const k=keyOf(r); freq.set(k,(freq.get(k)||0)+1); });
    const dupes = rows.filter(r=> (freq.get(keyOf(r))||0)>1).length;
    $("chipDupes").textContent = dupes;

    // Render
    $("txBody").innerHTML = rows.map(r=>{
      const m = matchMap.get(r.id);
      const matched = !!m;
      const statusHtml = matched
        ? `<span class="status-pill ok" title="Confidence ${m.confidence ?? 1}">Matched</span>`
        : `<span class="status-pill dim">Unmatched</span>`;

      // If in linking mode & this row is a candidate, show ‚ÄúLink to this‚Äù
      let receiptCell = "";
      if(matched){
        receiptCell = `<a class="link" href="receipts.html#${esc(m.receipt_id||'')}" title="Open receipt">View</a>`;
      }else if(linkReceipt){
        receiptCell = `<button class="btn small" onclick="linkToThis('${r.id}')">Link to this</button>`;
      }else{
        receiptCell = `<button class="upload-btn" onclick="openUpload('${r.id}')">üì∑ Upload</button>`;
      }

      return `
        <tr>
          <td>${esc(r.txn_date||"")}</td>
          <td>${esc(r.description||"")}</td>
          <td class="right">${money(r.amount)}</td>
          <td>${esc(r.direction||"")}</td>
          <td>${renderCategorySelect(r.category||"Uncategorized", r.id)}</td>
          <td>${esc(r.source_account_name||"")}</td>
          <td>${statusHtml}</td>
          <td>${receiptCell}</td>
        </tr>
      `;
    }).join("");
    $("rowsCount").textContent = `Rows: ${rows.length}`;
  }

  // ---------- Link current linking-receipt to a transaction ----------
  window.linkToThis = async function(transaction_id){
    if(!linkReceipt) return alert("No receipt selected for linking.");
    const { data: orgRow } = await sb.from("orgs").select("id").limit(1).single();
    const org_id = orgRow?.id || null;
    const { error } = await sb.from("matches").insert([{
      org_id,
      transaction_id,
      receipt_id: linkReceipt.id,
      matched_amount: linkReceipt.total,
      confidence: 0.98,
      method: "manual",
      match_type: "exact"
    }]);
    if(error){ alert(error.message); return; }
    // Exit linking mode and refresh
    setLinkContext(null);
    linkReceipt = null;
    await loadTransactions();
  };

  // ---------- Upload modal (quick attach new receipt) ----------
  async function openUpload(id){
    // You already have a working upload modal in earlier version.
    // Simple redirect to receipts page in ‚Äúadd from transaction‚Äù flow:
    location.href = "receipts.html#upload-for=" + encodeURIComponent(id);
  }
  window.openUpload = openUpload;

  // ---------- ‚ÄúPick receipt‚Äù modal ----------
  async function openPickModal(){
    // load recent receipts (unmatched first)
    const { data: mx } = await sb.from("matches").select("receipt_id");
    const matched = new Set((mx||[]).map(m=>m.receipt_id));
    const { data: recs } = await sb.from("receipts")
      .select("id, receipt_date, total, vendor")
      .order("receipt_date",{ascending:false})
      .limit(30);

    const tb = $("#pickList tbody");
    tb.innerHTML = (recs||[]).map(r=>{
      const isMatched = matched.has(r.id);
      return `<tr>
        <td>${esc((r.receipt_date||"").slice(0,10))}</td>
        <td>${esc(r.vendor||"")}</td>
        <td class="right">${money(r.total||0)}</td>
        <td>${isMatched?'<span class="status-pill ok">Matched</span>':'<span class="status-pill dim">Unmatched</span>'}</td>
        <td><button class="btn small" onclick="pickThis('${r.id}')">Use</button></td>
      </tr>`;
    }).join("");

    $("pickBackdrop").style.display = "flex";
  }
  $("closePick").onclick = ()=>{ $("pickBackdrop").style.display="none"; };

  window.pickThis = async function(id){
    $("pickBackdrop").style.display = "none";
    setLinkContext(id);
    await readLinkContextFromURL();
    await loadTransactions();
  };

  // ---------- CSV Import / Export ----------
  async function populateSourceOptions(){
    const sel=$("fileSourceSelect"), custom=$("fileSourceCustom"); sel.innerHTML="";
    const fixed=FIXED_SOURCES.slice();
    fixed.forEach(name=> sel.insertAdjacentHTML("beforeend", `<option value="${esc(name)}">${esc(name)}</option>`));
    const { data: accs } = await sb.from("accounts").select("name").order("name");
    const have=new Set(fixed);
    (accs||[]).forEach(a=>{ if(a?.name && !have.has(a.name)){ sel.insertAdjacentHTML("beforeend", `<option value="${esc(a.name)}">${esc(a.name)} (seen)</option>`); have.add(a.name);} });
    sel.insertAdjacentHTML("beforeend", `<option value="__custom__">Custom‚Ä¶</option>`);
    custom.classList.add("hidden");
    sel.onchange = ()=>{ if(sel.value==="__custom__") custom.classList.remove("hidden"); else custom.classList.add("hidden"); };
    sel.value="CIBC Bank Account";
  }

  $("importBtn").onclick = async ()=>{ $("impBackdrop").style.display="flex"; $("impStatus").textContent="Select a CSV to begin."; $("impPreview").style.display="none"; $("csvFile").value=""; $("countPill").textContent="Parsed ‚Äî ¬∑ Valid ‚Äî ¬∑ Skipped ‚Äî ¬∑ Debits ‚Äî ¬∑ Credits ‚Äî"; await populateSourceOptions(); };
  $("closeImport").onclick = ()=>{ $("impBackdrop").style.display="none"; };

  let __valid=[]; let __skipped=[];
  function detectDelimiter(sample){ const c=(sample.match(/,/g)||[]).length, s=(sample.match(/;/g)||[]).length, t=(sample.match(/\t/g)||[]).length; if(Math.max(c,s,t)===s) return ";"; if(Math.max(c,s,t)===t) return "\t"; return ","; }
  function parseLine(line, delim){ const out=[]; let cur='',q=false; for(let i=0;i<line.length;i++){ const ch=line[i]; if(ch==='"'){ if(q&&line[i+1]==='"'){cur+='"';i++;} else q=!q; } else if(ch===delim && !q){ out.push(cur); cur=''; } else cur+=ch; } out.push(cur); return out.map(x=>x.trim()); }
  function parseCSV(text){ const sample=text.split(/\r?\n/).slice(0,8).join("\n"); const delim=detectDelimiter(sample); const lines=text.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n"); const rows=lines.map(l=> l.trim()==="" ? null : parseLine(l,delim)); return { rows, delim }; }
  function isDateLike(s){ if(!s) return false; const t=String(s).trim(); if(/^\d{4}[-/]\d{2}[-/]\d{2}$/.test(t)) return true; const d=new Date(t); return !isNaN(d.valueOf()); }
  function toISO(s){ if(!s) return null; const t=String(s).trim(); if(/^\d{4}[-/]\d{2}[-/]\d{2}$/.test(t)) return t.replace(/\//g,"-"); const d=new Date(t); if(isNaN(d.valueOf())) return null; return d.toISOString().slice(0,10); }
  function parseNum(s){ if(s==null) return null; let v=String(s).trim(); if(!v) return null; const paren=/^\(.*\)$/.test(v); if(paren) v=v.replace(/[()]/g,""); v=v.replace(/\$/g,"").replace(/,/g,""); const n=Number(v); if(Number.isNaN(n)) return null; return paren?-Math.abs(n):n; }

  $("csvFile").addEventListener("change", async (e)=>{
    __valid=[]; __skipped=[];
    const f=e.target.files?.[0]; if(!f) return;
    $("impStatus").textContent="Reading file‚Ä¶";
    const text=await f.text(); const { rows }=parseCSV(text);
    const parsed=rows.filter(r=>r!==undefined).length;
    const nonBlank=rows.filter(r=> r && r.some(x=>String(x).trim().length));
    if(nonBlank.length===0){ $("impStatus").className="err small"; $("impStatus").textContent="No rows detected."; $("impPreview").style.display="none"; $("countPill").textContent=`Parsed ${parsed} ¬∑ Valid 0 ¬∑ Skipped ${parsed} ¬∑ Debits 0 ¬∑ Credits 0`; return; }

    let start=0; if(nonBlank[0] && !isDateLike(nonBlank[0][0])) start=1;
    const DATE_COL=0,DESC_COL=1,DEBIT_COL=2,CREDIT_COL=3;
    let debSum=0, credSum=0, valid=0;

    const srcSel=$("fileSourceSelect"), srcCustom=$("fileSourceCustom");
    const previewSource = srcSel.value==="__custom__" ? srcCustom.value.trim() : srcSel.value;

    for(let i=start;i<nonBlank.length;i++){
      const r=nonBlank[i];
      const date=toISO(r[DATE_COL]); const desc=String(r[DESC_COL]||"").trim();
      if(!date || !desc){ __skipped.push({line:i+1,reason:'bad date/desc'}); continue; }
      const dVal=parseNum(r[DEBIT_COL]), cVal=parseNum(r[CREDIT_COL]);
      let amount=null, direction=null;
      if(cVal!=null && cVal>0){ amount=Math.abs(cVal); direction='credit'; credSum+=amount; }
      else if(dVal!=null && dVal!==0){ amount=Math.abs(dVal); direction='debit'; debSum+=amount; }
      else { __skipped.push({line:i+1,reason:'no debit/credit'}); continue; }
      __valid.push({date, desc, amount, direction, source: previewSource||null}); valid++;
    }
    const skippedCount=Math.max(parsed - (start>0?1:0) - valid, 0);
    $("countPill").textContent=`Parsed ${parsed} ¬∑ Valid ${valid} ¬∑ Skipped ${skippedCount} ¬∑ Debits ${debSum.toFixed(2)} ¬∑ Credits ${credSum.toFixed(2)}`;

    if(valid===0){ $("impStatus").className="err small"; $("impStatus").textContent="No valid rows after parsing."; $("impPreview").style.display="none"; return; }

    const first20=__valid.slice(0,20);
    $("prevBody").innerHTML=first20.map(v=>`
      <tr><td>${esc(v.date)}</td><td>${esc(v.desc)}</td><td class="right">${money(v.amount)}</td><td>${v.direction}</td><td>${esc(v.source||"")}</td></tr>
    `).join("");
    $("impPreview").style.display="block"; $("impStatus").className="muted small"; $("impStatus").textContent=`Ready to import ${valid} transactions.`;
  });

  $("importGo").onclick = async ()=>{
    if(!__valid.length){ alert("No valid rows."); return; }
    const sel=$("fileSourceSelect"), custom=$("fileSourceCustom");
    let chosen = sel.value==="__custom__" ? custom.value.trim() : sel.value;
    if(!chosen){ alert("Choose a Source for this file."); sel.focus(); return; }
    __valid = __valid.map(v=>({...v, source: chosen}));
    $("impStatus").className="muted small"; $("impStatus").textContent=`Importing ${__valid.length} transactions‚Ä¶`;

    const rowsToInsert = __valid.map(v=>({
      txn_date: v.date, post_date: v.date, description: v.desc,
      amount: v.amount, direction: v.direction, category: "Uncategorized",
      source_account_name: v.source, currency:"CAD", imported_via:"csv"
    }));
    try{
      for(let i=0;i<rowsToInsert.length;i+=300){
        const chunk=rowsToInsert.slice(i,i+300);
        const { error } = await sb.from("transactions").insert(chunk);
        if(error) throw error;
        $("impStatus").textContent=`Importing ${rowsToInsert.length}‚Ä¶ ${Math.min(i+300,rowsToInsert.length)}/${rowsToInsert.length}`;
      }
      $("impStatus").className="ok small"; $("impStatus").textContent=`‚úÖ Imported ${rowsToInsert.length}.`;
      $("impBackdrop").style.display="none"; await loadTransactions();
    }catch(err){ $("impStatus").className="err small"; $("impStatus").textContent=String(err.message||err); }
  };

  // Export
  $("exportBtn").onclick = async ()=>{
    const { data, error } = await sb.from("transactions")
      .select("txn_date,description,amount,direction,category,source_account_name")
      .order("txn_date",{ascending:false});
    if(error){ alert(error.message); return; }
    const rows=[["Date","Description","Amount","Type","Category","Source"], ...data.map(r=>[
      r.txn_date||"", (r.description||"").replace(/[\r\n]+/g," "), r.amount, r.direction, r.category||"", r.source_account_name||""
    ])];
    const csv=rows.map(r=>r.map(cell=>{ const s=String(cell??""); return /[",\n;]/.test(s)?`"${s.replace(/"/g,'""')}"`:s; }).join(",")).join("\n");
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
    const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="transactions_export.csv"; a.click(); URL.revokeObjectURL(a.href);
  };

  // Filters
  $("applyBtn").onclick = loadTransactions;
  $("quickSearch").addEventListener("input", ()=>{ clearTimeout(window.__qsT); window.__qsT=setTimeout(loadTransactions,150); });

  // Init
  async function init(){
    await readLinkContextFromURL(); // sets linkReceipt if present & valid
    await loadTransactions();
  }
  init();
})();
</script>
<script src="roles.js"></script>
</body>
</html>
