<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kosmos Transactions</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:24px;background:#fafafa;color:#111;}
    h1{font-size:1.6rem;margin:0 0 .75rem;}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:16px;margin-bottom:24px;}
    button{padding:.55rem 1rem;border-radius:10px;border:1px solid #bbb;background:#111;color:#fff;cursor:pointer;}
    button:hover{background:#333;}
    .secondary{background:#f7f7f7;color:#111;border-color:#ccc;}
    .secondary:hover{background:#eee;}
    .filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;}
    table{width:100%;border-collapse:collapse;font-size:14px;}
    th,td{padding:8px 10px;border-bottom:1px solid #e5e7eb;text-align:left;}
    th{background:#f6f7f8;position:sticky;top:0;}
    .right{text-align:right;}
    .ok{color:#0a7a33;}
    .err{color:#b00020;}
    .muted{color:#6b7280;}
  </style>
</head>
<body>
  <h1>Transactions</h1>
  <div class="card">
    <div class="filters">
      <button class="secondary" id="btnAll">All</button>
      <button class="secondary" id="btnMatched">Matched</button>
      <button class="secondary" id="btnUnmatched">Unmatched</button>
      <select id="dateRange">
        <option value="all">All time</option>
        <option value="7">Last 7 days</option>
        <option value="30">Last 30 days</option>
        <option value="365">Last year</option>
      </select>
      <button id="exportBtn" class="secondary">Export Accountant CSV</button>
    </div>
    <p id="status" class="muted">Loading…</p>
    <table id="txnTable">
      <thead><tr><th>Date</th><th>Description</th><th class="right">Amount</th><th>Direction</th><th>Matched</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
  <script>
    const sb = supabase.createClient(
      "https://advihqhjjlxumgdlbwui.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkdmlocWhqamx4dW1nZGxid3VpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMTg0MzIsImV4cCI6MjA3NjU5NDQzMn0.kVlaPQg2_o9DGJYv22Dgca7veok4drF6kgLPy2wPBeY"
    );
    const qs = id => document.getElementById(id);
    let currentFilter = "all";

    async function loadTransactions(){
      const tbody = qs("txnTable").querySelector("tbody");
      tbody.innerHTML = "<tr><td colspan='5'>Loading…</td></tr>";
      let fromDate = null;
      const range = qs("dateRange").value;
      if(range!=="all"){
        const d = new Date(); d.setDate(d.getDate()-Number(range));
        fromDate = d.toISOString().slice(0,10);
      }

      let query = sb.from("transactions")
        .select("id, txn_date, description, amount, direction, matches(id)", {count:"exact"})
        .order("txn_date",{ascending:false});

      if(fromDate) query = query.gte("txn_date", fromDate);
      if(currentFilter==="matched") query = query.not("matches","is",null);
      if(currentFilter==="unmatched") query = query.is("matches",null);

      const { data, error } = await query;
      if(error){ qs("status").textContent = "Error: "+error.message; qs("status").className="err"; return; }
      if(!data.length){ qs("status").textContent="No transactions found."; tbody.innerHTML=""; return; }

      const rows = data.map(r=>{
        const matched = r.matches?.length>0 ? "✅" : "—";
        return `<tr><td>${r.txn_date??""}</td><td>${r.description??""}</td><td class='right'>$${Number(r.amount||0).toFixed(2)}</td><td>${r.direction??""}</td><td>${matched}</td></tr>`;
      }).join("");
      tbody.innerHTML = rows;

      const total = data.reduce((a,r)=>a+(Number(r.amount)||0),0);
      qs("status").className="ok";
      qs("status").textContent=`Loaded ${data.length} transactions. Total $${total.toFixed(2)} (${currentFilter})`;
    }

    qs("btnAll").onclick = ()=>{ currentFilter="all"; loadTransactions(); };
    qs("btnMatched").onclick = ()=>{ currentFilter="matched"; loadTransactions(); };
    qs("btnUnmatched").onclick = ()=>{ currentFilter="unmatched"; loadTransactions(); };
    qs("dateRange").onchange = loadTransactions;

    qs("exportBtn").onclick = async ()=>{
      qs("status").textContent="Building export…";
      const { data, error } = await sb.from("v_accountant_export_receipts").select("*");
      if(error){ qs("status").textContent="Export failed: "+error.message; qs("status").className="err"; return; }
      const header = Object.keys(data[0]||{});
      const rows = [header.join(","), ...data.map(r=>header.map(h=>r[h]).join(","))];
      const blob = new Blob([rows.join("\n")],{type:"text/csv"});
      const a=document.createElement("a");a.href=URL.createObjectURL(blob);
      a.download=`accountant_export_${new Date().toISOString().slice(0,10)}.csv`;a.click();
      qs("status").className="ok";qs("status").textContent="CSV downloaded.";
    };

    loadTransactions();
  </script>
</body>
</html>
