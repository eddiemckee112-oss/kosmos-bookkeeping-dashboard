<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kosmos Transactions</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <h1>Kosmos Bookkeeping</h1>
    <nav>
      <a href="index.html">Dashboard</a>
      <a href="receipts.html">Receipts</a>
      <a href="transactions.html" class="active">Transactions</a>
      <a href="reports.html">Reports</a>
    </nav>
  </header>

  <main class="container">
    <h2>Transactions Overview</h2>
    <div class="filters">
      <label>Date range:</label>
      <input type="date" id="fromDate" /> – 
      <input type="date" id="toDate" />
      <select id="filterMode">
        <option value="all">All Transactions</option>
        <option value="matched">Matched Only</option>
        <option value="unmatched">Unmatched Only</option>
      </select>
      <button id="filterBtn">Apply</button>
      <button id="exportBtn">Export Accountant CSV</button>
    </div>

    <div class="syncbox">
      <h3>Bank Sync (Mock Flinks)</h3>
      <small>Imports sample transactions via your Edge Function <code>bank-sync</code></small>
      <div class="row">
        <label>Account name:</label>
        <input id="bankAccount" placeholder="CIBC Chequing 1234" />
        <label>Days back:</label>
        <input id="bankDays" type="number" value="14" min="1" max="90" />
        <button id="bankImportBtn">Import Latest</button>
      </div>
      <p id="bankMsg" class="muted"></p>
    </div>

    <div class="summary">
      <p><strong>Total transactions:</strong> <span id="txnCount">—</span></p>
      <p><strong>Debits total:</strong> <span id="debits">—</span></p>
      <p><strong>Credits total:</strong> <span id="credits">—</span></p>
      <p><strong>Net:</strong> <span id="net">—</span></p>
    </div>

    <table id="txnTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Description</th>
          <th class="right">Amount</th>
          <th>Type</th>
          <th>Source</th>
          <th>Institution</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>

  <script>
    const SUPABASE_URL = "https://advihqhjjlxumgdlbwui.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkdmlocWhqamx4dW1nZGxid3VpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMTg0MzIsImV4cCI6MjA3NjU5NDQzMn0.kVlaPQg2_o9DGJYv22Dgca7veok4drF6kgLPy2wPBeY";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const qs = (id) => document.getElementById(id);
    const tableBody = qs("txnTable").querySelector("tbody");

    async function loadTransactions() {
      const from = qs("fromDate").value || "1900-01-01";
      const to = qs("toDate").value || "2999-12-31";
      const mode = qs("filterMode").value;

      let query = sb.from("transactions").select("*").gte("txn_date", from).lte("txn_date", to).order("txn_date", { ascending: false });

      if (mode === "matched") query = query.in("id", (await sb.from("matches").select("transaction_id")).data?.map(x => x.transaction_id) || []);
      if (mode === "unmatched") query = query.not("id", "in", (await sb.from("matches").select("transaction_id")).data?.map(x => x.transaction_id) || []);

      const { data, error } = await query;
      if (error) {
        console.error(error);
        tableBody.innerHTML = `<tr><td colspan="6" class="err">${error.message}</td></tr>`;
        return;
      }
      renderTable(data);
    }

    function renderTable(data) {
      if (!data?.length) {
        tableBody.innerHTML = `<tr><td colspan="6" class="muted">No transactions found.</td></tr>`;
        return;
      }

      let debitSum = 0, creditSum = 0;
      const rows = data.map(t => {
        const amt = Number(t.amount) || 0;
        if (t.direction === "debit") debitSum += amt; else creditSum += amt;
        return `<tr>
          <td>${t.txn_date ?? ""}</td>
          <td>${t.description ?? ""}</td>
          <td class="right">$${amt.toFixed(2)}</td>
          <td>${t.direction ?? ""}</td>
          <td>${t.source_account_name ?? ""}</td>
          <td>${t.institution ?? ""}</td>
        </tr>`;
      }).join("");

      tableBody.innerHTML = rows;
      qs("txnCount").textContent = data.length;
      qs("debits").textContent = `$${debitSum.toFixed(2)}`;
      qs("credits").textContent = `$${creditSum.toFixed(2)}`;
      qs("net").textContent = `$${(creditSum - debitSum).toFixed(2)}`;
    }

    async function exportCSV() {
      const { data, error } = await sb.from("v_accountant_export_receipts").select("*");
      if (error || !data?.length) { alert("No export data."); return; }

      const header = Object.keys(data[0]);
      const rows = data.map(r => header.map(h => JSON.stringify(r[h] ?? "")).join(","));
      const csv = [header.join(","), ...rows].join("\n");

      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "accountant_export.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    async function importBank() {
      const account = qs("bankAccount").value || "CIBC Chequing";
      const days = Number(qs("bankDays").value || 14);
      qs("bankMsg").className = "muted";
      qs("bankMsg").textContent = "Importing from mock Flinks…";

      try {
        const res = await fetch(`${SUPABASE_URL}/functions/v1/bank-sync?route=import`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ days, account })
        });
        const json = await res.json();
        if (!json.ok) throw new Error(json.error || "Import failed.");
        qs("bankMsg").className = "ok";
        qs("bankMsg").textContent = `Imported ${json.inserted || 0} transactions.`;
        await loadTransactions();
      } catch (e) {
        qs("bankMsg").className = "err";
        qs("bankMsg").textContent = e.message;
      }
    }

    qs("filterBtn").addEventListener("click", loadTransactions);
    qs("exportBtn").addEventListener("click", exportCSV);
    qs("bankImportBtn").addEventListener("click", importBank);

    loadTransactions();
  </script>
</body>
</html>
