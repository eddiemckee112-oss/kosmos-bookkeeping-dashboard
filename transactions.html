<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Kosmos Bookkeeping ‚Äî Transactions</title>
  <link rel="stylesheet" href="style.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{padding:4px 10px;border:1px solid var(--border);border-radius:999px;background:#fff}
    .status-btn{font-size:.8rem;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#fff;cursor:pointer}
    .status-btn.ok{background:#eef8f1;border-color:#cfe9d7;color:var(--ok)}
    .upload-btn{font-size:.8rem;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#f9f9f9;cursor:pointer}
    .rule-btn{font-size:.75rem;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#fff;cursor:pointer}
    .rule-btn:hover{background:#f6f6f6}
    .right{text-align:right} .muted{color:var(--muted)} .ok{color:var(--ok)} .err{color:var(--err)} .small{font-size:.85rem}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.18);display:none;align-items:flex-start;justify-content:center;padding:40px 12px;z-index:50}
    .modal{background:#fff;width:min(1100px,100%);max-height:85vh;overflow:auto;border:1px solid var(--border);border-radius:16px;padding:16px 16px 18px}
    .hidden{display:none}
    .cat-select{min-width:150px}
    .save-mark{font-size:12px;margin-left:6px;opacity:.0;transition:opacity .2s}
    .save-mark.show{opacity:1}
    .bulkbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 0}
    .bulkbar .count{font-weight:700}
    .suggest{font-size:12px;margin-left:8px;padding:2px 8px;border:1px dashed var(--border);border-radius:999px;background:#fff}
  </style>
</head>
<body>
  <header>
    <h1>Kosmos Bookkeeping</h1>
    <nav>
      <a href="index.html">Dashboard</a>
      <a href="receipts.html">Receipts</a>
      <a class="active" href="transactions.html">Transactions</a>
      <a href="reports.html">Reports</a>
    </nav>
  </header>

  <main class="container">
    <h2>üí≥ Transactions</h2>
    <p class="muted">Filter, import, categorize (single or bulk), attach receipts, and track sources. Now with smart category suggestions + one-click rules.</p>

    <!-- Controls -->
    <div class="card" style="margin-bottom:14px;">
      <div class="toolbar">
        <label>Date Range:</label>
        <input id="fromDate" type="date"/><span>‚Äì</span><input id="toDate" type="date"/>
        <select id="typeFilter">
          <option value="all">All</option>
          <option value="debit">Debits only</option>
          <option value="credit">Credits only</option>
          <option value="matched">Matched only</option>
          <option value="unmatched">Unmatched only</option>
          <option value="uncategorized">Uncategorized</option>
          <option value="no_source">No Source</option>
          <option value="duplicates">Possible Duplicates</option>
        </select>
        <button id="applyBtn">Apply</button>
        <input id="quickSearch" placeholder="Search description/category/source‚Ä¶" style="flex:1;min-width:220px"/>
        <button id="importBtn" class="ghost">üì• Import CSV</button>
        <button id="exportBtn" class="ghost">‚¨áÔ∏è Export CSV</button>
      </div>

      <div class="row" style="gap:10px;margin-top:10px;">
        <span class="pill">Unmatched: <b id="chipUnmatched">‚Äî</b></span>
        <span class="pill">Uncategorized: <b id="chipUncat">‚Äî</b></span>
        <span class="pill">No Source: <b id="chipNoSource">‚Äî</b></span>
        <span class="pill">Duplicates: <b id="chipDupes">‚Äî</b></span>
      </div>
    </div>

    <!-- Totals -->
    <div class="card" style="margin-bottom:14px;">
      <div>Total Transactions: <b id="totalRows">‚Äî</b></div>
      <div>Debits: <b id="totalDebits">$0.00</b></div>
      <div>Credits: <b id="totalCredits">$0.00</b></div>
      <div>Net: <b id="totalNet">$0.00</b></div>
      <small class="muted">Numbers reflect the current filter.</small>
    </div>

    <!-- Bulk bar -->
    <div class="card">
      <div class="bulkbar">
        <span>Selected: <span class="count" id="selCount">0</span></span>
        <select id="bulkCategory" class="cat-select"></select>
        <button id="applyBulk" class="ghost">Apply category to selected</button>
        <button id="applySuggestions" class="ghost">Apply suggestions</button>
        <span id="bulkStatus" class="small muted"></span>
      </div>

      <!-- Table -->
      <table id="txTable">
        <thead>
          <tr>
            <th><input type="checkbox" id="checkAll"/></th>
            <th>Date</th>
            <th>Description</th>
            <th class="right">Amount</th>
            <th>Type</th>
            <th>Category</th>
            <th>Source</th>
            <th>Status</th>
            <th>Receipt</th>
          </tr>
        </thead>
        <tbody id="txBody"></tbody>
      </table>
      <div class="muted" id="rowsCount" style="margin-top:8px">Rows: 0</div>
    </div>
  </main>

  <!-- Import Modal -->
  <div id="impBackdrop" class="modal-backdrop">
    <div class="modal">
      <h3>Import Transactions (CSV)</h3>
      <p class="note muted small">
        Mapping is <b>A=Date</b>, <b>B=Description</b>, <b>C=Debit</b>, <b>D=Credit</b>. Handles $ signs, commas, and (parentheses) negatives.
      </p>

      <div class="card" style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
        <input id="csvFile" type="file" accept=".csv,text/csv"/>
        <button id="closeImport" class="ghost">Close</button>
      </div>

      <!-- Choose source for this file -->
      <div class="row" style="gap:10px;align-items:center;margin-top:10px">
        <label for="fileSourceSelect"><b>Source for this file:</b></label>
        <select id="fileSourceSelect"></select>
        <input id="fileSourceCustom" class="hidden" placeholder="Type custom source‚Ä¶"/>
      </div>

      <p id="impStatus" class="muted small" style="margin-top:10px;">Select a CSV to begin.</p>
      <div class="kpill small" id="countPill" style="display:inline-block;margin-top:6px;">Parsed ‚Äî ¬∑ Valid ‚Äî ¬∑ Skipped ‚Äî ¬∑ Debits ‚Äî ¬∑ Credits ‚Äî</div>

      <div id="impPreview" class="card" style="margin-top:12px;display:none;">
        <h4 style="margin:0 0 8px 0">Preview (first 20 rows)</h4>
        <table style="width:100%;border-collapse:collapse;">
          <thead><tr><th>Date</th><th>Description</th><th class="right">Amount</th><th>Direction</th><th>Source</th></tr></thead>
          <tbody id="prevBody"><tr><td colspan="5" class="muted">No rows yet</td></tr></tbody>
        </table>
      </div>

      <div class="row" style="justify-content:flex-end;margin-top:12px">
        <button id="importGo" class="ghost">Import</button>
      </div>
    </div>
  </div>

  <!-- Upload Receipt Modal -->
  <div id="uploadBackdrop" class="modal-backdrop">
    <div class="modal">
      <h3>Attach Receipt</h3>
      <p id="upDesc" class="muted small"></p>
      <input id="uploadFile" type="file" accept="image/*" capture="environment"/>
      <div class="row" style="justify-content:flex-end;margin-top:12px">
        <button id="cancelUpload" class="ghost">Cancel</button>
        <button id="confirmUpload">Upload</button>
      </div>
      <p id="uploadStatus" class="small muted" style="margin-top:10px;"></p>
    </div>
  </div>

  <script>
    // Supabase client
    const sb = supabase.createClient(
      "https://advihqhjjlxumgdlbwui.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkdmlocWhqamx4dW1nZGxid3VpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMTg0MzIsImV4PCI6MjA3NjU5NDQzMn0.kVlaPQg2_o9DGJYv22Dgca7veok4drF6kgLPy2wPBeY"
    );

    const $ = id => document.getElementById(id);
    const esc = s => String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    const money = n => (n==null?0:n).toLocaleString(undefined,{style:"currency",currency:"CAD"});

    // ---------- Category options ----------
    let CATEGORY_OPTIONS = [];
    async function loadCategoryOptions(){
      const defaults = [
        "Uncategorized","Income","Sales","Refunds",
        "Meals & Entertainment","Supplies","Software","Subscriptions",
        "Travel","Lodging","Fuel","Utilities","Phone/Internet",
        "Office","Professional Fees","Bank Fees","Taxes","Insurance","Repairs","Other"
      ];
      const set = new Set(defaults);

      const { data: txCats } = await sb.from("transactions").select("category").not("category","is","null");
      (txCats||[]).forEach(r=>{ if(r.category && String(r.category).trim()) set.add(String(r.category).trim()); });

      const { data: rcCats } = await sb.from("receipts").select("category").not("category","is","null");
      (rcCats||[]).forEach(r=>{ if(r.category && String(r.category).trim()) set.add(String(r.category).trim()); });

      CATEGORY_OPTIONS = Array.from(set).sort((a,b)=>a.localeCompare(b));

      // populate bulk dropdown
      $("bulkCategory").innerHTML = CATEGORY_OPTIONS.map(c=>`<option value="${esc(c)}">${esc(c)}</option>`).join("");
      $("bulkCategory").value = "Uncategorized";
    }

    function renderCategorySelect(value, txnId, desc, suggested){
      const opts = CATEGORY_OPTIONS.map(c => `<option value="${esc(c)}"${c===value?' selected':''}>${esc(c)}</option>`).join("");
      const hint = suggested && suggested !== value ? `<span class="suggest">suggested: ${esc(suggested)}</span>` : "";
      return `<div style="display:flex;align-items:center;gap:6px;">
        <select class="cat-select" data-txn="${txnId}" data-desc="${esc(desc)}" onchange="updateCategory(this)">
          ${opts}
        </select>
        ${hint}
        <button class="rule-btn" onclick="makeRule('${txnId}')">Make rule</button>
        <span class="save-mark" id="sv_${txnId}">‚úì saved</span>
      </div>`;
    }

    // ---------- Vendor rules (suggestions) ----------
    let RULES = [];              // [{id, vendor_pattern, category, source, tax}]
    let SUGGESTIONS = new Map(); // txnId -> suggestedCategory

    function norm(s){ return (s||"").toUpperCase(); }
    function extractPattern(desc){
      // Keep letters, numbers, spaces; condense spaces; take first 3 tokens
      const cleaned = norm(desc).replace(/[^A-Z0-9 ]+/g," ").replace(/\s+/g," ").trim();
      const tokens = cleaned.split(" ").filter(Boolean);
      return tokens.slice(0,3).join(" ");
    }
    function findRuleForDesc(desc){
      const nd = norm(desc);
      for(const r of RULES){
        const pat = norm(r.vendor_pattern||"").trim();
        if(!pat) continue;
        if(nd.includes(pat)) return r;
      }
      return null;
    }

    async function loadRules(){
      const { data, error } = await sb.from("vendor_rules").select("id,vendor_pattern,category,source,tax").order("created_at",{ascending:false});
      if(!error) RULES = data || [];
    }

    async function makeRule(txnId){
      // Take current row's desc + selected category to create/update a rule
      const row = CURRENT_ROWS.find(r=> r.id===txnId);
      if(!row){ alert("Row not found."); return; }
      const desc = row.description || "";
      // read currently selected category from DOM
      const sel = document.querySelector(`select.cat-select[data-txn="${txnId}"]`);
      const category = sel ? sel.value : (row.category || "Uncategorized");
      const pattern = extractPattern(desc);
      if(!pattern){ alert("Could not extract a vendor pattern from description."); return; }

      // If there is an existing rule with very similar pattern (substring both ways), update it
      const existing = RULES.find(r => norm(r.vendor_pattern).includes(pattern) || pattern.includes(norm(r.vendor_pattern)));
      try{
        if(existing){
          const { error } = await sb.from("vendor_rules").update({ category }).eq("id", existing.id);
          if(error) throw error;
        }else{
          const { error } = await sb.from("vendor_rules").insert({
            vendor_pattern: pattern,
            category,
            source: null,
            tax: null
          });
          if(error) throw error;
        }
        await loadRules();
        alert(`Rule saved: "${pattern}" ‚Üí ${category}`);
      }catch(e){
        alert("Rule error: " + (e.message||e));
      }
    }
    window.makeRule = makeRule;

    async function applySuggestions(){
      const updates = [];
      SUGGESTIONS.forEach((cat, id)=>{
        // Only update if current category is empty/Uncategorized
        const row = CURRENT_ROWS.find(r=>r.id===id);
        if(!row) return;
        if(!row.category || row.category==="Uncategorized"){
          updates.push({ id, category: cat });
        }
      });
      if(!updates.length){ $("bulkStatus").textContent = "No suggestions to apply."; setTimeout(()=>$("bulkStatus").textContent="",1200); return; }
      $("bulkStatus").textContent = `Applying ${updates.length} suggestion(s)‚Ä¶`;
      try{
        for(let i=0;i<updates.length;i+=300){
          const chunk = updates.slice(i,i+300);
          const ids = chunk.map(u=>u.id);
          const cat = chunk[0].category; // chunk may contain different cats; do one-by-one to be safe
          // do one by one for correctness
          for(const u of chunk){
            const { error } = await sb.from("transactions").update({ category: u.category }).eq("id", u.id);
            if(error) throw error;
          }
        }
        $("bulkStatus").textContent = "‚úì Suggestions applied";
        await loadTransactions();
      }catch(e){
        $("bulkStatus").textContent = "Error: " + (e.message||e);
      }finally{
        setTimeout(()=> $("bulkStatus").textContent="", 1500);
      }
    }

    // ---------- Load + render ----------
    let CURRENT_ROWS = [];
    async function loadTransactions(){
      await loadCategoryOptions();
      await loadRules();
      SUGGESTIONS = new Map();

      const from = $("fromDate").value || null;
      const to   = $("toDate").value || null;
      const q    = $("quickSearch").value.trim().toLowerCase();
      const type = $("typeFilter").value;

      let query = sb.from("transactions").select(`
        id, txn_date, description, amount, direction, category, source_account_name,
        matches:matches(id, transaction_id, receipt_id)
      `);

      if (from) query = query.gte("txn_date", from);
      if (to)   query = query.lte("txn_date", to);
      if (type === "debit")  query = query.eq("direction","debit");
      if (type === "credit") query = query.eq("direction","credit");

      query = query.order("txn_date",{ascending:false});

      const { data, error } = await query;
      if (error){ alert(error.message); return; }

      let rows = data || [];
      if (type === "matched")   rows = rows.filter(r => r.matches && r.matches.length);
      if (type === "unmatched") rows = rows.filter(r => !r.matches || r.matches.length===0);
      if (type === "uncategorized") rows = rows.filter(r => !r.category || r.category==="Uncategorized");
      if (type === "no_source")     rows = rows.filter(r => !r.source_account_name);
      if (type === "duplicates")    rows = findDuplicates(rows);

